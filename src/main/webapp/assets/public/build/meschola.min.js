/*! meschola 2016-03-14 */
angular.module("smiled.application",["ui.router","ngCookies","ui.bootstrap","ngStorage","ngResource","permission","restangular","ngFileUpload","ui.date","ngDialog","ang-drag-drop","infinite-scroll","ngTagsInput","bootstrapLightbox","ngSanitize","fox.scrollReveal","ui.slider","FBAngular","angular-p5"]),angular.module("smiled.application").config(["$stateProvider","$urlRouterProvider","$locationProvider","RestangularProvider","$httpProvider",function(a,b,c,d,e){a.state("notLogged",{templateUrl:"assets/public/partials/template-notLogged.html","abstract":!0,data:{permissions:{only:["anonymous"],redirectTo:"logged.dashboard"}}}).state("notLogged.setFirstPassword",{url:"/setPassword",views:{content:{templateUrl:"assets/public/partials/setPassword.html",controller:"setPasswordCtrl",controllerAs:"setPassword"}},data:{pageTitle:"setPassword - Meschola"}}).state("notLogged.login",{url:"/",views:{header:{templateUrl:"assets/public/partials/navbar-login.html",controller:"loginCtrl",controllerAs:"login"},content:{templateUrl:"assets/public/partials/registerPartial.html",controller:"registerCtrl",controllerAs:"register"}},data:{pageTitle:"Login - Meschola"}}).state("notLogged.forgotPassword",{url:"/password-dimenticata",views:{header:{templateUrl:"assets/public/partials/navbar-login.html",controller:"loginCtrl",controllerAs:"login"},content:{templateUrl:"assets/public/partials/forgotPartial.html",controller:"forgotCtrl",controllerAs:"forgot"}},data:{pageTitle:"Recupera password - Meschola"}}).state("notLogged.policy",{url:"/cookie-policy",views:{header:{templateUrl:"assets/public/partials/navbar-login.html",controller:"loginCtrl",controllerAs:"login"},content:{templateUrl:"assets/public/partials/cookie-policy.html"}},data:{pageTitle:"Cookie policy - Meschola"}}).state("logged",{templateUrl:"assets/private/partials/template-logged.html",controller:"mainCtrl","abstract":!0,data:{permissions:{except:["anonymous"],redirectTo:"notLogged.login"}}}).state("logged.issues",{url:"/anomalie",views:{"content@logged":{templateUrl:"assets/private/partials/issues.html",controller:"issuesCtrl",controllerAs:"issues"}},data:{pageTitle:"Segnala un problema - Meschola"}}).state("logged.newFeature",{url:"/suggerimenti",views:{"content@logged":{templateUrl:"assets/private/partials/suggestions.html",controller:"issuesCtrl",controllerAs:"issues"}},data:{pageTitle:"Segnala un problema - Meschola"}}).state("logged.lastNews",{url:"/novita",views:{"content@logged":{templateUrl:"assets/private/partials/lastNews.html"}},data:{pageTitle:"Novita' - Meschola"}}).state("logged.toolMap",{url:"/tool-mappe",views:{"content@logged":{templateUrl:"assets/private/partials/toolMap.html",controller:"toolMapCtrl",controllerAs:"toolMap"}},data:{pageTitle:"Download tool generazione mappe - Meschola"}}).state("logged.dashboard",{url:"/dashboard",views:{content:{controller:"loggedCtrl",controllerAs:"logged"}},resolve:{loggedUser:function(a){return a.getMe()}},data:{pageTitle:"Meschola"}}).state("logged.dashboard.teacher",{views:{"content@logged":{templateUrl:"assets/private/partials/dashboardTeacher.html",controller:"dashboardCtrl",controllerAs:"dashboard"}}}).state("logged.dashboard.student",{views:{"content@logged":{templateUrl:"assets/private/partials/dashboardStudent.html",controller:"dashboardCtrl",controllerAs:"dashboard"}}}).state("logged.dashboard.admin",{url:"/admin",views:{"content@logged":{templateUrl:"assets/private/partials/dashboardAdmin.html",controller:"dashboardAdminCtrl",controllerAs:"dashboardAdmin"}},data:{permissions:{only:["admin"],redirectTo:"logged.dashboard"},pageTitle:"Amministrazione - Meschola"}}).state("logged.dashboard.admin.scenarios",{url:"/scenari",templateUrl:"assets/private/partials/admin-scenarios.html"}).state("logged.dashboard.admin.users",{url:"/utenti",templateUrl:"assets/private/partials/admin-users.html"}).state("logged.dashboard.admin.log",{url:"/log",templateUrl:"assets/private/partials/admin-logs.html"}).state("logged.dashboard.admin.issueSegnalations",{url:"/anomalieAdmin",templateUrl:"assets/private/partials/admin-issues.html"}).state("logged.dashboard.admin.suggestionSegnalations",{url:"/suggerimentiAdmin",templateUrl:"assets/private/partials/admin-segnalations.html"}).state("logged.dashboard.admin.registrationRequest",{url:"/richiesteRegistrazione",templateUrl:"assets/private/partials/admin-registrationRequests.html"}).state("logged.dashboard.admin.exceptionsOnClient",{url:"/eccezioni",templateUrl:"assets/private/partials/admin-eccezioni.html"}).state("logged.dashboard.scenariosList",{url:"scenari",views:{"content@logged":{templateUrl:"assets/private/partials/scenariosList.html",controller:"scenariosListCtrl",controllerAs:"scenariosList"}},data:{pageTitle:"I miei scenari - Meschola"}}).state("logged.dashboard.studentsList",{url:"/studenti",views:{"content@logged":{templateUrl:"assets/private/partials/studentsList.html",controller:"studentsListCtrl",controllerAs:"studentsList"}},data:{pageTitle:"I miei studenti - Meschola"}}).state("logged.dashboard.colleaguesList",{url:"/colleghi",views:{"content@logged":{templateUrl:"assets/private/partials/colleaguesList.html",controller:"colleaguesListCtrl",controllerAs:"colleaguesList"}},data:{pageTitle:"I miei colleghi - Meschola"}}).state("logged.dashboard.missionsList",{url:"/missioni",views:{"content@logged":{templateUrl:"assets/private/partials/personalMissionsList.html",controller:"personalMissionCtrl",controllerAs:"personalMission"}},data:{pageTitle:"I miei compiti - Meschola"},params:{missions:null}}).state("logged.dashboard.filesList",{url:"/materiale",views:{"content@logged":{templateUrl:"assets/private/partials/filesList.html",controller:"filesListCtrl",controllerAs:"filesList"}},data:{pageTitle:"Il mio materiale - Meschola"}}).state("logged.dashboard.draft",{url:"/bozze",views:{"content@logged":{templateUrl:"assets/private/partials/draftsList.html",controller:"draftsListCtrl",controllerAs:"draftsList"}},data:{pageTitle:"Le mie bozze - Meschola"},resolve:{drafts:function(a){return a.getMyDraft(!1)}}}).state("logged.dashboard.draft.edit",{url:"/{postId}",views:{"body@logged.dashboard.draft":{templateUrl:"assets/private/partials/edit-draft.html",controller:"editDraftCtrl",controllerAs:"editDraft"}},params:{postId:null}}).state("logged.userProfile",{url:"/utente/{id}",params:{id:null},views:{content:{templateUrl:"assets/private/partials/personalProfile.html",controller:"personalProfileCtrl",controllerAs:"personalProfile"}},data:{pageTitle:"Profilo - Meschola"}}).state("logged.myNotifications",{url:"/notifiche",views:{content:{templateUrl:"assets/private/partials/myNotifications.html",controller:"notificationCtrl",controllerAs:"notification"}},data:{pageTitle:"Notifiche - Meschola"}}).state("logged.scenario",{url:"/scenario/{id}","abstract":!0,params:{id:null},views:{content:{templateUrl:"assets/private/partials/template-scenario.html",controller:"scenarioCtrl",controllerAs:"scenario"}},resolve:{scenario:function(a,b){var c=b.id;return a.getScenario(c)},loggedUser:function(a){return a.getMe()}}}).state("logged.scenario.posts",{url:"/post",views:{body:{templateUrl:"assets/private/partials/posts-scenario.html",controller:"scenarioPostCtrl",controllerAs:"scenarioPost"}},data:{pageTitle:"Meschola"}}).state("logged.scenario.post",{url:"/post/{idPost}",params:{idPost:null},views:{body:{templateUrl:"assets/private/partials/single-post-scenario.html",controller:"singlePostCtrl",controllerAs:"singlePost"}},data:{pageTitle:"Meschola"}}).state("logged.scenario.storyline",{url:"/storyline",views:{body:{templateUrl:"assets/private/partials/storyline-scenario.html",controller:"scenarioStorylineCtrl",controllerAs:"scenarioStoryline"}},data:{pageTitle:"Storyline - Meschola"}}).state("logged.scenario.characters",{url:"/personaggi",views:{body:{templateUrl:"assets/private/partials/characters-scenario.html",controller:"scenarioCharactersCtrl",controllerAs:"scenarioCharacters"}},data:{pageTitle:"I personaggi - Meschola"}}).state("logged.scenario.map",{url:"/mappa",views:{body:{templateUrl:"assets/private/partials/map-scenario.html",controller:"scenarioMapCtrl",controllerAs:"scenarioMap"}},data:{pageTitle:"La mappa - Meschola"}}).state("logged.scenario.missions",{url:"/compiti",views:{body:{templateUrl:"assets/private/partials/missions.html",controller:"scenarioMissionsCtrl",controllerAs:"scenarioMissions"}},data:{pageTitle:"Compiti - Meschola"}}).state("logged.scenario.resources",{url:"/materiali",views:{body:{templateUrl:"assets/private/partials/resources-scenario.html",controller:"scenarioResourcesCtrl",controllerAs:"scenarioResources"}},data:{pageTitle:"Materiali - Meschola"}}).state("logged.scenario.socialGraph",{url:"/relazioni",views:{body:{templateUrl:"assets/private/partials/social-graph.html"}},data:{pageTitle:"Grafo delle relazioni - Meschola"}}).state("logged.scenario.charprofile",{url:"/personaggi/{idCharacter}",views:{body:{templateUrl:"assets/private/partials/character-scenario-profile.html",controller:"characterProfileCtrl",controllerAs:"characterProfile"}},params:{idCharacter:null},data:{pageTitle:"Profilo - Meschola"}}).state("logged.scenarioWizard",{"abstract":!0,url:"/scenarioWizard",params:{id:null},views:{content:{templateUrl:"assets/private/partials/template-scenario-wizard.html",controller:"scenarioWizardCtrl",controllerAs:"scenarioWizard"}},data:{pageTitle:"Gestisci scenario - Meschola",permissions:{only:["teacher","admin"],redirectTo:"logged.dashboard"}}}).state("logged.scenarioWizard.info",{url:"/{id}/info",templateUrl:"assets/private/partials/info-scenario-wizard.html"}).state("logged.scenarioWizard.attendees",{url:"/{id}/attendees",templateUrl:"assets/private/partials/attendees-scenario-wizard.html"}).state("logged.scenarioWizard.characters",{url:"/{id}/characters",templateUrl:"assets/private/partials/characters-scenario-wizard.html"}).state("logged.scenarioWizard.associations",{url:"/{id}/associations",templateUrl:"assets/private/partials/associations-scenario-wizard.html"}).state("logged.scenarioWizard.collaborators",{url:"/{id}/collaborators",templateUrl:"assets/private/partials/collaborators-scenario-wizard.html"}).state("notLogged.registrationConfirm",{url:"/registrationConfirm.html",views:{header:{templateUrl:"assets/public/partials/navbar-login.html",controller:"loginCtrl",controllerAs:"login"},content:{templateUrl:"assets/public/partials/registerPartial.html",controller:"registerCtrl",controllerAs:"register"}},data:{pageTitle:"Meschola - Conferma registrazione"}}).state("notLogged.notFound",{url:"/404",views:{header:{templateUrl:"assets/public/partials/navbar-login.html",controller:"loginCtrl",controllerAs:"login"},content:{templateUrl:"assets/public/partials/404.html"}},data:{pageTitle:"404 - Meschola"}}),b.otherwise(function(a,b){var c=a.get("$state");c.go("notLogged.notFound")}),e.interceptors.push("unauthorizedInterceptor"),c.html5Mode(!0),e.useApplyAsync(!0),d.setBaseUrl("/api/v1"),d.setDefaultHeaders({"Content-Type":"application/json"})}]).run(["Permission","userService","$q","$rootScope","$stateParams","$state",function(a,b,c,d,e,f){d.$state=f,d.$stateParams=e,a.defineRole("anonymous",function(a){var d=c.defer();return b.getMe().then(function(a){d.reject()},function(a){d.resolve()}),d.promise}),a.defineRole("user",function(a){var d=c.defer();return b.getMeForPermission().then(function(a){"ROLE_USER"==a.role.authority?d.resolve():d.reject()},function(a){d.reject()}),d.promise}),a.defineRole("teacher",function(a){var d=c.defer();return b.getMeForPermission().then(function(a){"ROLE_TEACHER"==a.role.authority?d.resolve():d.reject()},function(a){d.reject()}),d.promise}),a.defineRole("admin",function(a){var d=c.defer();return b.getMeForPermission().then(function(a){"ROLE_ADMIN"==a.role.authority?d.resolve():d.reject()},function(a){d.reject()}),d.promise})}]),angular.module("smiled.application").controller("characterProfileCtrl",["CONSTANTS","$scope","$stateParams","apiService","Upload",function(a,b,c,d,e){var f=this;f.character={};var g=c.idCharacter;f.idChar=g;var h=b.scenario.scen.id;f.scen=b.scenario.scen,f.editProfile=!1,f.actualUserCover=null,f.newCharacter={},f.genderBool=!0,f.numberOfPastUsers,f.viewPastUsers=!1,f.viewBiography=!1,f.currentChar=b.scenario.currentCharacter.id,Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},f.openViewPastUsers=function(){f.viewPastUsers=!0},f.closeViewPastUsers=function(){f.viewPastUsers=!1},f.openViewBiography=function(){f.viewBiography=!0},f.closeViewBiography=function(){f.viewBiography=!1},d.getCharacter(h,g).then(function(b){f.character=b,f.newCharacter=angular.copy(b),null!=f.character.actualUser&&null!=f.character.actualUser.id&&(f.actualUserCover=a.urlUserCover(f.character.actualUser.id)),"F"==f.character.gender?f.genderBool=!1:"M"==f.character.gender,f.numberOfPastUsers=Object.size(f.character.pastUserId)},function(a){console.log("ERROR RETRIEVE CHARACTER: "),console.log(a)}),f.cover=a.urlCharacterCover(h,g),f.toggleEditProfile=function(){f.editProfile=!f.editProfile},f.getBornMonth=function(){return null!=f.character.bornDate?a.monthString(f.character.bornDate.month):""},f.getDeadMonth=function(){return null!=f.character.deadDate?a.monthString(f.character.deadDate.month):""},f.deleteUpdateChar=function(){f.newCharacter=angular.copy(f.character)},f.updateChar=function(){0==f.genderBool?f.newCharacter.gender="F":f.newCharacter.gender="M";var a=i();if(!a){var b=f.newCharacter;d.updateCharacter(h,b,g).then(function(a){f.character=a,f.newCharacter=angular.copy(a),"F"==f.character.gender?f.genderBool=!1:f.genderBool=!0},function(a){f.newCharacter=angular.copy(f.character),"F"==f.character.gender?f.genderBool=!1:f.genderBool=!0})}},f.uploadCharacterCover=function(c){c&&c.length&&e.upload({url:a.urlCharacterCover(h,g),headers:{"Content-Type":c.type},file:c}).success(function(c,d,e,i){var j=new Date;f.cover=a.urlCharacterCover(h,g)+"?"+j.toString(),b.scenario.currentCharacter.cover=f.cover;for(var k=0;k<f.posts.length;k++)f.posts[k].character.cover=a.urlCharacterCover(h,g)+"?"+j.toString()})},f.showDeadDatePicker=!1,f.switchShowDeadDate=function(){!f.showDeadDatePicker&&f.showBornDatePicker&&(f.showBornDatePicker=!1),f.showDeadDatePicker=!f.showDeadDatePicker},f.showBornDatePicker=!1,f.switchShowBornDate=function(){!f.showBornDatePicker&&f.showDeadDatePicker&&(f.showDeadDatePicker=!1),f.showBornDatePicker=!f.showBornDatePicker},f.hideDatePicker=function(){f.showDeadDatePicker=!1,f.showBornDatePicker=!1};var i=function(){if(f.character.nickname!=f.newCharacter.nickname)return!1;if(f.character.quote!=f.newCharacter.quote)return!1;if(f.character.description!=f.newCharacter.description)return!1;if(f.character.gender!=f.newCharacter.gender)return!1;if(f.character.role!=f.newCharacter.role)return!1;if(1==f.genderBool&&"F"==f.character.gender)return!1;if(0==f.genderBool&&"M"==f.character.gender)return!1;if(0==f.character.gender&&0==f.genderBool)return!1;if(f.character.bornDate&&f.newCharacter.bornDate){if(f.character.bornDate.day!=f.newCharacter.bornDate.day)return!1;if(f.character.bornDate.month!=f.newCharacter.bornDate.month)return!1;if(f.character.bornDate.year!=f.newCharacter.bornDate.year)return!1;if(f.character.bornDate.afterChrist!=f.newCharacter.bornDate.afterChrist)return!1}else if(f.character.bornDate||f.newCharacter.bornDate)return!1;if(f.character.deadDate&&f.newCharacter.deadDate){if(f.character.deadDate.day!=f.newCharacter.deadDate.day)return!1;if(f.character.deadDate.month!=f.newCharacter.deadDate.month)return!1;if(f.character.deadDate.year!=f.newCharacter.deadDate.year)return!1;if(f.character.deadDate.afterChrist!=f.newCharacter.deadDate.afterChrist)return!1}else if(f.character.deadDate||f.newCharacter.deadDate)return!1;return f.character.bornTown!=f.newCharacter.bornTown?!1:f.character.deadTown==f.newCharacter.deadTown},j=function(b,c){console.log("GET POST"),d.getLastCharacterPosts(f.scen.id,g,k,b,c).then(function(b){console.log(b);var c=[];c=b,0==b.length&&(l=!0);for(var d=0;c&&d<c.length;d++){if(c[d].character){c[d].character.cover=a.urlCharacterCover(f.scen.id,c[d].character.id);for(var e=0;e<c[d].likes.length;e++)if(c[d].likes[e].id==g){c[d].youLike=!0;break}}f.posts.push(angular.copy(c[d]))}f.busy=!1},function(a){console.log("errore"),f.busy=!1})};f.posts=[],f.busy=!1;var k=a.numberOfPostForScroll,l=!1;f.nextPost=function(){f.busy||l||(f.busy=!0,0==f.posts.length?j():j(f.posts[f.posts.length-1].julianDayNumber,f.posts[f.posts.length-1].timeNumber))}}]),angular.module("smiled.application").controller("colleaguesListCtrl",["loggedUser",function(a){var b=this;b.user=a}]),angular.module("smiled.application").controller("customDatePickerTemplateCtrl",["startDate","endDate","post","modalService",function(a,b,c,d){var e=this;e.startDate=a,e.endDate=b;var f=angular.copy(c.julianDayNumber),g=angular.copy(c.formattedDate);e.dateNumber=c.julianDayNumber,e.dateString=c.formattedDate,e.timeNumber=c.timeNumber,e.updateDate=function(){c.julianDayNumber=e.dateNumber,c.formattedDate=e.dateString,c.timeNumber=e.timeNumber,d.closeModalSetHistoryDate()},e.cancel=function(){e.dateNumber=f,e.dateString=g,d.closeModalSetHistoryDate()}}]),angular.module("smiled.application").controller("dashboardAdminCtrl",["loggedUser","modalService","apiService","CONSTANTS","$location","userService","alertingGeneric","$anchorScroll","$q",function(a,b,c,d,e,f,g,h,i){var j=this,k=!0;j.typeOrder="creationDate",j.user=a;var l=20,m=0,n=20;j.showClose=!0,j.dateFormat=d.realDateFormatWithSecond,j.dateFormatBornDate=d.realDateFormatWithoutHour,j.nItemStudents=l,j.nItemTeachers=l,j.nItemExceptions=l,j.nItemScenarios=l,j.nItemLogs=l,j.nItemRegistrationRequests=l,j.nItemIssues=l,j.nItemSuggestions=l,j.nPagStudents=m,j.nPagTeachers=m,j.nPagExceptions=m,j.nPagScenarios=m,j.nPagLogs=m,j.nPagRegistrationRequests=m,j.nPagIssues=m,j.nPagSuggestions=m,j.myListOfTeachers=[],j.myListOfStudents=[],j.myListOfExceptions=[],j.myListOfLogs=[],j.myListOfScenarios=[],j.myListOfUsers=[],j.myListOfRegistrationRequests=[],j.myListOfSuggestions=[],j.myListOfIssues=[],j.numExceptionsFounded=0,j.numLogsFounded=0,j.numTeachersFounded=0,j.numStudentsFounded=0,j.numScenariosFounded=0,j.numUsersFounded=0,j.numRegistrationRequestsFounded=0,j.numIssuesFounded=0,j.numSuggestionsFounded=0,j.showErrorSearchBy=!1,j.noMoreStudents="",j.noMoreTeachers="",j.noMoreScenarios="",j.noMoreUsers="",j.noMoreExceptions="",j.noMoreLogs="",j.noMoreRegistrationRequests="",j.noMoreSuggestions="",j.noMoreissues="";var o={},p={};j.whoIsUser=function(a){a.userId in o?(a.firstName=o[a.userId].firstName,a.lastName=o[a.userId].lastName,a.email=o[a.userId].email):f.getUser(a.userId).then(function(b){var c={};c.firstName=b.firstName,c.lastName=b.lastName,c.email=b.email,o[a.userId]=angular.copy(c),a.firstName=b.firstName,a.lastName=b.lastName,a.email=b.email},function(b){var c={};c.firstName="nome non disponibile",c.lastName="cognome non disponibile",c.email="email non disponibile",o[a.userId]=angular.copy(c),a.firstName="nome non disponibile",a.lastName="cognome non disponibile",a.email="email non disponibile"})},j.whoIsScenario=function(a){a.scenarioId in p?(a.nameScenario=p[a.scenarioId].nameScenario,a.creator=p[a.scenarioId].creator):c.getScenario(a.scenarioId).then(function(b){var c={};c.nameScenario=b.name,c.creator=b.teacherCreator.firstname+" "+b.teacherCreator.lastname,p[a.scenarioId]=angular.copy(c),a.nameScenario=b.name,a.creator=b.teacherCreator.firstname+" "+b.teacherCreator.lastname},function(b){var c={};c.nameScenario="nome non disponibile",c.creator="creatore non disponibile",p[a.scenarioId]=angular.copy(c),a.nameScenario="nome non disponibile",a.creator="creatore non disponibile"})},j.toggleShowClose=function(){j.showClose=!j.showClose},j.calculateCover=function(a){return d.urlScenarioCover(a)},j.changeScenariosToPrev=function(){j.nPagScenarios--,j.searchScenarios()},j.changeScenariosToNext=function(){j.nPagScenarios++,j.searchScenarios()},j.changeRegistrationRequestsToPrev=function(){j.nPagRegistrationRequests--,j.searchRegistrationRequests()},j.changeRegistrationRequestsToNext=function(){j.nPagRegistrationRequests++,j.searchRegistrationRequests()},j.changeIssuesToPrev=function(){j.nPagIssues--,j.searchIssues()},j.changeIssuesToNext=function(){j.nPagIssues++,j.searchIssues()},j.changeSuggestionsToPrev=function(){j.nPagSuggestions--,j.searchSuggestions()},j.changeSuggestionsToNext=function(){j.nPagSuggestions++,j.searchSuggestions()},j.switchTypeOrder=function(){j.searchScenarios()},j.searchScenarios=function(){j.nItemScenarios>n&&(j.nItemScenarios=n),k="creationDate"==j.typeOrder,c.getPagedScenarios(j.nPagScenarios,j.nItemScenarios,k).then(function(a){j.numScenariosFounded=a.totalElements,j.myListOfScenarios=a.content,0==j.myListOfScenarios.length?j.noMoreScenarios="Nessun utente trovato in questa pagina":j.noMoreScenarios=""},function(a){console.log("errore"),j.numScenariosFounded=0})},j.searchIssues=function(){j.nItemIssues>n&&(j.nItemIssues=n),c.getPagedIssues(j.nPagIssues,j.nItemIssues).then(function(a){j.numIssuesFounded=a.totalElements,j.myListOfIssues=a.content,0==j.myListOfIssues.length?j.noMoreIssues="Nessuna segnalazione di errore trovata in questa pagina":j.noMoreIssues=""},function(a){console.log("errore"),j.numIssuesFounded=0})},j.searchSuggestions=function(){j.nItemSuggestions>n&&(j.nItemSuggestions=n),c.getPagedSuggestions(j.nPagSuggestions,j.nItemSuggestions).then(function(a){j.numSuggestionsFounded=a.totalElements,j.myListOfSuggestions=a.content,0==j.myListOfSuggestions.length?j.noMoreSuggestions="Nessuna segnalazione di errore trovata in questa pagina":j.noMoreSuggestions=""},function(a){console.log("errore"),j.numSuggestionsFounded=0})},j.searchRegistrationRequests=function(){j.nItemRegistrationRequests>n&&(j.nItemRegistrationRequests=n),c.getPagedRegistrationRequests(j.nPagRegistrationRequests,j.nItemRegistrationRequests).then(function(a){j.numRegistrationRequestsFounded=a.totalElements,j.myListOfRegistrationRequests=a.content,0==j.myListOfRegistrationRequests.length?j.noMoreRegistrationRequests="Nessun utente trovato in questa pagina":j.noMoreRegistrationRequests=""},function(a){console.log("errore"),j.numRegistrationRequestsFounded=0})},j.changeTeachersToPrev=function(){j.nPagTeachers--,j.searchTeachers()},j.changeTeachersToNext=function(){j.nPagTeachers++,j.searchTeachers()},j.searchTeachers=function(){j.nItemTeachers>n&&(j.nItemTeachers=n),c.getPagedTeachers(j.nPagTeachers,j.nItemTeachers).then(function(a){j.numTeachersFounded=a.totalElements,j.myListOfTeachers=a.content,0==j.myListOfTeachers.length?j.noMoreTeachers="Nessun utente trovato in questa pagina":j.noMoreTeachers=""},function(a){console.log("errore"),j.numTeachersFounded=0})},j.searchUsersByFirstNameAndLastName=function(){null!=j.firstName&&""!=j.firstName||null!=j.lastName&&""!=j.lastName?(j.showErrorSearchBy=!1,c.getUsersByFirstNameAndLastName(j.firstName,j.lastName).then(function(a){a.length>0?(j.numUsersFounded=a.length,j.myListOfUsers=a,j.noMoreUsers=""):(j.numUsersFounded=0,j.myListOfUsers=[],j.noMoreUsers="Nessun utente trovato")},function(a){console.log("errore"),j.numUsersFounded=0,j.myListOfUsers=[],j.noMoreUsers="Nessun utente trovato"})):(j.showErrorSearchBy=!0,j.numUsersFounded=0,j.myListOfUsers=[])},j.changeStudentsToPrev=function(){j.nPagStudents--,j.searchStudents()},j.changeStudentsToNext=function(){j.nPagStudents++,j.searchStudents()},j.searchStudents=function(){j.nItemStudents>n&&(j.nItemStudents=n),c.getPagedStudents(j.nPagStudents,j.nItemStudents).then(function(a){j.numStudentsFounded=a.totalElements,j.myListOfStudents=a.content,0==j.myListOfStudents.length?j.noMoreStudents="Nessun utente trovato":j.noMoreStudents=""},function(a){console.log("errore"),j.numStudentsFounded=0})},j.changeExceptionsToPrev=function(){j.nPagExceptions--,j.searchExceptions()},j.changeExceptionsToNext=function(){j.nPagExceptions++,j.searchExceptions()},j.changeLogsToPrev=function(){j.nPagLogs--,j.searchLogs()},j.changeLogsToNext=function(){j.nPagLogs++,j.searchLogs()},j.searchExceptions=function(){j.nItemExceptions>n&&(j.nItemExceptions=n),c.getPagedExceptions(j.nPagExceptions,j.nItemExceptions).then(function(a){j.numExceptionsFounded=a.totalElements,j.myListOfExceptions=a.content,0==j.myListOfExceptions.length?j.noMoreExceptions="Nessuna eccezione trovata in questa pagina":j.noMoreExceptions=""},function(a){console.log("errore"),j.numExceptionsFounded=0})},j.searchLogs=function(){j.nItemLogs>n&&(j.nItemLogs=n),c.getPagedLogs(j.nPagLogs,j.nItemLogs).then(function(a){if(j.numLogsFounded=a.totalElements,j.myListOfLogs=a.content,0==j.myListOfLogs.length)j.noMoreLogs="Nessun log trovato in questa pagina";else{j.noMoreLogs="";for(var b=0;b<j.myListOfLogs.length;b++)j.whoIsUser(j.myListOfLogs[b]),j.whoIsScenario(j.myListOfLogs[b])}},function(a){console.log("errore"),j.numLogsFounded=0})},j.showResetExceptions=function(){return j.myListOfExceptions.length>0||j.nPagExceptions!=m||j.nItemExceptions!=l||""!=j.noMoreExceptions},j.showResetSuggestions=function(){return j.myListOfSuggestions.length>0||j.nPagSuggestions!=m||j.nItemSuggestions!=l||""!=j.noMoreSuggestions},j.showResetIssues=function(){return j.myListOfIssues.length>0||j.nPagIssues!=m||j.nItemIssues!=l||""!=j.noMoreIssues},j.showResetRegistrationRequests=function(){return j.myListOfRegistrationRequests.length>0||j.nPagRegistrationRequests!=m||j.nItemRegistrationRequests!=l||""!=j.noMoreRegistrationRequests},j.showResetLogs=function(){return j.myListOfLogs.length>0||j.nPagLogs!=m||j.nItemLogs!=l||""!=j.noMoreLogs},j.showResetScenarios=function(){return j.myListOfScenarios.length>0||j.nPagScenarios!=m||j.nItemScenarios!=l||""!=j.noMoreScenarios},j.showResetTeachers=function(){return j.myListOfTeachers.length>0||j.nPagTeachers!=m||j.nItemTeachers!=l||""!=j.noMoreTeachers},j.showResetUsersByName=function(){return!!(j.myListOfUsers.length>0||j.showErrorSearchBy||""!=j.noMoreUsers)},j.showResetStudents=function(){return j.myListOfStudents.length>0||j.nPagStudents!=m||j.nItemStudents!=l||""!=j.noMoreStudents},j.resetExceptions=function(){j.myListOfExceptions=[],j.nItemExceptions=l,j.nPagExceptions=0,j.noMoreExceptions="",j.numExceptionsFounded=0},j.resetIssues=function(){j.myListOfIssues=[],j.nItemIssues=l,j.nPagIssues=0,j.noMoreIssues="",j.numIssuesFounded=0},j.resetSuggestions=function(){j.myListOfSuggestions=[],j.nItemSuggestions=l,j.nPagSuggestions=0,j.noMoreSuggestions="",j.numSuggestionsFounded=0},j.resetRegistrationRequests=function(){j.myListOfRegistrationRequests=[],j.nItemRegistrationRequests=l,j.nPagRegistrationRequests=0,j.noMoreRegistrationRequests="",j.numRegistrationRequestsFounded=0},j.resetLogs=function(){j.myListOfLogs=[],j.nItemLogs=l,j.nPagLogs=0,j.noMoreLogs="",j.numLogsFounded=0},j.resetScenarios=function(){j.myListOfScenarios=[],j.nItemScenarios=l,j.nPagScenarios=0,j.noMoreScenarios="",j.numScenariosFounded=0},j.resetTeachers=function(){j.myListOfTeachers=[],j.nItemTeachers=l,j.nPagTeachers=0,j.noMoreTeachers="",j.numTeachersFounded=0},j.resetStudents=function(){j.myListOfStudents=[],j.nItemStudents=l,j.nPagStudents=0,j.noMoreStudents="",j.numStudentsFounded=0},j.resetUsersByName=function(){j.firstName="",j.lastName="",j.myListOfUsers=[],j.showErrorSearchBy=!1,j.numUsersFounded=0,j.noMoreUsers=""},j.showPopUpConfirmRegistration=function(a){b.showModalConfirmRegistration(a,!0).then(function(b){if(g.addSuccess("Registrazione confermata"),j.myListOfRegistrationRequests){for(var c=0;c<j.myListOfRegistrationRequests.length;c++)if(j.myListOfRegistrationRequests[c].id==a.id){j.myListOfRegistrationRequests.splice(c,1);break}j.numRegistrationRequestsFounded--,e.hash("comeHere"),h(),e.url(e.path())}},function(a){g.addWarning("Operazione annullata"),e.hash("comeHere"),h(),e.url(e.path())})},j.showPopUpDeleteRegistration=function(a){b.showModalConfirmRegistration(a,!1).then(function(b){if(g.addSuccess("Registrazione cancellata"),j.myListOfRegistrationRequests){for(var c=0;c<j.myListOfRegistrationRequests.length;c++)if(j.myListOfRegistrationRequests[c].id==a.id){j.myListOfRegistrationRequests.splice(c,1);break}j.numRegistrationRequestsFounded--,e.hash("comeHere"),h(),e.url(e.path())}},function(a){g.addWarning("Operazione annullata"),e.hash("comeHere"),h(),e.url(e.path())})},j.searchMoreInfo=function(a){f.getUserByEmail(a.email).then(function(b){a.firstName=b.firstName,a.lastName=b.lastName,a.registrationDate=b.registrationDate,a.agree=b.agree,a.profile={},a.profile=b.profile},function(a){console.log("Error in getUserByEmail !!!")}),a.moreInfo=!0}}]),angular.module("smiled.application").controller("dashboardCtrl",["loggedUser","modalService","userService","$scope","$interval","apiService","CONSTANTS",function(a,b,c,d,e,f,g){function h(a,b){return a.creationDate>b.creationDate?-1:a.creationDate<b.creationDate?1:0}var j=this,k=angular.copy(a);j.missionDateFormatDay=g.realDateFormatOnlyDay,j.missionDateFormatMonth=g.realDateFormatOnlyMonth,"ROLE_USER"==a.role.authority?(j.numScenariosToShow=5,f.getMyMissions().then(function(a){j.myMissions=a},function(a){console.log("Error retrieve missions"),console.log(a)})):j.numScenariosToShow=4,f.getMyDraft(!0).then(function(b){j.myDraft=b;for(var c=0;j.myDraft&&c<j.myDraft.length;c++){j.myDraft[c].character&&(j.myDraft[c].character.cover=g.urlCharacterCover(j.myDraft[c].scenarioId,j.myDraft[c].character.id));for(var d=0;a.openScenarios&&d<a.openScenarios.length;d++)j.myDraft[c].scenarioId==a.openScenarios[d].id&&(j.myDraft[c].scenarioName=a.openScenarios[d].name)}},function(a){}),j.user=a,j.scenariosToShow=new Array,j.studentsList=a.students,j.showCollCard=[!1,!1,!1,!1,!1,!1],j.selectedUserID=null,j.myCharacters=new Array,j.tab=new Array,j.showPopUpCreationScenario=function(){b.showModalCreateScen()};var l=function(a){for(var b,c,d=a.length;d;)c=Math.floor(Math.random()*d--),b=a[d],a[d]=a[c],a[c]=b;return a},m=function(){var a=new Array;if(null!=j.user.openScenarios&&null!=j.user.creatingScenarios){for(var b=0;b<j.user.openScenarios.length;b++)j.user.openScenarios[b].isOpen=!0;for(var b=0;b<j.user.creatingScenarios.length;b++)j.user.creatingScenarios[b].isOpen=!1;a=angular.copy(j.user.openScenarios).concat(angular.copy(j.user.creatingScenarios))}else if(null!=j.user.openScenarios&&null==j.user.creatingScenarios){j.myCharacters=[];for(var b=0;b<j.user.openScenarios.length;b++)if(j.user.openScenarios[b].isOpen=!0,j.user.openScenarios[b].myCharacterId){var c={};c.scenarioId=j.user.openScenarios[b].id,c.id=j.user.openScenarios[b].myCharacterId,c.name=j.user.openScenarios[b].myCharacterName,c.cover=g.urlCharacterCover(j.user.openScenarios[b].id,j.user.openScenarios[b].myCharacterId),j.myCharacters.push(c)}a=angular.copy(j.user.openScenarios)}else if(null==j.user.openScenarios&&null!=j.user.creatingScenarios){for(var b=0;b<j.user.creatingScenarios.length;b++)j.user.creatingScenarios[b].isOpen=!1;a=angular.copy(j.user.creatingScenarios)}a.sort(h),a.splice(j.numScenariosToShow,a.length-j.numScenariosToShow),j.scenariosToShow=a},n=function(){c.getMe().then(function(a){angular.equals(k,a)||(j.user=a,k=angular.copy(j.user),m(),a.students&&l(a.students),a.colleagues&&l(a.colleagues),j.myCharacters&&l(j.myCharacters))},function(a){console.log("errore")})};m(),j.openCollCard=function(a,b){for(j.selectedUserID=a,i=0;i<6;i++)i!=b&&(j.showCollCard[i]=!1),j.tab[i]=i+1;j.showCollCard[b]=!j.showCollCard[b],j.showCollCard[b]&&(j.tab[b]=0)};var o=d.$on("dashboard.reloadDashboard",function(){console.log("dashboard.reloadDashboard"),n()}),p=null,q=null;"ROLE_USER"==a.role.authority?(p=d.$on("dashboardStudent.reloadDashboard",function(){n()}),q=d.$on("dashboardStudent.reloadMission",function(){f.getMyMissions().then(function(a){j.myMissions=a},function(a){console.log("Error retrieve missions"),console.log(a)})})):"ROLE_TEACHER"==a.role.authority&&(p=d.$on("dashboardTeacher.reloadDashboard",function(){n()})),d.$on("$destroy",function(){o(),null!=p&&p(),null!=q&&q()})}]),angular.module("smiled.application").controller("deleteResourceCtrl",["file","modalService",function(a,b){
var c=this;c.file=a}]),angular.module("smiled.application").controller("dialogConfirmRegistrationCtrl",["modalService","userService","alertingGeneric","$scope","confirmRegistrationBool",function(a,b,c,d,e){var f=this;f.reg={},f.reg=a.getRegistrationToConfirm(),f.confirmReg=e,c.removeAllAlerts(),f.confirm=function(){f.confirmReg?b.confirmRegisterTeacher(f.reg.token,f.reg.email).then(function(b){a.closeModalConfirmRegistration()},function(a){console.log("problem in confirmation register teacher"),c.addDanger("Si è verificato un errore. Non è stato possibile confermare la registrazione!")}):b.deleteRegisterTeacher(f.reg.token,f.reg.email).then(function(b){a.closeModalConfirmRegistration()},function(a){console.log("problem in delete register teacher"),c.addDanger("Si è verificato un errore. Non è stato possibile annullare la registrazione!")})}}]),angular.module("smiled.application").controller("dialogMissionCtrl",["modalService","apiService","alertingGeneric","$scope",function(a,b,c,d){var e=this;e.mission={},e.createMission=function(c){null==c&&b.createMission(e.mission.scenId,e.mission).then(function(b){a.closeModalCreateMission()},function(a){console.log("error in creation of new mission")})}}]),angular.module("smiled.application").controller("dialogScenarioCtrl",["modalService","alertingGeneric","$state","CONSTANTS",function(a,b,c,d){var e=this;e.scenario={},e.scenToDelete=a.getScenToDelete(),e.attendeeToDelete=a.getAttendeeToDelete(),e.collaboratorToDelete=a.getCollaboratorToDelete(),e.characterToDelete=a.getCharacterToDelete(),e.scenario.startDate={},e.scenario.endDate={},e.scenario.showRelationsToAll=!0,e.scenario.startDate.afterChrist=!0,e.scenario.endDate.afterChrist=!0,e.startDate={},e.endDate={},e.createScenario=function(){if(""==e.scenario.title||null==e.scenario.title||null==e.scenario.startDate||null==e.scenario.endDate)b.addWarning("Inserire tutti i dati richiesti");else if(e.scenario.title.length<2)b.addWarning("Inserire un titolo di almeno 2 caratteri");else if(0==g(e.scenario.startDate.year))b.addWarning("Data di inizio errata");else if(0==g(e.scenario.endDate.year))b.addWarning("Data di fine errata");else if(0==f(e.scenario.startDate,e.scenario.endDate))b.addWarning("La data di fine non puo' precedere la data di inizio");else if(!e.scenario.startDate.afterChrist&&parseInt(e.scenario.startDate.year)>4712)b.addWarning("La minima data rappresentabile e': 1 gennaio 4712 AC");else{var d=a.createScenario(e.scenario);d.then(function(d){b.addSuccess("ScenarioCreato"),a.closeModalCreateScen(),c.go("logged.scenarioWizard.info",{id:d.id})},function(a){b.addWarning("Non e' stato possibile creare lo scenario, riprova!")})}},e.deleteScenario=function(){null!=e.scenToDelete&&""!=e.scenToDelete&&(a.deleteScenario(),a.closeModalDeleteScen(),c.go("logged.dashboard"))},e.startDate.months=d.getMonths("it"),e.startDate.days=d.getDays(e.scenario.startDate.month),e.endDate.months=d.getMonths("it"),e.endDate.days=d.getDays(e.scenario.endDate.month),e.getStartDays=function(){e.startDate.days=d.getDays(e.scenario.startDate.month)},e.getEndDays=function(){e.endDate.days=d.getDays(e.scenario.endDate.month)};var f=function(a,b){var c={},d={};return c.year=parseInt(a.year),d.year=parseInt(b.year),c.month=a.month,d.month=b.month,c.day=a.day,d.day=b.day,c.afterChrist=a.afterChrist,d.afterChrist=b.afterChrist,c.afterChrist&&d.afterChrist?c.year>d.year?!1:c.year<d.year?!0:c.month>d.month?!1:c.month<d.month?!0:c.day>d.day?!1:(c.day<d.day,!0):c.afterChrist||d.afterChrist?!(c.afterChrist||!d.afterChrist):c.year<d.year?!1:c.year>d.year?!0:c.month>d.month?!1:c.month<d.month?!0:c.day>d.day?!1:(c.day<d.day,!0)},g=function(a){return!isNaN(a)}}]),angular.module("smiled.application").controller("dialogSetDateCtrl",["modalService","alertingGeneric","$state","scen","start","CONSTANTS",function(a,b,c,d,e,f){var g=this;g.start=e,g.newDate={},1==e?g.newDate=d.history.startDate:g.newDate=d.history.endDate,g.closeModal=function(){a.closeModalSetDate()},g.months=f.getMonths("it"),g.days=f.getDays(g.newDate.month),g.getDays=function(){g.days=f.getDays(g.newDate.month)}}]),angular.module("smiled.application").controller("draftsListCtrl",["loggedUser","drafts","apiService","CONSTANTS",function(a,b,c,d){var e=this;e.user=a,e.myDraft=b;var f=function(){for(var b=0;e.myDraft&&b<e.myDraft.length;b++){e.myDraft[b].character&&(e.myDraft[b].character.cover=d.urlCharacterCover(e.myDraft[b].scenarioId,e.myDraft[b].character.id));for(var c=0;a.openScenarios&&c<a.openScenarios.length;c++)e.myDraft[b].scenarioId==a.openScenarios[c].id&&(e.myDraft[b].scenarioName=a.openScenarios[c].name)}console.log("DRAFT")};f()}]),angular.module("smiled.application").controller("editDraftCtrl",["loggedUser","drafts","$stateParams",function(a,b,c){var d=this;d.user=a,d.drafts=b,d.postId=c.postId}]),angular.module("smiled.application").controller("expandCtrl",["apiService",function(a){function b(){return a.getMe().then(function(a){c.user=a;a.creatingScenarios},function(a){c.user={},console.log("dashboardCtrl error getting user")})}var c=this;b()}]),angular.module("smiled.application").controller("filesListCtrl",["loggedUser",function(a){var b=this;b.user=a}]),angular.module("smiled.application").controller("forgotCtrl",["userService","alertingGeneric",function(a,b){var c=this;c.userEmail="",c.sendNewPassRequest=function(){if(c.userEmail&&d()){var e={};e.email=c.userEmail,a.forgotPasswordRequest(e).then(function(a){b.addSuccess("Richiesta inviata con successo.")},function(a){b.addDanger("Si è verificato un errore")})}else b.addWarning("Inserire un indirizzo mail valido")};var d=function(){var a=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{1,6}(?:\.[a-z]{1})?)$/i;return a.test(c.userEmail)}}]),angular.module("smiled.application").controller("indexCtrl",["userService","apiService",function(a,b){function c(){g.isLogged=a.isLogged(),g.isLogged&&b.getMe().then(function(a){g.user=a;var b=f,c=new Date;g.cover=b+"?"+c.toString()},function(a){console.log("errore")})}function d(){a.logout()}function e(){var a=new Date;g.cover=f+"?"+a.toString()}a.registerObserverLoginCallback(c),a.registerObserverImageProfileCallback(e);var f="api/v1/me/cover",g=this;g.logout=d,c()}]),angular.module("smiled.application").controller("issuesCtrl",["CONSTANTS","apiService","$state","$timeout",function(a,b,c,d){var e=this;e.sended=!1,e.suggestionSended=!1,e.error=!1,e.postSuggestion=function(){var a={};a.newFeature=e.newFeature,a.modifyFeature=e.modifyFeature,a.deleteFeature=e.deleteFeature,b.postSuggestion(a).then(function(a){e.error=!1,e.newFeature="",e.modifyFeature="",e.deleteFeature="",e.suggestionSended=!0,d(function(){c.go("logged.dashboard")},7e3)},function(a){e.error=!0,console.log("Errore nell'invio della segnalazione"+a)})},e.postIssue=function(){var a={};a.preOperation=e.preOperation,a.issue=e.issue,a.expect=e.expect,b.postIssue(a).then(function(a){e.error=!1,e.preOperation="",e.issue="",e.expect="",e.sended=!0,d(function(){c.go("logged.dashboard")},7e3)},function(a){e.error=!0,console.log("Errore nell'invio della segnalazione"+a)})}}]),angular.module("smiled.application").controller("loggedCtrl",["loggedUser","$state",function(a,b){"ROLE_ADMIN"==a.role.authority?b.go("logged.dashboard.admin.users"):"ROLE_TEACHER"==a.role.authority?b.go("logged.dashboard.teacher"):"ROLE_USER"==a.role.authority&&b.go("logged.dashboard.student")}]),angular.module("smiled.application").controller("loginCtrl",["userService","apiService","alertingLogin","$state",function(a,b,c,d){var e=this;e.user={},e.register={},e.dateOptions={dateFormat:"dd/mm/yy"},e.login=function(){null==e.user.email||""==e.user.email?(c.addWarning("Inserire email"),e.user.password=""):null==e.user.password||""==e.user.password?c.addWarning("Inserire password"):f(e.user.email)?e.user.password.length<8?(c.addWarning("Password troppo corta!"),e.user.password=""):a.login(e.user.email,e.user.password).then(function(a){d.go("logged.dashboard")},function(a){e.user.password="",e.user.email="",c.addDanger("Attenzione credenziali errate!")}):(c.addWarning("Email non valida!"),e.user.password="")};var f=function(a){var b=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{1,6}(?:\.[a-z]{1})?)$/i;return b.test(a)}}]),angular.module("smiled.application").controller("mainCtrl",["$state","$rootScope","$scope","$timeout","$q",function(a,b,c,d){b.$on("unauthorized",function(){a.go("notLogged.login")})}]),angular.module("smiled.application").controller("navbarCtrl",["userService","$state","CONSTANTS","$scope","webSocketService","notifyService","$timeout","$window","$rootScope",function(a,b,c,d,e,f,g,h,i){function j(){a.logout().then(function(a){k.cover="",b.go("notLogged.login")},function(a){console.log("Errore logout")})}var k=this;k.newNotifications=[],k.oldNotifications=[],k.numNewNotifications=0,k.user={},k.basicCover={},k.dateFormat=c.realDateFormatWithSecond,k.iHaveDone=!1,k.openNotifications=!1,a.getMe().then(function(a){k.user=a,"ROLE_TEACHER"==k.user.role.authority||"ROLE_ADMIN"==k.user.role.authority?k.basicCover=c.basicTeacherCover:"ROLE_USER"==k.user.role.authority&&(k.basicCover=c.basicStudentCover)},function(a){console.log("errore")});var l=function(){var a=new Date;k.cover=c.urlMeCover+"?"+a.toString()},m=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],n=function(a){a.read=!1,k.newNotifications.splice(0,0,a),k.numNewNotifications=k.newNotifications.length,o(k.newNotifications)},o=function(b){if(null!=b&&b.length>0)for(var c=a.getScenarioId(),d=!1,e=0;e<b.length;e++)if("COMMENT_TO_POST"==b[e].verb)k.user.id==b[e].mainReceiver?b[e].text=b[e].actorName+" ha commentato un tuo post nello scenario "+b[e].scenarioName:b[e].text=b[e].actorName+" ha commentato un post che segui nello scenario "+b[e].scenarioName;else if("LIKE_TO_POST"==b[e].verb)k.user.id==b[e].mainReceiver?b[e].text="A "+b[e].actorName+" piace un tuo post nello scenario "+b[e].scenarioName:b[e].text="A "+b[e].actorName+" piace un post in cui sei taggato nello scenario "+b[e].scenarioName;else if("TAG_ON_CREATE"==b[e].verb)b[e].text=b[e].actorName+" ti ha taggato in un post nello scenario "+b[e].scenarioName;else if("TAG_ON_MOD"==b[e].verb){if(b[e].tagged){for(var g="",h=0;h<b[e].tagged.length;h++)g+=h<b[e].tagged.length-2?b[e].tagged[h].firstname+", ":h<b[e].tagged.length-1?b[e].tagged[h].firstname+" e ":b[e].tagged[h].firstname;b[e].text=b[e].actorName+" ha taggato "+g+" in un post nello scenario "+b[e].scenarioName}}else"METACOMMENT_TO_POST"==b[e].verb?k.user.id==b[e].mainReceiver?b[e].text=b[e].actorName+" ha inserito un suggerimento ad un tuo post nello scenario "+b[e].scenarioName:b[e].text=b[e].actorName+" ha inserito un suggerimento ad un post che segui nello scenario "+b[e].scenarioName:"NEW_ASSOCIATION"==b[e].verb?k.user.id==b[e].objectId?(b[e].text="Ti e' stato assegnato il personaggio "+b[e].actorName+" nello scenario "+b[e].scenarioName,c==b[e].scenarioId&&(d=!0)):b[e].text="Il personaggio "+b[e].actorName+" e' stato assegnato a "+b[e].objectContent+" nello scenario "+b[e].scenarioName:"DEL_ASSOCIATION"==b[e].verb?k.user.id==b[e].objectId?(b[e].text="Non stai piu' interpretando il personaggio "+b[e].actorName+" nello scenario "+b[e].scenarioName,c==b[e].scenarioId&&(d=!0)):b[e].text=b[e].objectContent+" non sta piu' interpretando il personaggio "+b[e].actorName+"nello scenario "+b[e].scenarioName:"OPEN_SCENARIO"==b[e].verb?b[e].text="Entra nel nuovo scenario "+b[e].scenarioName+" creato da "+b[e].actorName:"CLOSE_SCENARIO"==b[e].verb?b[e].text="Lo scenario "+b[e].scenarioName+" e' stato chiuso da "+b[e].actorName:"MODIFIED"==b[e].verb?k.user.id!=b[e].mainReceiver&&(b[e].text=b[e].actorName+" ha modificato un post che segui nello scenario "+b[e].scenarioName):"NEW_PERSONAL_MISSION"==b[e].verb?b[e].text=b[e].actorName+", ti e' stata assegnata una nuova missione nello scenario "+b[e].scenarioName:"NEW_GLOBAL_MISSION"==b[e].verb?b[e].text=b[e].actorName+" ha assegnato una nuova missione ai partecipanti dello scenario "+b[e].scenarioName:"NEW_MOD"==b[e].verb?b[e].text=b[e].actorName+" ti ha aggiunto come collaboratore nello scenario "+b[e].scenarioName:"NEW_FILE"==b[e].verb?b[e].text=b[e].actorName+" ha aggiunto il file "+b[e].objectContent+" nella sezione materiali dello scenario "+b[e].scenarioName:"NEW_ATTENDEE"==b[e].verb?b[e].text=b[e].actorName+" ti ha iscritto allo scenario "+b[e].scenarioName:"DEL_ATTENDEE"==b[e].verb?b[e].text=b[e].actorName+" ti ha rimosso dallo scenario "+b[e].scenarioName:"DELETED_POST_BY_MOD"==b[e].verb?b[e].text=b[e].actorName+" ha cancellato un tuo post nello scenario "+b[e].scenarioName:"MODIFIED_POST_BY_MOD"==b[e].verb?k.user.id==b[e].mainReceiver?b[e].text=b[e].actorName+" ha modificato un tuo post nello scenario "+b[e].scenarioName:b[e].text=b[e].actorName+" ha modificato un post che segui nello scenario "+b[e].scenarioName:"NEW_MOD_TO_CREATOR"==b[e].verb?b[e].text=b[e].actorName+" ha aggiunto "+b[e].objectContent+" come collaboratore dello scenario "+b[e].scenarioName:"DEL_MOD"==b[e].verb?b[e].text=b[e].actorName+" ti ha rimosso dallo scenario "+b[e].scenarioName:b[e].text="Nuova notifica!";d&&f.reloadAssociation()},p=function(a){if(null!=a&&a.length>0)for(var b=new Date,c=0;c<a.length;c++){var d="",e=b-a[c].date;if(e=Math.round(e/1e3),1>=e)d="un secondo fa";else if(60>e)d=e+" secondi fa";else if(e>=60)if(e=Math.round(e/60),1>=e)d="un minuto fa";else if(60>e)d=e+" minuti fa";else if(e>=60){var f=new Date(a[c].date);e=Math.round(e/60),1>=e?d="circa un'ora fa":24>e?d=e+" ore fa":48>e?d="Ieri alle "+f.getHours()+" "+f.getMinutes():e>=48&&(d=f.getDate()+" "+m[f.getMonth()]+" alle ore "+f.getHours()+":"+f.getMinutes())}a[c].formatDate=d}},q=function(){if(k.newNotifications&&k.newNotifications.length>0){for(var a=k.newNotifications.length-1;a>=0;a--)k.oldNotifications.splice(0,0,angular.copy(k.newNotifications[a]));k.newNotifications=[]}k.numNewNotifications=0,k.openNotifications=!1};k.onBlurDropDown=function(){q()};var r=function(){if(k.newNotifications.length>0){p(k.newNotifications);var a={};a.ids=[],a.type="ACK_N";for(var b=k.newNotifications.length-1;b>=0;b--)a.ids.push(angular.copy(k.newNotifications[b].id));a&&a.ids&&e.send(a)}if(k.oldNotifications.length>0&&p(k.oldNotifications),k.openNotifications=!0,k.newNotifications.length+k.oldNotifications.length<10){var c="",d=10;k.oldNotifications.length>0?c=k.oldNotifications[k.oldNotifications.length-1].id:k.newNotifications.length>0&&(c=k.newNotifications[k.newNotifications.length-1].id),c&&(d=10-k.newNotifications.length+k.oldNotifications.length),d>0&&f.readOldNotifications(c,d).then(function(a){p(a),o(a);for(var b=0;a&&b<a.length;b++)a[b].sender!=k.user.id&&(a[b].read=!1,k.oldNotifications.push(a[b]))},function(a){console.log("Error retriving old notification (REST)")})}};k.clickOnNotificationsButton=function(){if(k.openNotifications){q();var a=h.document.getElementById("notificationButton");a&&a.blur()}else r()},k.getNotificationCover=function(){return null},k.clickOnNotify=function(a){if(!a.viewed){a.viewed=!0;var c={};c.ids=[],c.ids.push(a.id),c.type="VIEW_N",g(e.send(c),1e3)}if("MODIFIED"==a.verb||"MODIFIED_POST_BY_MOD"==a.verb||"LIKE_TO_POST"==a.verb||"TAG_ON_CREATE"==a.verb||"TAG_ON_MOD"==a.verb)b.go("logged.scenario.post",{id:a.scenarioId,idPost:a.objectId});else if("COMMENT_TO_POST"==a.verb||"METACOMMENT_TO_POST"==a.verb){var d=a.objectId.substring(0,a.objectId.indexOf("/"));b.go("logged.scenario.post",{id:a.scenarioId,idPost:d})}else"NEW_PERSONAL_MISSION"==a.verb?("logged.scenario.missions"==b.current.name?i.$broadcast("notification.updateCharacterMission",{idS:a.scenarioId,idC:a.actorId}):b.go("logged.scenario.missions",{id:a.scenarioId}),ß):"NEW_GLOBAL_MISSION"==a.verb?"logged.scenario.missions"==b.current.name?i.$broadcast("notification.updateGlobalMission",{idS:a.scenarioId}):b.go("logged.scenario.missions",{id:a.scenarioId}):"DEL_ASSOCIATION"==a.verb||"OPEN_SCENARIO"==a.verb||"NEW_ATTENDEE"==a.verb?b.go("logged.scenario.characters",{id:a.scenarioId}):"NEW_ASSOCIATION"==a.verb?b.go("logged.scenario.charprofile",{id:a.scenarioId,idCharacter:a.actorId}):"NEW_MOD_TOCREATOR"==a.verb||"NEW_MOD"==a.verb?b.go("logged.scenarioWizard.info",{id:a.scenarioId}):"NEW_FILE"==a.verb?b.go("logged.scenario.resources",{id:a.scenarioId}):"DEL_MOD"!=a.verb&&"DEL_ATTENDEE"!=a.verb||b.go("logged.dashboard")},k.getSrcPhoto=function(a){return"NOTIFICATION"==a.type?"NEW_GLOBAL_MISSION"==a.verb||"CLOSE_SCENARIO"==a.verb||"OPEN_SCENARIO"==a.verb||"NEW_ATTENDEE"==a.verb||"DEL_ATTENDEE"==a.verb?c.urlScenarioCover(a.scenarioId):"METACOMMENT_TO_POST"==a.verb||"NEW_MOD"==a.verb||"NEW_MOD_TO_CREATOR"==a.verb||"DEL_MOD"==a.verb||"MODIFIED_POST_BY_MOD"==a.verb||"DELETED_POST_BY_MOD"==a.verb||"NEW_FILE"==a.verb?c.urlUserCover(a.actorId):"MODIFIED"==a.verb?a.actorId?c.urlCharacterCover(a.scenarioId,a.actorId):"assets/public/img/narr.png":"TAG_ON_CREATE"==a.verb||"TAG_ON_MOD"==a.verb?a.actorId?c.urlCharacterCover(a.scenarioId,a.actorId):"assets/public/img/narr.png":c.urlCharacterCover(a.scenarioId,a.actorId):("USER_MESSAGE"==a.type&&console.log("message!!!!!!!!!!!!"),"assets/public/img/icon/pg.png")},k.getErrPhoto=function(a){return"NOTIFICATION"==a.type?"NEW_GLOBAL_MISSION"==a.verb||"CLOSE_SCENARIO"==a.verb||"OPEN_SCENARIO"==a.verb||"NEW_ATTENDEE"==a.verb||"DEL_ATTENDEE"==a.verb?"assets/public/img/icon/ic_scen.png":"NEW_MOD"==a.verb||"NEW_MOD_TO_CREATOR"==a.verb||"MODIFIED_POST_BY_MOD"==a.verb||"DEL_MOD"==a.verb||"DELETED_POST_BY_MOD"==a.verb||"NEW_FILE"==a.verb?"assets/public/img/ic_teacher.png":"METACOMMENT_TO_POST"==a.verb?s(a.actorId)?"assets/public/img/ic_teacher.png":"assets/public/img/ic_student.png":"MODIFIED"==a.verb?a.actorId?"assets/public/img/icon/pg.png":"assets/public/img/narr.png":"assets/public/img/icon/pg.png":"USER_MESSAGE"==a.type?"assets/public/img/ic_student.png":void 0};var s=function(a){if("ROLE_TEACHER"==k.user.role.authority){if(k.user.colleagues)for(var b=0;b<k.user.colleagues.length;b++)if(k.user.colleagues[b].id==a)return!0}else if("ROLE_USER"==k.user.role.authority&&k.user.teachers)for(var b=0;b<k.user.teachers.length;b++)if(k.user.teachers[b].id==a)return!0;return!1};k.logout=j,l(),a.registerObserverPersonalCover(l);var t=function(a){if(k.newNotifications)for(var b=0;b<k.newNotifications.length;b++)if(k.newNotifications[b].id==a)return void(k.newNotifications[b].viewed=!0);if(k.oldNotifications)for(var b=0;b<k.oldNotifications.length;b++)k.oldNotifications[b].id==a&&(k.oldNotifications[b].viewed=!0)},u=d.$on("notification.newNotificationEvent",function(a,b){n(b.notification),d.$applyAsync()}),v=d.$on("notification.setViewedEvent",function(a,b){t(b.id)});d.$on("$destroy",function(){u(),v(),f.resetObserverAssociation()})}]),angular.module("smiled.application").controller("notificationCtrl",["$rootScope","$state","userService","apiService","CONSTANTS","$timeout","webSocketService",function(a,b,c,d,e,f,g){var h=this;h.notifications=[],h.dateFormat=e.realDateFormatWithMinute,h.user={},h.user.id="",h.basicCover={},h.busy=!1;var i=!1;h.user=c.getLastMe();var j=function(){d.getLastUserNotifications("",10).then(function(a){0==a.length?i=!0:(m(a),h.notifications=a),h.busy=!1},function(a){console.log("problem in getLastUserNotifications"),h.busy=!1})},k=function(){d.getLastUserNotifications(h.notifications[h.notifications.length-1].id,10).then(function(a){0==a.length?i=!0:(m(a),h.notifications=h.notifications.concat(a)),h.busy=!1},function(a){console.log(a),h.busy=!1})};h.nextNotification=function(){h.busy||i||(h.busy=!0,0==h.notifications.length?j():k())};var l=function(){j()};l(),h.clickOnNotify=function(c){a.$broadcast("notification.setViewedEvent",{id:c.id}),c.viewed=!0;var d={};if(d.ids=[],d.ids.push(c.id),d.type="VIEW_N",f(g.send(d),1e3),"MODIFIED"==c.verb||"MODIFIED_POST_BY_MOD"==c.verb||"LIKE_TO_POST"==c.verb||"TAG_ON_CREATE"==c.verb||"TAG_ON_MOD"==c.verb)b.go("logged.scenario.post",{id:c.scenarioId,idPost:c.objectId});else if("COMMENT_TO_POST"==c.verb||"METACOMMENT_TO_POST"==c.verb){var e=c.objectId.substring(0,c.objectId.indexOf("/"));b.go("logged.scenario.post",{id:c.scenarioId,idPost:e})}else"NEW_PERSONAL_MISSION"==c.verb||"NEW_GLOBAL_MISSION"==c.verb?b.go("logged.scenario.missions",{id:c.scenarioId}):"DEL_ASSOCIATION"==c.verb||"OPEN_SCENARIO"==c.verb||"NEW_ATTENDEE"==c.verb||"NEW_MOD_TOCREATOR"==c.verb||"NEW_MOD"==c.verb?b.go("logged.scenario.characters",{id:c.scenarioId}):"NEW_ASSOCIATION"==c.verb?b.go("logged.scenario.charprofile",{id:c.scenarioId,idCharacter:c.actorId}):"NEW_FILE"==c.verb?b.go("logged.scenario.resources",{id:c.scenarioId}):"DEL_MOD"!=c.verb&&"DEL_ATTENDEE"!=c.verb||b.go("logged.dashboard")},h.getSrcPhoto=function(a){return"NOTIFICATION"==a.type?"NEW_GLOBAL_MISSION"==a.verb||"CLOSE_SCENARIO"==a.verb||"OPEN_SCENARIO"==a.verb||"NEW_ATTENDEE"==a.verb||"DEL_ATTENDEE"==a.verb?e.urlScenarioCover(a.scenarioId):"METACOMMENT_TO_POST"==a.verb||"NEW_MOD"==a.verb||"NEW_MOD_TO_CREATOR"==a.verb||"DEL_MOD"==a.verb||"MODIFIED_POST_BY_MOD"==a.verb||"DELETED_POST_BY_MOD"==a.verb||"NEW_FILE"==a.verb?e.urlUserCover(a.actorId):"MODIFIED"==a.verb?a.actorId?e.urlCharacterCover(a.scenarioId,a.actorId):"assets/public/img/narr.png":"TAG_ON_CREATE"==a.verb||"TAG_ON_MOD"==a.verb?a.actorId?e.urlCharacterCover(a.scenarioId,a.actorId):"assets/public/img/narr.png":e.urlCharacterCover(a.scenarioId,a.actorId):("USER_MESSAGE"==a.type&&console.log("message!!!!!!!!!!!!"),"assets/public/img/icon/pg.png")},h.getErrPhoto=function(a){return"NOTIFICATION"==a.type?"NEW_GLOBAL_MISSION"==a.verb||"CLOSE_SCENARIO"==a.verb||"OPEN_SCENARIO"==a.verb||"NEW_ATTENDEE"==a.verb||"DEL_ATTENDEE"==a.verb?"assets/public/img/icon/ic_scen.png":"NEW_MOD"==a.verb||"NEW_MOD_TO_CREATOR"==a.verb||"MODIFIED_POST_BY_MOD"==a.verb||"DEL_MOD"==a.verb||"DELETED_POST_BY_MOD"==a.verb||"NEW_FILE"==a.verb?"assets/public/img/ic_teacher.png":"METACOMMENT_TO_POST"==a.verb?n(a.actorId)?"assets/public/img/ic_teacher.png":"assets/public/img/ic_student.png":"MODIFIED"==a.verb?a.actorId?"assets/public/img/icon/pg.png":"assets/public/img/narr.png":"assets/public/img/icon/pg.png":"USER_MESSAGE"==a.type?"assets/public/img/ic_student.png":void 0};var m=function(a){if(null!=a&&a.length>0)for(var b=0;b<a.length;b++)if("COMMENT_TO_POST"==a[b].verb)h.user.id==a[b].mainReceiver?a[b].text=a[b].actorName+" ha commentato un tuo post":a[b].text=a[b].actorName+" ha commentato un post che segui";else if("LIKE_TO_POST"==a[b].verb)h.user.id==a[b].mainReceiver?a[b].text="A "+a[b].actorName+" piace un tuo post":a[b].text="A "+a[b].actorName+" piace un post in cui sei taggato";else if("TAG_ON_CREATE"==a[b].verb)a[b].text=a[b].actorName+" ti ha taggato in un post";else if("TAG_ON_MOD"==a[b].verb){if(a[b].tagged){for(var c="",d=0;d<a[b].tagged.length;d++)c+=d<a[b].tagged.length-2?a[b].tagged[d].firstname+", ":d<a[b].tagged.length-1?a[b].tagged[d].firstname+" e ":a[b].tagged[d].firstname;a[b].text=a[b].actorName+" ha taggato "+c+" in un post"}}else"METACOMMENT_TO_POST"==a[b].verb?h.user.id==a[b].mainReceiver?a[b].text=a[b].actorName+" ha inserito un suggerimento ad un tuo post":a[b].text=a[b].actorName+" ha inserito un suggerimento ad un post che segui":"NEW_ASSOCIATION"==a[b].verb?h.user.id==a[b].objectId?a[b].text="Ti e' stato assegnato il personaggio "+a[b].actorName:a[b].text="Il personaggio "+a[b].actorName+" e' stato assegnato a "+a[b].objectContent:"DEL_ASSOCIATION"==a[b].verb?h.user.id==a[b].objectId?a[b].text="Non stai piu' interpretando il personaggio "+a[b].actorName:a[b].text=a[b].objectContent+" non sta piu' interpretando il personaggio "+a[b].actorName:"OPEN_SCENARIO"==a[b].verb?a[b].text="Entra nel nuovo scenario "+a[b].scenarioName+" creato da "+a[b].actorName:"CLOSE_SCENARIO"==a[b].verb?a[b].text="Lo scenario "+a[b].scenarioName+" e' stato chiuso da "+a[b].actorName:"MODIFIED"==a[b].verb?h.user.id!=a[b].mainReceiver&&(a[b].text=a[b].actorName+" ha modificato un post che segui"):"NEW_PERSONAL_MISSION"==a[b].verb?a[b].text=a[b].actorName+", ti e' stata assegnata una nuova missione":"NEW_GLOBAL_MISSION"==a[b].verb?a[b].text=a[b].actorName+" ha assegnato una nuova missione ai partecipanti dello scenario":"NEW_MOD"==a[b].verb?a[b].text=a[b].actorName+" ti ha aggiunto come collaboratore":"NEW_FILE"==a[b].verb?a[b].text=a[b].actorName+" ha aggiunto il file "+a[b].objectContent+" nella sezione materiali":"NEW_ATTENDEE"==a[b].verb?a[b].text=a[b].actorName+" ti ha iscritto allo scenario":"DEL_ATTENDEE"==a[b].verb?a[b].text=a[b].actorName+" ti ha rimosso dallo scenario":"DELETED_POST_BY_MOD"==a[b].verb?a[b].text=a[b].actorName+" ha cancellato un tuo post":"MODIFIED_POST_BY_MOD"==a[b].verb?h.user.id==a[b].mainReceiver?a[b].text=a[b].actorName+" ha modificato un tuo post":a[b].text=a[b].actorName+" ha modificato un post che segui":"NEW_MOD_TO_CREATOR"==a[b].verb?a[b].text=a[b].actorName+" ha aggiunto "+a[b].objectContent+" come collaboratore":"DEL_MOD"==a[b].verb?a[b].text=a[b].actorName+" ti ha rimosso dallo scenario ":a[b].text="Nuova notifica!"},n=function(a){if("ROLE_TEACHER"==h.user.role.authority){if(h.user.colleagues)for(var b=0;b<h.user.colleagues.length;b++)if(h.user.colleagues[b].id==a)return!0}else if("ROLE_USER"==h.user.role.authority&&h.user.teachers)for(var b=0;b<h.user.teachers.length;b++)if(h.user.teachers[b].id==a)return!0;return!1}}]),angular.module("smiled.application").controller("oldCharacterChangeOnCommentCtrl",["charName","modalService","$window",function(a,b,c){var d=this;d.charName=a,d.ok=function(){b.closeModalOldCharacterChangeOnComment(),c.location.reload()}}]),angular.module("smiled.application").controller("openMapCtrl",["post","scenarioMap","modalService",function(a,b,c){var d=this;d.post=a;var e=angular.copy(a.place);b?d.map=b.url:d.map=null,d.stylePin={visibility:"hidden"},d.pinPoint=function(b){var c={};c.x=b.offsetX/b.target.width,c.y=b.offsetY/b.target.height,a.place=c;var e=b.offsetX-20,f=b.offsetY-40;d.stylePin={visibility:"visible",top:f+"px",left:e+"px"}},d.removePoint=function(){console.log("removePoint")},d.ok=function(){c.closeModalOpenMap()},d.cancel=function(){c.closeModalOpenMap(),a.place=e}}]),angular.module("smiled.application").controller("openMapForPostCtrl",["post","scenarioMap","modalService",function(a,b,c){var d=this;d.post=a,b?d.map=b.url:d.map=null,console.log("OPENMAPFORPOSTCTRL: "+d.map),d.ok=function(){c.closeModalOpenMapForPost()},d.cancel=function(){c.closeModalOpenMapForPost()}}]),angular.module("smiled.application").controller("personalMissionCtrl",["apiService","CONSTANTS","$scope","$stateParams",function(a,b,c,d){var e=this;console.log(d.missions),null!=d.missions&&d.missions.length>0?e.myMissions=d.missions:(console.log("download missions"),a.getMyMissions().then(function(a){e.myMissions=a},function(a){console.log("Error retrieve missions"),console.log(a)})),e.missionDateFormatDay=b.realDateFormatOnlyDay,e.missionDateFormatMonth=b.realDateFormatOnlyMonth}]),angular.module("smiled.application").controller("personalProfileCtrl",["Upload","userService","$stateParams","CONSTANTS","$cookies","$filter","$anchorScroll","$location",function(a,b,c,d,e,f,g,h){var i=this,j=null,k=null;i.ruolo=null,i.editProfile=!1,i.editPassword=!1,i.updateUserDTO={},i.dateFormat=d.realDateFormatWithoutHour,i.isModifiable=!1,i.user={},i.oldPassword="",i.newPassword="",i.newPassword2="",i.messageErrorModifyPassword="",i.dateOptions={regional:"it",changeYear:!0,maxDate:"0",minDate:new Date(1900,0,1,0,0,0,0),yearRange:"1900:c"};var l=e.get("myMescholaId"),m=function(a){i.user=a,k=i.user.role,i.user.profile&&(i.updateUserDTO.gender=angular.copy(i.user.profile.gender),i.bornDateString=f("date")(angular.copy(i.user.profile.bornDate),i.dateFormat),i.updateUserDTO.bornCity=angular.copy(i.user.profile.bornCity),i.updateUserDTO.schoolCity=angular.copy(i.user.profile.schoolCity),i.updateUserDTO.school=angular.copy(i.user.profile.school),i.updateUserDTO.quote=angular.copy(i.user.profile.quote)),"ROLE_TEACHER"==k.authority?i.ruolo="DOCENTE":"ROLE_USER"==k.authority?i.ruolo="STUDENTE":i.ruolo="AMMINISTRATORE"},n=function(a){console.log("Error getting user personalProfile: "+a)},o=function(a){console.log("Error updating user personalProfile: "+a)};if(c.id&&(j=c.id),j)if(b.getUser(j).then(m,n),j==l){var p=new Date;i.url=d.urlMeCover+"?"+p.toString(),i.coverLarge=d.urlMeCoverLarge+"?"+p.toString(),i.isModifiable=!0}else{var p=new Date;i.url=d.urlUserCover(j)+"?"+p.toString(),i.coverLarge=d.urlUserCoverLarge(j)+"?"+p.toString()}else{b.getMe().then(m,n);var p=new Date;i.url=d.urlMeCover+"?"+p.toString(),i.coverLarge=d.urlMeCoverLarge+"?"+p.toString(),i.isModifiable=!0}i.updateMe=function(){if(i.bornDateString){var a=i.bornDateString.split("-"),c=new Date(a[2],a[1]-1,a[0],0,0,0,0);i.updateUserDTO.bornDate=c}b.updateMe(i.updateUserDTO).then(m,o)},i.uploadCover=function(c){c&&c.length&&a.upload({url:"api/v1/me/cover/",headers:{"Content-Type":c.type},file:c}).success(function(a,c,e,f){var g=new Date;i.url=d.urlMeCover+"?"+g.toString(),b.notifyPersonalCoverObservers()})},i.uploadCoverLarge=function(b){b&&b.length&&a.upload({url:"api/v1/me/coverLarge",headers:{"Content-Type":b.type},file:b}).success(function(a,b,c,e){var f=new Date;i.coverLarge=d.urlMeCoverLarge+"?"+f.toString()})},i.switchEditPassword=function(){i.editPassword=!i.editPassword,1==i.editPassword&&(h.hash("changePwd"),g(),h.url(h.path()))},i.switchEditProfile=function(){i.editProfile=!i.editProfile,i.editPassword=!1},i.showEditProfile=function(){i.editPassword=!1,i.editProfile=!0},i.closeEditProfile=function(){i.editProfile=!1,i.deleteModifyPassword()},i.deleteUpdateMe=function(){i.updateUserDTO={},i.user.profile&&(i.updateUserDTO.gender=angular.copy(i.user.profile.gender),i.bornDateString=f("date")(angular.copy(i.user.profile.bornDate),i.dateFormat),i.updateUserDTO.bornCity=angular.copy(i.user.profile.bornCity),i.updateUserDTO.schoolCity=angular.copy(i.user.profile.schoolCity),i.updateUserDTO.school=angular.copy(i.user.profile.school),i.updateUserDTO.quote=angular.copy(i.user.profile.quote))},i.deleteModifyPassword=function(){i.oldPassword="",i.newPassword="",i.newPassword2="",i.editPassword=!1,i.messageErrorModifyPassword=""},i.modifyPassword=function(){if(i.messageErrorModifyPassword="",i.oldPassword&&i.newPassword)if(i.newPassword.length<8)i.messageErrorModifyPassword="Inserire una password lunga almeno 8 caratteri!",i.oldPassword="",i.newPassword="",i.newPassword2="";else if(i.newPassword==i.newPassword2){var a={};a.oldPassword=i.oldPassword,a.newPassword=i.newPassword,b.changePassword(a).then(function(a){i.oldPassword="",i.newPassword="",i.newPassword2="",i.editPassword=!1,alert("Password modificata correttamente")},function(a){i.messageErrorModifyPassword="Errore nel cambio password!",i.oldPassword="",i.newPassword="",i.newPassword2=""})}else i.messageErrorModifyPassword="Errore - le due password non corrispondono!",i.oldPassword="",i.newPassword="",i.newPassword2="";else i.messageErrorModifyPassword="Inserire tutti i campi richiesti!",i.oldPassword="",i.newPassword="",i.newPassword2=""}}]),angular.module("smiled.application").controller("registerCtrl",["apiService","$state","alertingRegistration",function(a,b,c){var d=this;d.user={},d.user.agree=!1,d.dateOptions={regional:"it",changeYear:!0,maxDate:"0",minDate:new Date(1900,0,1,0,0,0,0),yearRange:"1900:c"},d.postRegister=function(){e()?a.postRegister(d.user).then(function(a){console.log("success register"),d.user.email="",d.user.firstName="",d.user.lastName="",d.user.bornDate="",d.user.schoolCity="",d.user.bornCity="",d.user.nameOfSchool="",d.user.password="",d.user.confirmPassword="",d.user.agree=!1,c.addSuccess("La tua richiesta e' stata accettata. A breve riceverai una mail per confermare la tua registrazione")},function(a){throw d.user.email="",d.user.firstName="",d.user.lastName="",d.user.bornDate="",d.user.schoolCity="",d.user.bornCity="",d.user.nameOfSchool="",d.user.password="",d.user.confirmPassword="",
d.user.agree=!1,c.addDanger("Non e' stato possibile completare la registrazione, ti preghiamo di riprovare!"),new Error("Non e' stato possibile completare la registrazione, ti preghiamo di riprovare!")}):(d.user.password="",d.user.confirmPassword="")};var e=function(){return null==d.user.email||""==d.user.email||null==d.user.firstName||""==d.user.firstName||null==d.user.lastName||""==d.user.lastName||null==d.user.bornDate||""==d.user.bornDate||null==d.user.bornCity||""==d.user.bornCity||null==d.user.schoolCity||""==d.user.schoolCity||null==d.user.nameOfSchool||""==d.user.nameOfSchool||null==d.user.password||""==d.user.password||null==d.user.confirmPassword||""==d.user.confirmPassword?(c.addWarning("Compilare tutti i campi!"),!1):d.user.agree?f(d.user.email)?d.user.password!=d.user.confirmPassword?(c.addWarning("Attenzione le due password digitate non corrispondono!"),!1):d.user.password.length<8?(c.addWarning("Password troppo corta!"),!1):!0:(c.addWarning("Email non valida!"),!1):(c.addWarning("Acconsenti al trattamento dei tuoi dati personali!"),!1)},f=function(a){var b=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{1,6}(?:\.[a-z]{1})?)$/i;return b.test(a)},g={img:"assets/public/img/green.jpg"},h={img:"assets/public/img/landing page/Personalizzabile.png"},i={img:"assets/public/img/landing page/Sicura.png"},j={img:"assets/public/img/landing page/Collaborativa.png"},k={img:"assets/public/img/cover_default.jpg"},l={img:"assets/public/img/calderone1.png"},m={img:"assets/public/img/icon/pg.png"},n={img:"assets/public/img/wizard/wiz_att.png"},o={img:"assets/public/img/wizard/wiz_char.png"},p={img:"assets/public/img/wizard/wiz_coll.png"},q={img:"assets/public/img/ic_creatingscenario.png"},r={img:"assets/public/img/ic_openscenario.png"},s={img:"assets/public/img/wizard/wiz_info.png"},t=[g,h,i,j,k,l,m,n,o,p,q,r,s],u=0;d.hideArrowsL=!1,d.scenariosToShowL=t.slice(0,5),t.length<=5&&(d.hideArrowsL=!0),d.shiftScenariosAfterL=function(){u+=5,(u>11||u>=t.length)&&(u=0),t.length-u<=5&&(u=t.length-5),d.scenariosToShowL=t.slice(u,u+5)},d.shiftScenariosBeforeL=function(){0==u?u=t.length-5:u-=5,0>u&&(u=0),d.scenariosToShowL=t.slice(u,u+5)},d.hideArrowsM=!1,d.scenariosToShowM=t.slice(0,3),t.length<=3&&(hideArrowsM=!0),d.shiftScenariosAfterM=function(){u+=3,(u>12||u>=t.length)&&(u=0),t.length-u<=3&&(u=t.length-3),d.scenariosToShowM=t.slice(u,u+3)},d.shiftScenariosBeforeM=function(){0==u?u=t.length-3:(u-=3,0>u&&(u=0)),d.scenariosToShowM=t.slice(u,u+3)},d.hideArrowsS=!1,d.scenariosToShowS=t.slice(0,1),t.length<=1&&(hideArrowsM=!0),d.shiftScenariosAfterS=function(){u+=1,u>=t.length&&(u=0),d.scenariosToShowS=t.slice(u,u+1)},d.shiftScenariosBeforeS=function(){0==u?u=t.length-1:(u-=1,0>u&&(u=0)),d.scenariosToShowS=t.slice(u,u+1)}}]),angular.module("smiled.application").controller("registrationConfirmCtrl",["$state",function(a){a.go("login")}]),angular.module("smiled.application").controller("scenarioCharactersCtrl",["CONSTANTS","$scope",function(a,b){var c=this;c.scen=b.scenario.scen;var d=function(){if(c.associations=c.scen.characters,c.associations)for(var b=0;b<c.associations.length;b++)if(c.associations[b].cover=a.urlCharacterCover(c.scen.id,c.associations[b].id),console.log(c.associations[b].cover),c.associations[b].userId&&c.scen.attendees)for(var d=0;d<c.scen.attendees.length;d++)if(c.scen.attendees[d].id==c.associations[b].id){c.associations[b].userFirstName=c.scen.attendees[d].firstname,c.associations[b].userLastName=c.scen.attendees[d].lasstname,c.associations[b].userCover=a.urlUserCover(c.scen.attendees[d].id);break}};d()}]),angular.module("smiled.application").controller("scenarioCtrl",["scenario","loggedUser","CONSTANTS","apiService","userService","modalService","$location","$anchorScroll","Upload","notifyService","$scope","$interval",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=this;m.scen=a,m.loggedUser=b;var n=new Date;m.scen.cover=c.urlScenarioCover(m.scen.id)+"?"+n.toString(),m.isModerator=!1,m.isCreator=!1,m.hasCharacter=!1,m.currentCharacter={},m.showBoxEvent=!1,m.showBoxCharacters=!1,m.showBoxAttendees=!1,m.showBoxCollaborators=!1,m.showBoxInfo=!0,m.numNewPost=0,m.dateFormat=c.realDateFormatWithMinute,m.firstNameAndSecondName=function(a,b){return a+" "+b},m.openBoxEvent=function(){m.showBoxEvent=!m.showBoxEvent},m.openBoxCharacters=function(){m.showBoxCharacters=!0},m.openBoxAttendees=function(){m.showBoxAttendees=!0},m.openBoxCollaborators=function(){m.showBoxCollaborators=!0},m.openBoxInfo=function(){m.showBoxInfo=!0},m.closeBoxInfo=function(){m.showBoxInfo=!1},m.closeBoxCharacters=function(){m.showBoxCharacters=!1},m.closeBoxAttendees=function(){m.showBoxAttendees=!1},m.closeBoxCollaborators=function(){m.showBoxCollaborators=!1},m.incrementNumNewPost=function(){m.numNewPost++};var o=function(){m.numNewPost=0};m.showNewPosts=function(){j.reloadList(),o(),g.hash("top"),h(),g.url(g.path())};var p=function(){e.getMe().then(function(a){m.loggedUser=a,q()},function(a){consolelog("error")})},q=function(){if(m.scen.teacherCreator.id==m.loggedUser.id&&(m.isCreator=!0,m.isModerator=!0),e.setScenarioId(m.scen.id),!m.isModerator&&m.scen.collaborators)for(var a=0;a<m.scen.collaborators.length;a++)if(m.scen.collaborators[a].id==m.loggedUser.id){m.isModerator=!0;break}if("ACTIVE"==m.scen.status&&null!=m.loggedUser.openScenarios)for(var a=0;a<m.loggedUser.openScenarios.length;a++)if(m.loggedUser.openScenarios[a].id==m.scen.id)if(m.loggedUser.openScenarios[a].myCharacterId){var b=new Date;m.hasCharacter=!0,m.currentCharacter.id=m.loggedUser.openScenarios[a].myCharacterId,m.currentCharacter.name=m.loggedUser.openScenarios[a].myCharacterName,m.currentCharacter.cover=c.urlCharacterCover(m.scen.id,m.currentCharacter.id)+"?"+b.toString()}else m.hasCharacter=!1,m.currentCharacter={}};m.uploadCover=function(a){a&&a.length&&i.upload({url:c.urlScenarioCover(m.scen.id),headers:{"Content-Type":a.type},file:a}).success(function(a,b,d,e){var f=new Date;m.scen.cover=c.urlScenarioCover(m.scen.id)+"?"+f.toString()})},m.goToBody=function(){g.hash("body-content"),h(),g.url(g.path())};var r=k.$on("notification.newPostEvent",function(){m.incrementNumNewPost(),k.$applyAsync()});k.$on("$destroy",function(){j.resetObserverAssociation(),r()}),j.registerObserverAssociation(p),q()}]),angular.module("smiled.application").controller("scenarioMapCtrl",["CONSTANTS","$scope","apiService","Fullscreen",function(a,b,c,d){var e=this;e.isFullScreen=!1,e.scen=b.scenario.scen,e.scen.history.mapId&&(e.map=a.urlMedia(e.scen.history.mapId)),e.posts=c.getPagedPosts(e.scen.id,0,300,!1),e.slide=0,e.startDateString="",e.endDateString="",e.actualDate="",e.bars={},e.getHeight=function(a){if(e.bars&&e.bars[a]){var b=Math.max.apply(Math,e.bars);return 0==b?"0%":parseInt(100*e.bars[a]/b)+"%"}return"0%"},e.getDisplace=function(){var a=angular.element(document.querySelector("#slider")).width(),b=parseInt(a/100*e.slide);return b-=b>.75*a?a/4:a/8,b+"px"},e.options={orientation:"horizontal",min:0,max:100,range:"min"},e.toggleFullScreen=function(){e.isFullScreen=!e.isFullScreen,e.isFullScreen?d.all():d.cancel()}}]),angular.module("smiled.application").controller("scenarioMissionsCtrl",["$stateParams","apiService","$scope","CONSTANTS",function(a,b,c,d){var e=this,f=c.scenario.loggedUser.id;e.myCharacter=null,e.characters=[];var g=function(){if(b.getScenario(a.id).then(function(a){c.scenario.scen=a;var b=new Date;c.scenario.scen.cover=d.urlScenarioCover(c.scenario.scen.id)+"?"+b.toString()},function(a){console.log("error in find scenario")}),c.scenario.isModerator||c.scenario.isCreator||"ROLE_ADMIN"==c.scenario.loggedUser.role.authority)b.getAllCharactersFromScen(a.id).then(function(a){e.characters=a},function(a){console.log("error in find all characters")});else{if(c.scenario.scen.characters)for(var g=0;g<c.scenario.scen.characters.length;g++)if(c.scenario.scen.characters[g].userId==f){e.myCharacter=c.scenario.scen.characters[g];break}e.myCharacter&&b.getCharacter(a.id,e.myCharacter.id).then(function(a){e.characters.push(a)},function(a){console.log("error in find my character")})}},h=function(a,c){b.getCharacter(a,c).then(function(a){if(e.characters)for(var b=0;b<e.characters.length;b++)e.characters[b].id==a.id&&(e.characters[b]=a)},function(a){console.log("error in reload character mission")})},i=function(a){b.getScenario(a).then(function(b){c.scenario.scen=b;var e=new Date;c.scenario.scen.cover=d.urlScenarioCover(a)+"?"+e.toString()},function(a){console.log("error in reload global mission")})};g();var j=c.$on("notification.updateGlobalMission",function(a,b){console.log("event!!!!!!!!!"),i(b.idS)}),k=c.$on("notification.updateCharacterMission",function(a,b){h(b.idS,b.idC)});c.$on("$destroy",function(){k(),j()})}]),angular.module("smiled.application").controller("scenarioPostCtrl",["CONSTANTS","$scope","apiService","Upload","$interval","notifyService",function(a,b,c,d,e,f){var g=this;g.scen=b.scenario.scen,g.currentCharacter=b.scenario.currentCharacter,g.posts=[],b.scenario.labelNewPosts=!0;var h=a.numberOfPostForScroll;g.newEvent={},g.newEvent.date={afterChrist:!0},g.newEvent.date.formatted=a.insertHistoricalDateEvent,g.showDatePicker=!1,g.showDatePickerEvent=!1,b.scenario.hasCharacter?g.commentTab=!0:g.commentTab=!1,g.realDateFormat=a.realDateFormatWithHour,g.getUrlCoverCharacter=function(b){return a.urlCharacterCover(g.scen.id,b)},g.getUrlMedia=function(b){return a.urlMedia(b)},g.formatDate=function(a){return a.afterChrist?era="D.C.":era="A.C.",a.day+" / "+a.month+" / "+a.year+" "+era};var i=function(a){for(var b=0;b<g.posts.length;b++)if(g.posts[b].id==a)return!0;return!1};g.switchCommentTab=function(a){b.scenario.hasCharacter?g.commentTab=a:g.commentTab=!1};var j=!1;g.nextPost=function(){g.busy||j||(g.busy=!0,0==g.posts.length?g.getPost("",h):g.getPost(g.posts[g.posts.length-1].id,h))},g.busy=!1,g.getPost=function(b,d){c.getLastPosts(g.scen.id,b,d).then(function(b){var c=[];c=b,0==b.length&&(j=!0);for(var d=0;c&&d<c.length;d++){if(c[d].character){c[d].character.cover=a.urlCharacterCover(g.scen.id,c[d].character.id);for(var e=0;e<c[d].likes.length;e++)if(c[d].likes[e].id==g.currentCharacter.id){c[d].youLike=!0;break}}g.posts.push(angular.copy(c[d]))}g.busy=!1},function(a){console.log("errore"),g.busy=!1})};var k=function(b){c.getListOfNewPosts(g.scen.id,b).then(function(b){for(var c=b.content,d=0;d<c.length;d++)if(c[d].character){c[d].character.cover=a.urlCharacterCover(g.scen.id,c[d].character.id);for(var e=0;e<c[d].likes.length;e++)if(c[d].likes[e].id==g.currentCharacter.id){c[d].youLike=!0;break}}for(var d=0;d<g.posts.length;d++)c.push(g.posts[d]);g.posts=c},function(a){console.log("errore")})},l=function(a){if(null!=a&&a.length>0){for(var b=0;b<a.length;b++)i(a[b])||listOfUpPosts.splice(b,1);a.length>0&&c.getListOfNewPosts(g.scen.id,a).then(function(a){if(a.content)for(var b=0;b<a.content.length;b++)for(var c=0;c<g.posts.length;c++)g.posts[c].id==a.content[b].id&&(g.posts[c]=angular.copy(a.content[b]))},function(a){console.log("errore")})}};g.addCommentToPost=function(b){if(b.newComment){var d={};d.text=b.newComment,c.sendCommentToPost(g.scen.id,b.id,d).then(function(d){c.getSingleStatus(g.scen.id,b.id).then(function(b){for(var c=0;c<g.posts.length;c++)g.posts[c].id==b.id&&(b.newComment="",b.imageId&&(b.imageUrl=a.urlMedia(b.imageId)),b.character.cover=a.urlCharacterCover(g.scen.id,b.character.id),g.posts.splice(c,1,b))},function(a){console.log("error in insert new post in array")})},function(a){console.log("fail to send comment: "+a)})}},g.addMetaCommentToPost=function(b){if(b.newMetaComment){var d={};d.text=b.newMetaComment,c.sendMetaCommentToPost(g.scen.id,b.id,d).then(function(d){c.getSingleStatus(g.scen.id,b.id).then(function(c){b.newMetaComment="";for(var d=0;d<g.posts.length;d++)g.posts[d].id==c.id&&(c.newComment="",c.imageId&&(c.imageUrl=a.urlMedia(c.imageId)),c.character.cover=a.urlCharacterCover(g.scen.id,c.character.id),g.posts.splice(d,1,c))},function(a){console.log("error in insert new post in array")})},function(a){console.log("fail to send comment: "+a)})}},f.setActualScenarioId(g.scen.id),f.registerObserverReloadList(k);var m=b.$on("notification.updPostEvent",function(a,b){console.log("notification.updPostEvent");var c=[];c.push(b.id),l(c)}),n=b.$on("notification.updNewComment",function(a,b){for(var c=b.notification,d=!1,e=0;e<g.posts.length;e++)if(g.posts[e].id==c.objectId){for(var f=0;g.posts[e].comments&&f<g.posts[e].comments.length;f++)if(g.posts[e].comments[f].id==c.comment.id){g.posts[e].comments[f]=angular.copy(c.comment),d=!0;break}d||g.posts[e].comments.splice(0,0,angular.copy(c.comment));break}}),o=b.$on("notification.updNewMetaComment",function(a,b){for(var c=b.notification,d=!1,e=0;e<g.posts.length;e++)if(g.posts[e].id==c.objectId){for(var f=0;g.posts[e].metaComments&&f<g.posts[e].metaComments.length;f++)if(g.posts[e].metaComments[f].id==c.metaComment.id){g.posts[e].metaComments[f]=angular.copy(c.metaComment),d=!0;break}d||g.posts[e].metaComments.splice(0,0,angular.copy(c.metaComment));break}});b.$on("$destroy",function(){o(),n(),m(),f.resetActualScenarioId(),f.resetObserverReloadList(),b.scenario.labelNewPosts=!1,g.post=[],b.scenario.numNewPost=0})}]),angular.module("smiled.application").controller("scenarioResourcesCtrl",["CONSTANTS","$scope","apiService","Upload","$location","$anchorScroll","modalService",function(a,b,c,d,e,f,g){var h=this;h.scen=b.scenario.scen,h.uploadable=b.scenario.isCreator||b.scenario.isModerator,h.showMetaBox=!1,h.showProgressBar=!1,h.newFile={},h.newFile.progress=0,h.showCancelButton=!1,h.error="",h.files=[],h.realDateFormat=a.realDateFormatWithHour;var i,j=function(a){return"jpg"==a||"png"==a||"gif"==a?"img":"pdf"==a?"pdf":"doc"==a||"docx"==a||"odt"==a||"txt"==a?"doc":"ppt"==a||"pptx"==a||"odp"==a?"ppt":(a="xls")?"excel":"doc"},k=function(){c.getTrustedMediaMetadata(h.scen.id).then(function(a){if(h.files=a,h.files)for(var b=0;b<h.files.length;b++)if(h.files[b].type=j(h.files[b].format),h.files[b].teacherId!=h.scen.teacherCreator.id){if(h.scen.collaborators)for(var c=0;c<h.scen.collaborators.length;c++)if(h.files[b].teacherId==h.scen.collaborators[c].id){h.files[b].user=h.scen.collaborators[c].firstname+" "+h.scen.collaborators[c].lastname;break}}else h.files[b].user=h.scen.teacherCreator.firstname+" "+h.scen.teacherCreator.lastname},function(a){console.log("ERRORE DOWNLOAD METADATA")})};k(),h.uploadFiles=function(b){h.error="",i=d.upload({url:a.urlTrustedMediaScenarioPost(h.scen.id),headers:{"Content-Type":b.type},file:b}),i.then(function(a){h.showCancelButton=!1,h.showMetaBox=!0,h.newFile.name=a.config.file[0].name,h.newFile.id=a.data.id,k()},function(a){console.log("UPLOAD FAILED"),h.newFile.progress=0,h.error="Upload fallito ("+a.data.message+"). Si prega di riprovare.",h.showCancelButton=!1},function(a){h.showCancelButton=!0,h.showProgressBar=!0,h.newFile.progress=parseInt(100*a.loaded/a.total),h.widthProgressBar=h.newFile.progress+"%"})},h.abortUpload=function(){i.abort()},h.saveMeta=function(){var a={};a.description=h.newFile.description,c.postTrustedMediaMetadata(h.scen.id,h.newFile.id,a).then(function(a){h.showMetaBox=!1,h.showProgressBar=!1;for(var b=0;b<h.files.length;b++)h.files[b].name==h.newFile.id&&(h.files[b].description=h.newFile.description);h.newFile={},h.newFile.progress=0},function(a){console.log("ERRORE UPLOAD METADATA!"),console.log(a)})},h.hideMetaBox=function(){h.showMetaBox=!1,h.showProgressBar=!1,h.newFile={},h.newFile.progress=0},h.getMediaUrl=function(b){return a.urlMedia(b)},h.updateFile=function(a){e.hash("update-description"),f(),e.url(e.path()),h.showMetaBox=!0,h.newFile.name=h.files[a].originalName,h.newFile.id=h.files[a].name,h.newFile.description=h.files[a].description},h.removeFile=function(a){g.showModalDeleteResource(h.files[a]).then(function(b){c.deleteTrustedMedia(h.scen.id,h.files[a].name).then(function(b){h.files.splice(a,1)},function(a){})},function(a){console.log("errore")})}}]),angular.module("smiled.application").controller("scenarioSocialGraphCtrl",[function(){}]),angular.module("smiled.application").controller("scenarioStorylineCtrl",["apiService","$scope","CONSTANTS","Lightbox",function(a,b,c,d){var e=this;e.posts=[],e.date={};var f=3,g=!0;e.showFromEnd=!0;var h=c.numberOfPostForScroll;e.busy=!1;var i=!1;e.nextPost=function(){e.busy||i||(e.busy=!0,0==e.posts.length?j():j(e.posts[e.posts.length-1].julianDayNumber,e.posts[e.posts.length-1].timeNumber))};var j=function(d,j){a.getLastHistoricPosts(b.scenario.scen.id,h,g,d,j).then(function(a){var d=a;if(0==d.length)return void(i=!0);for(var g=0;g<d.length;g++){if(d[g].character&&d[g].character.id){d[g].character.cover=c.urlCharacterCover(b.scenario.scen.id,d[g].character.id);for(var h=0;h<d[g].likes.length;h++)if(d[g].likes[h].id==d[g].character.id){d[g].youLike=!0;break}}else d[g].character={},d[g].character.name="Narratore",d[g].character.cover="assets/public/img/narr.png",d[g].isEvent=!0;if(d[g].comments)for(var h=0;h<d[g].comments.length;h++)d[g].comments[h].character.cover=c.urlCharacterCover(b.scenario.scen.id,d[g].comments[h].character.id);if(d[g].imagesMetadata){d[g].media=new Array,d[g].media[0]=new Array;for(var j=-1,k=0,h=0;h<d[g].imagesMetadata.length;h++)0!=h&&h%f==0?(j=0,k++,d[g].media[k]=new Array):j++,d[g].media[k][j]=c.urlMediaThumb(d[g].imagesMetadata[h].id),d[g].imagesMetadata[h].url=c.urlMedia(d[g].imagesMetadata[h].id)}e.posts.push(angular.copy(d[g]))}e.busy=!1},function(a){console.log("errore"),e.busy=!1})};e.switchOrder=function(a){g=!g,e.posts=[],e.busy=!1,i=!1,e.nextPost()},e.getPosition=function(a){return a%2==0?"timeline-inverted":""};var k=function(a){return c.monthString(a)},l=function(a,b){var c=a+68569,d=parseInt(4*c/146097);c-=parseInt((146097*d+3)/4);var e=parseInt(4e3*(c+1)/1461001);c=c-parseInt(1461*e/4)+31;var f=parseInt(80*c/2447);b.day=c-parseInt(2447*f/80),c=parseInt(f/11),b.month=f+2-12*c,b.year=100*(d-49)+e+c,b.dow=a%7},m=function(a,b){b.hours=parseInt(a/3600),a%=3600,b.minutes=parseInt(a/60),a%=60,b.seconds=a};e.formatDate=function(a,b){l(a,e.date);var c=e.date.year>0?"":" A.C.",d=k(e.date.month)+" "+Math.abs(e.date.year)+c;d=e.date.day+" "+d;var f={};return m(b,f),d+=" "+f.hours+":",d+=f.minutes<10?"0"+f.minutes:f.minutes},e.realDateFormatWithHour=c.realDateFormatWithHour,e.getMediaUrl=function(a){return CONSNTANTS.urlMedia(a)},e.openPostGallery=function(a,b,c){var e=b*f+c;a.media&&d.openModal(a.imagesMetadata,e)}}]),angular.module("smiled.application").controller("scenarioWizardCtrl",["apiService","$stateParams","$state","$location","$scope","$element","userService","Upload","CONSTANTS","$q","modalService","$timeout","alertingGeneric",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this;n.scenario={};var o;n.scenarioServer={},n.associated=[],n.notAssociatedAttendees=[],n.notAssociatedCharacters=[],n.emailList,n.accordionIsDisabled=!0,n.user,n.selectableStudents=[],n.currentCharacters=[],n.charactersServer=[],n.map,n.lastUserClicked=null,n.lastCharacterClicked=null;var p=-1,q=j.defer(),s=b.id;g.getMe().then(function(a){n.user=a;var b=angular.copy(n.user);n.selectableStudents=b.students,q.resolve(),t()}),n.concatNameAndSurname=function(a,b){return a+" "+b},n.isClickedUser=function(a){return!(!n.lastUserClicked||a!=n.lastUserClicked.id)},n.isClickedCharacter=function(a){return!(!n.lastCharacterClicked||a!=n.lastCharacterClicked.id)},n.userClicked=function(a){n.lastUserClicked&&a.id==n.lastUserClicked.id?n.lastUserClicked=null:(n.lastUserClicked=a,null!=n.lastCharacterClicked&&(n.createAssociationWithoutDrag(),n.lastUserClicked=null,n.lastCharacterClicked=null))},n.characterClicked=function(a){n.lastCharacterClicked&&a.id==n.lastCharacterClicked.id?n.lastCharacterClicked=null:(n.lastCharacterClicked=a,null!=n.lastUserClicked&&(n.createAssociationWithoutDrag(),n.lastUserClicked=null,n.lastCharacterClicked=null))};var t=function(){null==s?n.title="Crea nuovo scenario":(n.charging=!0,a.getScenario(s).then(function(a){n.scenarioServer=a,n.scenario=angular.copy(a),n.title=a.name,y(),v(),w(),u()},function(a){console.log("errore"),c.go("logged.dashboard")}),n.scenarioCover=i.urlScenarioCover(s))};n.isScenarioActive=function(){return"ACTIVE"==n.scenario.status};var u=function(){a.getAllCharactersFromScen(s).then(function(a){if(n.scenario.characters)for(var b=0;b<n.scenario.characters.length;b++)for(var c=0;c<a.length;c++)if(a[c].id==n.scenario.characters[b].id){a[c].bornDate||(a[c].bornDate={},a[c].bornDate.afterChrist=!0),a[c].deadDate||(a[c].deadDate={},a[c].deadDate.afterChrist=!0),n.charactersServer[b]=a[c],n.currentCharacters[b]=angular.copy(a[c]),a.splice(c,1);break}n.accordionIsDisabled=!1},function(a){console.log("errore")})},v=function(){if(n.scenario.characters)for(var a=0;a<n.scenario.characters.length;a++)n.scenario.characters[a].cover=i.urlCharacterCover(s,n.scenario.characters[a].id),n.scenarioServer.characters[a].cover=i.urlCharacterCover(s,n.scenario.characters[a].id);if(n.scenario.attendees)for(var a=0;a<n.scenario.attendees.length;a++)n.scenario.attendees[a].cover=i.urlUserCover(n.scenario.attendees[a].id),n.scenarioServer.attendees[a].cover=i.urlUserCover(n.scenario.attendees[a].id);if(n.scenario.collaborators)for(var a=0;a<n.scenario.collaborators.length;a++)n.scenario.collaborators[a].cover=i.urlUserCover(n.scenario.collaborators[a].id),n.scenarioServer.collaborators[a].cover=i.urlUserCover(n.scenario.collaborators[a].id);n.scenario.teacherCreator.cover=i.urlUserCover(n.scenario.teacherCreator.id),n.scenarioServer.teacherCreator.cover=i.urlUserCover(n.scenario.teacherCreator.id),n.map=i.urlMedia(n.scenario.history.mapId)},w=function(){var a=!1,b=new Array;if(n.scenario.attendees&&(b=angular.copy(n.scenario.attendees)),n.scenario.collaborators&&(b=b.concat(n.scenario.collaborators)),n.scenario.characters)for(var c=0;c<n.scenario.characters.length;c++)if(null==n.scenario.characters[c].userId)n.notAssociatedCharacters.push(n.scenario.characters[c]);else if(n.scenario.characters[c].userId==n.scenario.teacherCreator.id){var d={};d.character=n.scenario.characters[c],d.attendee=n.scenario.teacherCreator,n.associations.push(d),a=!0}else if(b)for(var e=0;e<b.length;e++)if(b[e].id==n.scenario.characters[c].userId){var d={};d.character=n.scenario.characters[c],d.attendee=b[e],n.associations.push(d),b.splice(e,1);break}n.notAssociatedAttendees=b,a||n.notAssociatedAttendees.push(n.scenario.teacherCreator)};n.showPopUpDeleteScenario=function(){null!=n.scenario&&k.showModalDeleteScen(n.scenario)},n.showPopUpDeleteAttendee=function(a){k.showModalDeleteAttendee(a).then(function(a){a.firstname?n.deleteAttendee(a):n.deleteInvited(a),m.addSuccess("Partecipante rimosso")},function(a){console.log("Errore - Rimozione partecipante annullata")})},n.showPopUpDeleteCollaborator=function(a){k.showModalDeleteCollaborator(a).then(function(a){n.deleteCollaborator(a),m.addSuccess("Collaboratore rimosso")},function(a){console.log("Rimozione collaboratore annullata")})},n.showPopUpDeleteCharacter=function(a){k.showModalDeleteCharacter(a).then(function(b){n.deleteCharacter(a),m.addSuccess("Personaggio rimosso")},function(a){console.log("Rimozione personaggio annullata")})};var x=function(a){n.selectableStudents.push(a)},y=function(){if(n.scenarioServer&&n.scenarioServer.attendees&&n.selectableStudents)for(var a=0;a<n.scenarioServer.attendees.length;a++)for(var b=0;b<n.selectableStudents.length;b++)n.scenarioServer.attendees[a].id==n.selectableStudents[b].id&&n.selectableStudents.splice(b,1)};n.getPagedTeacherByRegex=function(b){return a.getPagedTeacherByRegex(0,10,b).then(function(a){return z(a.content)},function(a){console.log("failed to get paged teacher by regex"),console.log(a)})};var z=function(a){var b=!1;if(a)for(var c=0;c<a.length;c++)if(b=!1,a[c].id!=n.user.id){if(null!=n.scenario.collaborators)for(var d=0;d<n.scenario.collaborators.length;d++)if(a[c].id==n.scenario.collaborators[d].id){a.splice(c,1),b=!0;break}}else a.splice(c,1);return a};n.exitWizard=function(){n.saveInfo(),n.checkOpenAccordion()},n.saveInfo=function(){var b={};b.name=n.scenario.name,b.description=n.scenario.description,b.history=n.scenario.history,b.showRelationsToAll=n.scenario.showRelationsToAll,null==s?(b.showRelationsToAll=!0,I()?a.createScenario(b).then(function(a){s=a.id},function(a){console.log("Errore creazione scenario")}):console.log("fail infoValidate")):!G(n.scenario,n.scenarioServer)&&I()&&a.updateScenario(b,s).then(function(a){n.scenarioServer=a,n.scenario=angular.copy(a),v(),m.addSuccess("Scenario modificato")},function(a){m.addWarning("Modifica scenario fallita")})},n.inviteStudents=function(){var b=K(n.emailList);console.log(b);var c=[];if(b)for(var d=0;d<b.length;d++)c.push({email:b[d]});c&&c.length>0&&null!=s?a.addUsersToScenario(c,s).then(function(a){var b=c.length-a.length;1==a.length?1==c.length?m.addSuccess("Studente invitato correttamente"):1==b?m.addSuccess(a.length+" studente invitato correttamente. (Non e'stato possibile invitare "+b+" studente)"):m.addSuccess(a.length+" studente invitato correttamente. (Non e'stato possibile invitare "+b+" studenti)"):a.length>1&&(0==b?m.addSuccess("Tutti gli studenti sono stati invitati correttamente"):1==b?m.addSuccess(a.length+" studenti invitati correttamente. (Non e'stato possibile invitare "+b+" studente)"):m.addSuccess(a.length+" studenti invitati correttamente. (Non e'stato possibile invitare "+b+" studenti)"));for(var d=0;d<a.length;d++)null!=a[d].firstname?(a[d].cover=i.urlUserCover(a[d].id),null!=n.scenarioServer.attendees&&""!=n.scenarioServer.attendees||(n.scenarioServer.attendees=new Array),n.scenarioServer.attendees.push(a[d]),n.notAssociatedAttendees.push(angular.copy(a[d]))):(null!=n.scenarioServer.invited&&""!=n.scenarioServer.invited||(n.scenarioServer.invited=new Array),n.scenarioServer.invited.push(a[d]));n.emailList=null,a.length>0?y():1==c.length?m.addWarning("Non e' stato possibile invitare l'utente associato alla mail inserita"):m.addWarning("Non e' stato possibile invitare nessuno degli utenti associati alle mail inserite")},function(a){console.log(a)}):(m.addWarning("Inserire almeno una email valida"),n.emailList=null)},n.uploadCover=function(a){a&&a.length&&h.upload({url:i.urlScenarioCover(s),headers:{"Content-Type":a.type},file:a}).success(function(a,b,c,d){var e=new Date;n.scenarioCover=i.urlScenarioCover(s)+"?"+e.toString()})},n.uploadCharacterCover=function(a,b,c){a&&a.length&&c&&h.upload({url:i.urlCharacterCover(s,c),headers:{"Content-Type":a.type},file:a}).success(function(a,b,d,e){for(var f=0;f<n.scenario.characters.length;f++)if(n.scenario.characters[f].id==c){var g=new Date;n.scenario.characters[f].cover=i.urlCharacterCover(s,c)+"?"+g.toString()}})},n.addCharacter=function(){n.newCharacter&&n.newCharacter.name.length>2&&a.addCharacterToScenario(n.newCharacter,s).then(function(a){var b=angular.copy(n.newCharacter.name);n.newCharacter.id=a.id,null!=n.scenario.characters&&""!=n.scenario.characters||(n.scenario.characters=new Array),n.newCharacter.cover=i.urlCharacterCover(s,n.newCharacter.id),n.newCharacter.isOpen=!1,n.newCharacter.isSync=!1,n.scenario.characters.push(angular.copy(n.newCharacter)),n.newCharacter.isOpen=null,n.newCharacter.isSync=null,n.newCharacter.bornDate={},n.newCharacter.bornDate.afterChrist=!0,n.newCharacter.deadDate={},n.newCharacter.deadDate.afterChrist=!0,n.charactersServer.push(angular.copy(n.newCharacter)),n.currentCharacters.push(angular.copy(n.newCharacter)),n.notAssociatedCharacters.push(angular.copy(n.newCharacter)),n.newCharacter.cover=null,n.newCharacter.name="",n.newCharacter.id=null,m.addSuccess("Il personaggio "+b+" e' stato creato correttamente")},function(a){m.addWarning("Non è stato possibile creare il personaggio "+n.newCharacter.name)})};var A=function(a,b){current=angular.copy(b),n.currentCharacters[a].name=current.name,n.currentCharacters[a].nickname=current.nickname,n.currentCharacters[a].bornDate=current.bornDate,n.currentCharacters[a].deadDate=current.deadDate,n.currentCharacters[a].bornTown=current.bornTown,n.currentCharacters[a].deadTown=current.deadTown,n.currentCharacters[a].description=current.description,n.currentCharacters[a].quote=current.quote,n.currentCharacters[a].gender=current.gender,n.currentCharacters[a].role=current.role};n.openAccordion=function(b){if(!n.accordionIsDisabled)if(-1!=p)if(L(n.currentCharacters[p],n.charactersServer[p]))if(M(n.currentCharacters[p])){b!=p&&A(b,n.charactersServer[b]);var c=angular.copy(n.currentCharacters[p]);B(c),a.updateCharacter(s,c,n.charactersServer[p].id).then(function(a){n.charactersServer[p]=a;var c=angular.copy(n.scenario.characters[p].cover);if(n.scenario.characters[p]=angular.copy(n.charactersServer[p]),n.scenario.characters[p].cover=c,a.bornDate||(n.scenario.characters[p].bornDate={},n.scenario.characters[p].bornDate.afterChrist=!0),a.deadDate||(n.scenario.characters[p].deadDate={},n.scenario.characters[p].deadDate.afterChrist=!0),null!=n.scenario.characters[p].userId){for(var d=0;b<n.associations.length;d++)if(n.associations[d].character.id==n.scenario.characters[p].id){n.associations[d].character.name=n.scenario.characters[p].name;break}}else for(var e=0;e<n.notAssociatedCharacters.length;e++)if(n.notAssociatedCharacters[e].id==n.scenario.characters[p].id){n.notAssociatedCharacters[e].name=n.scenario.characters[p].name;break}p=p!=b?b:-1,m.addSuccess("Il personaggio "+a.name+" e' stato modificato correttamente")},function(a){m.addWarning("Non e' stato possibile modificare il personaggio ");var b=angular.copy(n.currentCharacters[p].cover);n.currentCharacters[p]=angular.copy(n.charactersServer[p]);n.currentCharacters[p].cover=b})}else{m.addWarning("Non e' stato possibile modificare il personaggio");var d=angular.copy(n.currentCharacters[p].cover);n.currentCharacters[p]=angular.copy(n.charactersServer[p]),n.currentCharacters[p].cover=d,p=p!=b?b:-1}else p=p!=b?b:-1;else p=b};var B=function(a){!a.bornDate||a.bornDate.year||a.bornDate.month||a.bornDate.day||(a.bornDate=null),!a.deadDate||a.deadDate.year||a.deadDate.month||a.deadDate.day||(a.deadDate=null)};n.addCollaborator=function(b){a.addCollaboratorToScenario(b.id,s).then(function(a){null==n.scenarioServer.collaborators&&(n.scenarioServer.collaborators=new Array),n.scenarioServer.collaborators.push(a),n.selectedCollaborator="",null==n.scenario.collaborators&&(n.scenario.collaborators=new Array),n.scenario.collaborators.push(angular.copy(a)),null==n.notAssociatedAttendees&&(n.notAssociatedAttendees=new Array);var b=angular.copy(a);m.addSuccess(b.firstname+" "+b.lastname+" aggiunto correttamente"),b.cover=i.urlUserCover(a.id),n.notAssociatedAttendees.push(b)},function(a){m.addWarning("Errore nell'aggiunta del collaboratore. Operazione consentita solo al creatore dello scenario.")})},n.addAttendee=function(b){var c=[];c.push({email:b.email}),a.addUsersToScenario(c,s).then(function(a){for(var c=0;c<a.length;c++)null!=a[c].firstname?(a[c].cover=i.urlUserCover(a[c].id),null!=n.scenarioServer.attendees&&""!=n.scenarioServer.attendees||(n.scenarioServer.attendees=new Array),n.scenarioServer.attendees.push(a[c]),n.notAssociatedAttendees.push(angular.copy(a[c]))):(null!=n.scenarioServer.invited&&""!=n.scenarioServer.invited||(n.scenarioServer.invited=new Array),n.scenarioServer.invited.push(a[c]));n.emailList=null,n.selectedUser="",m.addSuccess(b.firstname+" "+b.lastname+" aggiunto correttamente");for(var d=0;d<n.selectableStudents.length;d++)n.selectableStudents[d].id==b.id&&n.selectableStudents.splice(d,1)},function(a){1==c.length&&m.addWarning("Errore nell'aggiunta del partecipante")})},n.enterInScenario=function(){n.exitWizard(),c.go("logged.scenario.posts",{id:s})},n.deleteAttendee=function(b){a.removeUserFromScenario(s,b.id).then(function(a){for(var c=0;c<n.scenarioServer.attendees.length;c++)n.scenarioServer.attendees[c].id==b.id&&(n.scenarioServer.attendees.splice(c,1),n.scenario.attendees.splice(c,1));x(b),D(b)},function(a){m.addWarning("Errore nella rimozione del partecipante."),console.log("Delete attendee failed: "+a)})},n.deleteCollaborator=function(b){
a.removeCollaboratorFromScenario(s,b.id,!1).then(function(a){for(var c=0;c<n.scenarioServer.collaborators.length;c++)n.scenarioServer.collaborators[c].id==b.id&&n.scenarioServer.collaborators.splice(c,1),n.scenario.collaborators[c].id==b.id&&n.scenario.collaborators.splice(c,1);D(b)},function(a){m.addWarning("Errore nella rimozione del collaboratore. Operazione consentita solo al creatore dello scenario."),console.log("Delete collaborator failed: "+a)})},n.deleteInvited=function(b){a.removeUserFromScenario(s,b.id).then(function(a){for(var c=0;c<n.scenarioServer.invited.length;c++)n.scenarioServer.invited[c].id==b.id&&n.scenarioServer.invited.splice(c,1)},function(a){console.log("Delete invited user failed: "+a)})},n.deleteCharacter=function(b){a.removeCharacterFromScenario(s,b.id).then(function(a){for(var c=0;c<n.scenario.characters.length;c++)n.scenario.characters[c].id==b.id&&(n.scenario.characters.splice(c,1),n.charactersServer.splice(c,1),n.currentCharacters.splice(c,1),n.scenarioServer.characters.splice(c,1),E(b),p=-1)},function(a){console.log("Delete character failed: "+a)})};var C,D=function(a){if(n.notAssociatedAttendees)for(var b=0;b<n.notAssociatedAttendees.length;b++)if(n.notAssociatedAttendees[b].id==a.id)return void n.notAssociatedAttendees.splice(b,1);if(n.associations)for(var c=0;c<n.associations.length;c++)if(n.associations[c].attendee.id==a.id){n.notAssociatedCharacters.push(n.associations[c].character),n.associations.splice(c,1);break}},E=function(a){if(n.notAssociatedCharacters)for(var b=0;b<n.notAssociatedCharacters.length;b++)if(n.notAssociatedCharacters[b].id==a.id)return void n.notAssociatedCharacters.splice(b,1);if(n.associations)for(var c=0;c<n.associations.length;c++)if(n.associations[c].character.id==a.id){n.notAssociatedAttendees.push(n.associations[c].attendee),n.associations.splice(c,1);break}};n.associations=new Array,n.createAssociationWithoutDrag=function(){var b={};b.attendee=n.lastUserClicked,b.character=n.lastCharacterClicked,a.addUserToCharacter(s,b.attendee.id,b.character.id).then(function(a){if(n.associations.push(angular.copy(b)),n.notAssociatedAttendees)for(var c=0;c<n.notAssociatedAttendees.length;c++)if(n.notAssociatedAttendees[c].id==b.attendee.id){n.notAssociatedAttendees.splice(c,1);break}if(n.notAssociatedCharacters)for(var c=0;c<n.notAssociatedCharacters.length;c++)if(n.notAssociatedCharacters[c].id==b.character.id){n.notAssociatedCharacters.splice(c,1);break}},function(a){console.log("Association failed: "+a)})},n.dropSuccessHandlerCharacter=function(b,c){var d={};d.attendee=n.notAssociatedAttendees[c],d.character=n.notAssociatedCharacters[C],a.addUserToCharacter(s,d.attendee.id,d.character.id).then(function(a){n.associations.push(angular.copy(d)),n.notAssociatedAttendees.splice(c,1),n.notAssociatedCharacters.splice(C,1)},function(a){console.log("Association failed: "+a)})},n.dropSuccessHandlerAttendee=function(b,c){var d={};d.attendee=n.notAssociatedAttendees[C],d.character=n.notAssociatedCharacters[c],a.addUserToCharacter(s,d.attendee.id,d.character.id).then(function(a){n.associations.push(angular.copy(d)),n.notAssociatedAttendees.splice(C,1),n.notAssociatedCharacters.splice(c,1)},function(a){console.log("Association failed: "+a)})},n.onDrop=function(a,b,c){C=c},n.removeAssociation=function(b){for(var c=b.character,d=b.attendee,e=0;e<n.associations.length;e++)if(n.associations[e].attendee.id==b.attendee.id){a.removeUserFromCharacter(s,d.id,c.id).then(function(a){n.notAssociatedAttendees.push(d),n.notAssociatedCharacters.push(c),n.associations.splice(e,1)},function(a){console.log("Removing asssociation failed:"+a)});break}},n.openScenario=function(){n.exitWizard();var b={status:"ACTIVE"};a.updateScenario(b,s).then(function(a){n.scenarioServer=a,c.go("logged.scenario.posts",{id:s})},function(a){console.log("C'è stato un problema, impossibile attivare lo scenario")})},n.closeScenario=function(){n.exitWizard()},n.suspendScenario=function(){console.log("sospensione scenario da implementare")},n.showPopUpSetDate=function(a){k.showPopUpSetDate(n.scenario,a)},n.isStudent=function(a){return"Student"==a.type},n.uploadMap=function(b){b&&b.length&&h.upload({url:i.urlPostMedia(n.scenario.id),headers:{"Content-Type":b.type},file:b}).success(function(b,c,d,e){n.scenario.history.mapId=b.id;var f={};f.history={},f.history.mapId=b.id,a.updateScenario(f,n.scenario.id).then(function(a){n.scenarioServer=a},function(a){console.log("ERROR UPLOAD MAP")});var g=new Date;n.map=i.urlMedia(b.id)+"?"+g.toString()})},n.showDeadDatePicker=!1,n.switchShowDeadDate=function(){!n.showDeadDatePicker&&n.showBornDatePicker&&(n.showBornDatePicker=!1),n.showDeadDatePicker=!n.showDeadDatePicker},n.showBornDatePicker=!1,n.switchShowBornDate=function(){!n.showBornDatePicker&&n.showDeadDatePicker&&(n.showDeadDatePicker=!1),n.showBornDatePicker=!n.showBornDatePicker},n.hideDatePicker=function(){n.showDeadDatePicker=!1,n.showBornDatePicker=!1};var F=function(){var a=d.path(),b=a.substr(a.lastIndexOf("/")+1);"info"==b?o=0:"attendees"==b?o=1:"characters"==b?o=2:"associations"==b?o=3:"collaborators"==b&&(o=4)};n.checkOpenAccordion=function(){if(n.scenario.characters)for(var a=0;a<n.scenario.characters.length;a++)if(n.scenario.characters[a].isOpen){n.openAccordion(a);break}},n.changeStateTab=function(a){switch(o){case 0:o=a,n.saveInfo();break;case 1:o=a;break;case 2:n.checkOpenAccordion(),o=a;break;case 3:o=a;break;case 4:o=a}};var G=function(a,b){return a.name!=b.name?!1:a.description!=b.description?!1:(r=angular.equals(a.history.startDate,b.history.startDate),0==r?!1:(r=angular.equals(a.history.endDate,b.history.endDate),0==r?!1:a.showRelationsToAll==b.showRelationsToAll))},H=function(){return n.scenario.history&&n.scenario.history.startDate.year&&!N(n.scenario.history.startDate.year)?(m.addWarning("Data non valida"),n.scenario=angular.copy(n.scenarioServer),!1):n.scenario.history&&n.scenario.history.endDate.year&&!N(n.scenario.history.endDate.year)?(m.addWarning("Data non valida"),n.scenario=angular.copy(n.scenarioServer),!1):n.scenario.history&&n.scenario.history.startDate&&n.scenario.history.endDate&&!J(n.scenario.history.startDate,n.scenario.history.endDate)?(n.scenario=angular.copy(n.scenarioServer),!1):!0},I=function(){if(!H())return!1;var a=!0;return(!n.scenario.name||n.scenario.name.length<2)&&(m.addWarning("Il nome dello scenario deve essere di almeno 2 caratteri"),a=!1,n.scenario=angular.copy(n.scenarioServer)),n.scenario.history&&n.scenario.history.startDate&&!n.scenario.history.startDate.afterChrist&&parseInt(n.scenario.history.startDate.year)>4712?(m.addWarning("La minima data rappresentabile e': 1 gennaio 4712 AC"),!1):(n.scenario.history&&n.scenario.history.startDate||(a=!1,n.scenarioServer.history&&n.scenarioServer.history.startDate?n.scenario.history.startDate=angular.copy(n.scenarioServer.history.startDate):n.scenario.history.startDate=""),n.scenario.history&&n.scenario.history.endDate||(a=!1,n.scenarioServer.history&&n.scenarioServer.history.endDate?n.scenario.history.endDate=angular.copy(n.scenarioServer.history.endDate):n.scenario.history.endDate=""),n.scenario.history&&n.scenario.history.startDate&&n.scenario.history.endDate&&n.scenario.history.startDate>n.scenario.history.endDate&&(a=!1,n.scenarioServer.history&&n.scenarioServer.history.endDate?n.scenario.history.endDate=angular.copy(n.scenarioServer.history.endDate):n.scenario.history.endDate="",n.scenarioServer.history&&n.scenarioServer.history.startDate?n.scenario.history.startDate=angular.copy(n.scenarioServer.history.startDate):n.scenario.history.startDate=""),a)},J=function(a,b){return a.afterChrist&&b.afterChrist?a.year>b.year?(m.addWarning("La data di inizio deve precedere quella di fine"),!1):a.year<b.year?!0:a.month>b.month?(m.addWarning("La data di inizio deve precedere quella di fine"),!1):a.month<b.month?!0:a.day>b.day?(m.addWarning("La data di inizio deve precedere quella di fine"),!1):(a.day<b.day,!0):a.afterChrist||b.afterChrist?!a.afterChrist&&b.afterChrist?!0:(m.addWarning("La data di inizio deve precedere quella di fine"),!1):a.year<b.year?(m.addWarning("La data di inizio deve precedere quella di fine"),!1):a.year>b.year?!0:a.month>b.month?(m.addWarning("La data di inizio deve precedere quella di fine"),!1):a.month<b.month?!0:a.day>b.day?(m.addWarning("La data di inizio deve precedere quella di fine"),!1):(a.day<b.day,!0)},K=function(a){return a.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi)},L=function(a,b){if(a.name!=b.name)return!0;if(a.nickname!=b.nickname)return!0;if(a.bornDate&&b.bornDate){if(a.bornDate.day!=b.bornDate.day)return!0;if(a.bornDate.month!=b.bornDate.month)return!0;if(a.bornDate.year!=b.bornDate.year)return!0;if(a.bornDate.afterChrist!=b.bornDate.afterChrist)return!0}if(a.deadDate&&b.deadDate){if(a.deadDate.day!=b.deadDate.day)return!0;if(a.deadDate.month!=b.deadDate.month)return!0;if(a.deadDate.year!=b.deadDate.year)return!0;if(a.deadDate.afterChrist!=b.deadDate.afterChrist)return!0}return a.bornTown!=b.bornTown?!0:a.deadTown!=b.deadTown?!0:a.description!=b.description?!0:a.quote!=b.quote?!0:a.gender!=b.gender?!0:a.role!=b.role},M=function(a){return a.deadDate.year&&!N(a.deadDate.year)?!1:a.bornDate.year&&!N(a.bornDate.year)?!1:!(a.deadDate&&a.bornDate&&a.deadDate.year&&a.bornDate.year)||J(a.bornDate,a.deadDate)},N=function(a){return!isNaN(a)};F()}]),angular.module("smiled.application").controller("scenariosListCtrl",["loggedUser","CONSTANTS","modalService",function(a,b,c){var d=this;d.user=a,d.realDateWithHour=b.realDateFormatWithHour,d.realDateWithoutHour=b.realDateFormatWithoutHour,d.showPopUpCreationScenario=function(){c.showModalCreateScen()}}]),angular.module("smiled.application").controller("setPasswordCtrl",["userService","$state","alertingRegistration","$timeout",function(a,b,c,d){var e=this;e.user={},e.dateOptions={regional:"it",changeYear:!0,maxDate:"0",minDate:new Date(1900,0,1,0,0,0,0),yearRange:"1900:c"},e.confirmRegister=function(){f()?a.changeFirstPassword(e.user).then(function(a){console.log("success register"),e.user.email="",e.user.firstname="",e.user.lastname="",e.user.bornDate="",e.user.newPassword="",e.user.confirmPassword="",c.addSuccess("La tua richiesta e' stata accettata. A breve riceverai una mail per confermare la tua registrazione"),d(function(){b.go("notLogged.login")},5e3)},function(a){throw e.user.email="",e.user.firstname="",e.user.lastname="",e.user.bornDate="",e.user.oldPassword="",e.user.newPassword="",e.user.confirmPassword="",c.addDanger("Non e' stato possibile completare la registrazione, ti preghiamo di riprovare!"),new Error("Non e' stato possibile completare la registrazione, ti preghiamo di riprovare!")}):(e.user.oldPassword="",e.user.newPassword="",e.user.confirmPassword="")};var f=function(){return null==e.user.email||""==e.user.email||null==e.user.firstname||""==e.user.firstname||null==e.user.lastname||""==e.user.lastname||null==e.user.oldPassword||""==e.user.oldPassword||null==e.user.newPassword||""==e.user.newPassword||null==e.user.confirmPassword||""==e.user.confirmPassword?(c.addWarning("Compilare tutti i campi!"),!1):g(e.user.email)?e.user.newPassword!=e.user.confirmPassword?(c.addWarning("Attenzione le due password digitate non corrispondono!"),!1):e.user.newPassword.length<8?(c.addWarning("Nuova password troppo corta!"),!1):e.user.oldPassword.length<8?(c.addWarning("Vecchia password troppo corta!"),!1):!0:(c.addWarning("Email non valida!"),!1)},g=function(a){var b=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{1,6}(?:\.[a-z]{1})?)$/i;return b.test(a)}}]),angular.module("smiled.application").controller("shellCtrl",["$scope","$location","userService","$state",function(a,b,c,d){if(c.isLogged)switch(b.path()){case"/":d.go("logged");break;case"/dashboard":d.go("logged");break;default:d.go("notFound")}else d.go("login")}]),angular.module("smiled.application").controller("singlePostCtrl",["$state","$stateParams","CONSTANTS","$scope","apiService","Upload","$interval","notifyService",function(a,b,c,d,e,f,g,h){var i=this;i.scen=d.scenario.scen,i.currentCharacter=d.scenario.currentCharacter,i.post={};var j=b.idPost,k=b.id;i.postReady=!1;var l=function(){k&&""!=k?j&&""!=j?i.post=e.getSingleStatus(k,j).then(function(a){i.post=a,i.postReady=!0},function(a){i.post={},i.postReady=!1,console.log("Errore. C'è stato qualche problema nel download del post")}):a.go("logged.scenario.posts",{id:k}):a.go("logged.dashboard")};l()}]),angular.module("smiled.application").controller("studentsListCtrl",["loggedUser",function(a){var b=this;b.user=a}]),angular.module("smiled.application").controller("toolMapCtrl",["CONSTANTS",function(a){var b=this;b.Win64="MapTool-Windows_x64.zip",b.Win32="MapTool-Windows_x86.zip",b.Mac="MapTool-MacOSX.zip",b.Tux64="MapTool-linux_x64.zip",b.Tux32="MapTool-linux_x86.zip",b.getFile=function(b){return a.urlToolMap(b)}}]),angular.module("smiled.application").controller("updateScenarioCtrl",["apiService",function(a){function b(a){return l=[],l}var c=this;c.scenario={};var d={},e={};c.showHideContent=function(a){var f=$("#basicinfobox"),g=$("#studentsbox"),h=$("#charactersbox"),i=$("#associationbox"),j=$("#collaboratorsbox");f.is(a.target)||0!==f.has(a.target).length?c.basicinfoboxOn=!0:(c.basicinfoboxOn=!1,null==c.scenario.startDate||null==c.scenario.endDate||null==c.scenario.title||(d.title=c.scenario.title,d.startDate=c.scenario.startDate,d.endDate=c.scenario.endDate)),g.is(a.target)||0!==g.has(a.target).length?c.studentsboxOn=!0:(null==c.scenario.listEmail||(e=b(c.scenario.listEmail)),c.studentsboxOn=!1),h.is(a.target)||0!==h.has(a.target).length?c.charactersboxOn=!0:c.charactersboxOn=!1,i.is(a.target)||0!==i.has(a.target).length?c.associationboxOn=!0:c.associationboxOn=!1,j.is(a.target)||0!==j.has(a.target).length?c.collaboratorsboxOn=!0:c.collaboratorsboxOn=!1}}]),angular.module("smiled.application").factory("alertingGeneric",["$timeout",function(a){var b=[],c=["success","info","warning","danger"],d=function(a){h("warning",a)},e=function(a){h("danger",a)},f=function(a){h("info",a)},g=function(a){h("success",a)},h=function(c,d){b.length>0&&b.splice(0,1);var e={type:c,message:d};b.push(e),a(function(){i(e)},4e3)},i=function(a){for(var c=0;c<b.length;c++)if(b[c]===a){b.splice(c,1);break}},j=function(){b.length=[]},k=function(a){return function(){e(a)}};return{addWarning:d,addDanger:e,addInfo:f,addSuccess:g,addAlert:h,removeAlert:i,errorHandler:k,currentAlerts:b,alertTypes:c,removeAllAlerts:j}}]),angular.module("smiled.application").factory("alertingLogin",["$timeout",function(a){var b=[],c=["success","info","warning","danger"],d=function(a){h("warning",a)},e=function(a){h("danger",a)},f=function(a){h("info",a)},g=function(a){h("success",a)},h=function(c,d){if(0==b.length){var e={type:c,message:d};b.push(e),a(function(){i(e)},5e3)}},i=function(a){for(var c=0;c<b.length;c++)if(b[c]===a){b.splice(c,1);break}},j=function(a){return function(){e(a)}};return{addWarning:d,addDanger:e,addInfo:f,addSuccess:g,addAlert:h,removeAlert:i,errorHandler:j,currentAlerts:b,alertTypes:c}}]),angular.module("smiled.application").factory("alertingRegistration",["$timeout",function(a){var b=[],c=["success","info","warning","danger"],d=function(a){h("warning",a)},e=function(a){h("danger",a)},f=function(a){h("info",a)},g=function(a){h("success",a)},h=function(c,d){if(0==b.length){var e={type:c,message:d};b.push(e),a(function(){i(e)},5e3)}},i=function(a){for(var c=0;c<b.length;c++)if(b[c]===a){b.splice(c,1);break}},j=function(a){return function(){e(a)}};return{addWarning:d,addDanger:e,addInfo:f,addSuccess:g,addAlert:h,removeAlert:i,errorHandler:j,currentAlerts:b,alertTypes:c}}]),angular.module("smiled.application").factory("alertingScenario",["$timeout","$location","$anchorScroll",function(a,b,c){var d=[],e=["success","info","warning","danger"],f=function(a){j("warning",a)},g=function(a){j("danger",a)},h=function(a){j("info",a)},i=function(a){j("success",a)},j=function(e,f){d.length>0&&d.splice(0,1);var g={type:e,message:f};d.push(g),b.hash("topBox"),c(),b.url(b.path()),a(function(){k(g)},5e3)},k=function(a){for(var b=0;b<d.length;b++)if(d[b]===a){d.splice(b,1);break}},l=function(a){return function(){g(a)}};return{addWarning:f,addDanger:g,addInfo:h,addSuccess:i,addAlert:j,removeAlert:k,errorHandler:l,currentAlerts:d,alertTypes:e}}]),angular.module("smiled.application").factory("apiService",["$http","$q","Restangular",function(a,b,c){function d(a){return e.post("",a)}var e=c.one("register"),f=function(c){var d=b.defer();return a.get("/api/v1/scenarios/"+c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},g=function(c){var d=b.defer();return a.post("/api/v1/scenarios",c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},h=function(c,d){var e=b.defer();return a.put("/api/v1/scenarios/"+d,c).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},i=function(c){var d=b.defer();return a["delete"]("/api/v1/scenarios/"+c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},j=function(c,d){var e=b.defer();return a.post("/api/v1/scenarios/"+d+"/users",c).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},k=function(c,d){var e=b.defer();return a.post("/api/v1/scenarios/"+d+"/collaborators/"+c).then(function(a){e.resolve(a.data)},function(a){console.log(a),e.reject(a)}),e.promise},l=function(c,d){var e=b.defer();return a.post("/api/v1/scenarios/"+d+"/characters",c).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},m=function(c,d,e){var f=b.defer();return a.put("/api/v1/scenarios/"+c+"/characters/"+e,d).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},n=function(c){var d=b.defer();return a.get("/api/v1/scenarios/"+c+"/characters").then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},o=function(c,d){var e=b.defer();return a.get("/api/v1/scenarios/"+c+"/characters/"+d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},p=function(c,d){var e=b.defer();return a["delete"]("/api/v1/scenarios/"+c+"/users/"+d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},q=function(c,d,e){var f=b.defer();return a["delete"]("/api/v1/scenarios/"+c+"/collaborators/"+d,e).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},r=function(c,d){var e=b.defer();return a["delete"]("/api/v1/scenarios/"+c+"/characters/"+d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},s=function(c,d,e){var f=b.defer();return a.put("/api/v1/scenarios/"+c+"/characters/"+e+"/users/"+d).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},t=function(c,d,e){var f=b.defer();return a["delete"]("/api/v1/scenarios/"+c+"/characters/"+e+"/users/"+d).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},u=function(c,d,e){var f=b.defer();return a.post("/api/v1/scenarios/"+c+"/characters/"+d+"/status",e).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},v=function(c,d,e){var f=b.defer();return a.put("/api/v1/scenarios/"+c+"/status/"+d,e).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},w=function(c,d,e){var f=b.defer();return a.put("/api/v1/scenarios/"+c+"/events/"+d,e).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},x=function(c,d){var e=b.defer();return a["delete"]("/api/v1/scenarios/"+c+"/posts/"+d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},y=function(c,d,e,f,g){"undefined"==typeof g&&(g=!0);var h=b.defer();return a.get("/api/v1/scenarios/"+c+"/posts",{params:{nPag:d,nItem:e,historicOrder:f,orderDesc:g}}).then(function(a){h.resolve(a.data)},function(a){h.reject(a)}),h.promise},z=function(c,d,e){var f=b.defer();return a.get("/api/v1/scenarios/"+c+"/posts",{params:{last:d,nItem:e}}).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},A=function(c,d,e,f,g){var h=!1;"undefined"==typeof f&&(h=!0);var i=b.defer();return h?a.get("/api/v1/scenarios/"+c+"/historic-posts",{params:{nItem:d,orderDesc:e}}).then(function(a){i.resolve(a.data)},function(a){i.reject(a)}):a.get("/api/v1/scenarios/"+c+"/historic-posts",{params:{nItem:d,orderDesc:e,date:f,time:g}}).then(function(a){i.resolve(a.data)},function(a){i.reject(a)}),i.promise},B=function(c,d,e,f,g){var h=!1;"undefined"==typeof f&&(h=!0);var i=b.defer();return h?a.get("/api/v1/scenarios/"+c+"/characters/"+d+"/posts",{params:{nItem:e}}).then(function(a){i.resolve(a.data)},function(a){i.reject(a)}):a.get("/api/v1/scenarios/"+c+"/characters/"+d+"/posts",{params:{nItem:e,date:f,time:g}}).then(function(a){i.resolve(a.data)},function(a){i.reject(a)}),i.promise},C=function(c,d){var e=b.defer();return a.post("/api/v1/scenarios/"+c+"/newPosts",d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},D=function(c,d){var e=b.defer();return a.get("/api/v1/getPagedRegistrationRequests",{params:{nPag:c,nItem:d}}).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},E=function(c,d){var e=b.defer();return a.get("/api/v1/log",{params:{nPag:c,nItem:d}}).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},F=function(c,d){var e=b.defer();return a.get("/api/v1/issues",{params:{nPag:c,nItem:d}}).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},G=function(c,d){var e=b.defer();return a.get("/api/v1/suggestions",{params:{nPag:c,nItem:d}}).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},H=function(c,d){var e=b.defer();return a.get("/api/v1/userScenarios",{params:{firstName:c,lastName:d}}).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},I=function(c,d){var e=b.defer();return a.get("/api/v1/teachers",{params:{nPag:c,nItem:d}}).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},J=function(c,d){var e=b.defer();return a.get("/api/v1/students",{params:{nPag:c,nItem:d}}).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},K=function(c,d,e){var f=b.defer();return a.get("/api/v1/scenarios",{params:{nPag:c,nItem:d,orderByCreation:e}}).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},L=function(c,d){var e=b.defer();return a.get("/api/v1/clientException",{params:{nPag:c,nItem:d}}).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},M=function(c,d,e){var f=b.defer();return a.get("/api/v1/searchTeachers",{params:{regex:e,nPag:c,nItem:d}}).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},N=function(c,d){var e=b.defer();return a.get("/api/v1/scenarios/"+c+"/posts/"+d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},O=function(c,d){var e=b.defer();return a.post("/api/v1/scenarios/"+c+"/posts/"+d+"/likes").then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},P=function(c,d,e){var f=b.defer();return a.post("/api/v1/scenarios/"+c+"/posts/"+d+"/comments",e).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},Q=function(c,d,e){var f=b.defer();return a.post("/api/v1/scenarios/"+c+"/posts/"+d+"/metaComments",e).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},R=function(c,d){var e=b.defer();return a.post("/api/v1/scenarios/"+c+"/events",d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},S=function(c){var d=b.defer();return a.post("/api/v1/report",c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},T=function(c){var d=b.defer();return a.post("/api/v1/suggestion",c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},U=function(c,d){var e=b.defer();return a.put("/api/v1/scenarios/"+c+"/mission",d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},V=function(c){var d=b.defer();return a["delete"]("/api/v1/scenarios/"+c+"/mission").then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},W=function(c,d,e){var f=b.defer();return a.put("/api/v1/scenarios/"+c+"/characters/"+d+"/mission",e).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},X=function(c,d){var e=b.defer();return a["delete"]("/api/v1/scenarios/"+c+"/characters/"+d+"/mission").then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},Y=function(c,d,e){var f=b.defer();return a.put("/api/v1/scenarios/"+c+"/media/"+d+"/meta",e).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},Z=function(c){var d=b.defer();return a.get("/api/v1/scenarios/"+c+"/media/trusted/meta").then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},Y=function(c,d,e){var f=b.defer();return a.put("/api/v1/scenarios/"+c+"/media/"+d+"/meta",e).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},Z=function(c){var d=b.defer();return a.get("/api/v1/scenarios/"+c+"/media/trusted/meta").then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},$=function(){var c=b.defer();return a.get("/api/v1/missions").then(function(a){c.resolve(a.data)},function(a){c.reject(a)}),c.promise},_=function(c){var d,e=b.defer();return d=c?"/api/v1/draft?preview=true":"/api/v1/draft",a.get(d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},aa=function(c,d){var e=b.defer();return a["delete"]("/api/v1/scenarios/"+c+"/trustedMedia/"+d).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},ba=function(c,d){var e,f=b.defer();return e=d?"/api/v1/me/media/"+c+"?postId="+d:"/api/v1/me/media/"+c,a["delete"](e).then(function(a){f.resolve(a.data)},function(a){f.reject(a)}),f.promise},ca=function(c,d){var e=b.defer(),f="api/v1/lastNotifications?num="+d+"&old="+c;return a.get(f).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise};return{postRegister:d,createScenario:g,getScenario:f,updateScenario:h,addUsersToScenario:j,removeUserFromScenario:p,addCollaboratorToScenario:k,removeCollaboratorFromScenario:q,addCharacterToScenario:l,updateCharacter:m,getCharacter:o,deleteScenario:i,removeCharacterFromScenario:r,getAllCharactersFromScen:n,addUserToCharacter:s,removeUserFromCharacter:t,getPagedTeacherByRegex:M,sendStatus:u,updateStatus:v,deletePost:x,getPagedPosts:y,getPagedIssues:F,getPagedSuggestions:G,getSingleStatus:N,addLikeToPost:O,sendCommentToPost:P,sendMetaCommentToPost:Q,sendEvent:R,addMissionToScenario:U,addMissionToCharacter:W,deleteMissionToScenario:V,deleteMissionToCharacter:X,postIssue:S,postSuggestion:T,getPagedStudents:J,getPagedTeachers:I,getPagedScenarios:K,getUsersByFirstNameAndLastName:H,updateEvent:w,getPagedExceptions:L,getPagedLogs:E,getPagedRegistrationRequests:D,postTrustedMediaMetadata:Y,getTrustedMediaMetadata:Z,deleteTrustedMedia:aa,getMyMissions:$,getMyDraft:_,deleteMedia:ba,getListOfNewPosts:C,getLastUserNotifications:ca,getLastPosts:z,getLastHistoricPosts:A,getLastCharacterPosts:B}}]),angular.module("smiled.application").constant("CONSTANTS",{realDateFormatWithHour:"d-M-yyyy H:mm",realDateFormatWithSecond:"d-M-yyyy H:mm:ss",realDateFormatWithMinute:"d-M-yyyy H:mm",realDateFormatWithoutHour:"d-M-yyyy",realDateFormatOnlyDay:"d",realDateFormatOnlyMonth:"MMM",insertHistoricalDate:"Data il post",insertHistoricalDateEvent:"Data l'evento",historicalDateOutInterval:"Inserisci una data valida nell'intervallo dello scenario",lengthOfTooltipLikesList:10,visibleComment:3,numberOfPostForScroll:10,basicTeacherCover:"assets/public/img/ic_teacher.png",basicStudentCover:"assets/public/img/ic_student.png",urlMeCover:"api/v1/me/cover",urlMeCoverLarge:"api/v1/me/coverLarge",urlUserCover:function(a){return"api/v1/users/"+a+"/cover"},urlUserCoverLarge:function(a){return"api/v1/users/"+a+"/coverLarge"},urlScenarioCover:function(a){return"api/v1/scenarios/"+a+"/cover"},urlCharacterCover:function(a,b){return"api/v1/scenarios/"+a+"/characters/"+b+"/cover"},urlMediaScenarioPost:function(a){return"api/v1/scenarios/"+a+"/media"},urlTrustedMediaScenarioPost:function(a){return"api/v1/scenarios/"+a+"/trustedMedia"},urlMetaMediaScenarioPost:function(a,b){return"api/v1/scenarios/"+a+"/media/"+b+"/meta"},urlTrustedMediaScenario:function(a){return"api/v1/scenarios/"+a+"/media/trusted/meta"},urlDeleteTrustedMedia:function(a,b){return"api/v1/scenarios/"+a+"/trustedMedia/"+b},urlMedia:function(a){return"api/v1/media/"+a},urlMediaThumb:function(a){return"api/v1/media/"+a+"?thumb=true"},urlPostMedia:function(a){return"api/v1/scenarios/"+a+"/media"},urlPost:function(a,b){return"api/v1/scenarios/"+a+"/posts/"+b},urlToolMap:function(a){return"api/v1/toolMap?version="+a},urlMarker:"assets/public/img/marker.png",monthString:function(a){var b;switch(a){case 1:b="gennaio";break;case 2:b="febbraio";break;case 3:b="marzo";break;case 4:b="aprile";break;case 5:b="maggio";break;case 6:b="giugno";break;case 7:b="luglio";break;case 8:b="agosto";break;case 9:b="settembre";break;case 10:b="ottobre";break;case 11:b="novembre";break;case 12:b="dicembre"}return b},getMonths:function(a){var b=new Array,c={};if("it"==a)c={value:1,name:"gennaio"},b.push(angular.copy(c)),c={value:2,name:"febbraio"},b.push(angular.copy(c)),c={value:3,name:"marzo"},b.push(angular.copy(c)),c={value:4,name:"aprile"},b.push(angular.copy(c)),c={value:5,name:"maggio"},b.push(angular.copy(c)),c={value:6,name:"giugno"},b.push(angular.copy(c)),c={value:7,name:"luglio"},b.push(angular.copy(c)),c={value:8,name:"agosto"},b.push(angular.copy(c)),c={value:9,name:"settembre"},b.push(angular.copy(c)),c={value:10,name:"ottobre"},b.push(angular.copy(c)),c={value:11,name:"novembre"},b.push(angular.copy(c)),c={value:12,name:"dicembre"},b.push(angular.copy(c));else{if("en"!=a)throw new Error("Not supported language");c={value:1,name:"January"},b.push(angular.copy(c)),c={value:2,name:"February"},b.push(angular.copy(c)),c={value:3,name:"March"},b.push(angular.copy(c)),c={value:4,name:"April"},b.push(angular.copy(c)),c={value:5,name:"May"},b.push(angular.copy(c)),c={value:6,name:"June"},b.push(angular.copy(c)),c={value:7,name:"July"},b.push(angular.copy(c)),c={value:8,name:"Agoust"},b.push(angular.copy(c)),c={value:9,name:"September"},b.push(angular.copy(c)),c={value:10,name:"October"},b.push(angular.copy(c)),c={value:11,name:"November"},b.push(angular.copy(c)),c={value:12,name:"December"},b.push(angular.copy(c))}return b},getDays:function(a){var b,c=new Array;b=1==a||3==a||5==a||7==a||8==a||10==a||12==a?31:2==a?28:30;for(var d=1;b>=d;d++){var e={value:d};c.push(e)}return c},dayOfWeekString:function(a){var b="";switch(a){case 0:b="Lun";break;case 1:b="Mar";break;case 2:b="Mer";break;case 3:b="Gio";break;case 4:b="Ven";break;case 5:b="Sab";break;case 6:b="Dom"}return b}}),angular.module("smiled.application").factory("dateUtil",["CONSTANTS",function(a){var b=function(a,b){var c=a+68569,d=parseInt(4*c/146097);c-=parseInt((146097*d+3)/4);var e=parseInt(4e3*(c+1)/1461001);c=c-parseInt(1461*e/4)+31;var f=parseInt(80*c/2447);b.day=c-parseInt(2447*f/80),c=parseInt(f/11),b.month=f+2-12*c,b.year=100*(d-49)+e+c,b.dow=a%7},c=function(a){console.log("dateToJulianNumber: "+a.year);var b=parseInt(1461*(a.year+4800+parseInt((a.month-14)/12))/4)+parseInt(367*(a.month-2-12*parseInt((a.month-14)/12))/12)-parseInt(3*parseInt((a.year+4900+parseInt((a.month-14)/12))/100)/4)+a.day-32075;return b},d=function(b){return a.monthString(b)},e=function(a,b){b.hours=parseInt(a/3600),a%=3600,b.minutes=parseInt(a/60),a%=60,b.seconds=a},f=function(a,b){return 1==a||3==a||5==a||7==a||8==a||10==a||12==a?31:4==a||6==a||9==a||11==a?30:b%4==0&&b%100!=0||b%400==0?29:28},g=function(a,c){var f={},g={};a&&b(a,f),c&&"undefined"!=typeof c&&e(c,g);var h="";return f&&(h+=f.day+" "+d(f.month)+" "+Math.abs(f.year)),f.year<0&&(h+=" a.C."),g&&g.hours&&g.minutes&&(h+=g.hours<10?" 0"+g.hours:" "+g.hours,h+=g.minutes<10?":0"+g.minutes:":"+g.minutes),h},h=function(a,c){var d={},f={};a&&b(a,d),c&&"undefined"!=typeof c&&e(c,f);var g="";return d&&(g+=d.day+"/"+d.month+"/"+Math.abs(d.year)),d.year<0&&(g+=" a.C."),f&&f.hours&&f.minutes&&(g+=f.hours<10?" 0"+f.hours:" "+f.hours,
g+=f.minutes<10?":0"+f.minutes:":"+f.minutes),g};return{julianNumberToDate:b,dateToJulianNumber:c,getMonthString:d,getTimeToSeconds:e,getNumDaysOfMonth:f,dateTimeToString:g,dateTimeToStringShort:h}}]),angular.module("smiled.application").factory("messageService",["$q",function(a){var b=[],c=function(a){a.read=!1,b.push(a)};return{newMessage:c}}]),angular.module("smiled.application").factory("modalService",["$modal","apiService",function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r={},t={},u={},v={},w={},x="",y={},z={},r={},A={},B={},C=!0,D={templateUrl:"assets/private/partials/concurrentModPostTemplate.html"},E={templateUrl:"assets/private/partials/customDatePickerTemplate.html",controller:"customDatePickerTemplateCtrl",controllerAs:"customDatePickerTemplate",size:"sm",resolve:{startDate:function(){return y},endDate:function(){return z},post:function(){return w}}},F={templateUrl:"assets/private/partials/createScenario.html",controller:"dialogScenarioCtrl",controllerAs:"dialogScenario",size:"lg"},G={templateUrl:"assets/private/partials/deleteScenario.html",controller:"dialogScenarioCtrl",controllerAs:"dialogScenario"},H={templateUrl:"assets/private/partials/confirmRegistration.html",controller:"dialogConfirmRegistrationCtrl",controllerAs:"dialogConfirmRegistration",resolve:{confirmRegistrationBool:function(){return C}}},I={templateUrl:"assets/private/partials/deleteAttendee.html",controller:"dialogScenarioCtrl",controllerAs:"dialogScenario"},J={templateUrl:"assets/private/partials/deleteCollaborator.html",controller:"dialogScenarioCtrl",controllerAs:"dialogScenario"},K={templateUrl:"assets/private/partials/deleteCharacter.html",controller:"dialogScenarioCtrl",controllerAs:"dialogScenario"},L={templateUrl:"assets/private/partials/setDate.html",controller:"dialogSetDateCtrl",controllerAs:"dialogSetDate",resolve:{scen:function(){return r},start:function(){return!0}}},M={templateUrl:"assets/private/partials/setDate.html",controller:"dialogSetDateCtrl",controllerAs:"dialogSetDate",resolve:{scen:function(){return r},start:function(){return!1}}},N={templateUrl:"assets/private/partials/openMap.html",controller:"openMapCtrl",controllerAs:"openMap",size:"lg",resolve:{post:function(){return w},scenarioMap:function(){return x}}},O={templateUrl:"assets/private/partials/openMapForPost.html",controller:"openMapForPostCtrl",controllerAs:"openMapForPost",size:"lg",resolve:{post:function(){return w},scenarioMap:function(){return x}}},P={templateUrl:"assets/private/partials/oldCharacterChangeOnComment.html",controller:"oldCharacterChangeOnCommentCtrl",controllerAs:"oldCharacterChangeOnComment",size:"sm",resolve:{charName:function(){return c}}},Q={templateUrl:"assets/private/partials/createMission.html",controller:"dialogMissionCtrl",controllerAs:"dialogMission",size:"lg",resolve:{scenario:function(){return r}}},R={templateUrl:"assets/private/partials/deleteResource.html",controller:"deleteResourceCtrl",controllerAs:"deleteResource",size:"sm",resolve:{file:function(){return A}}},S={templateUrl:"assets/private/partials/deletePost.html",size:"sm"},T=function(){return d=a.open(F),d.result},U=function(){d.close()},V=function(b){return r=b,e=a.open(G),e.result},W=function(b,c){return C=c,B=b,p=a.open(H),p.result},X=function(b){return t=b,f=a.open(I),f.result},Y=function(b){return v=b,g=a.open(J),g.result},Z=function(b){return u=b,modalInstanceDeleteCharacter=a.open(K),modalInstanceDeleteCharacter.result},$=function(){e.close()},_=function(){f.close()},aa=function(){p.close()},ba=function(){g.close()},ca=function(){modalInstanceDeleteCharacter.close()},da=function(a){var c={startDate:{year:"",month:"",day:"",afterChrist:""},endDate:{year:"",month:"",day:"",afterChrist:""}};c.startDate.year=a.startDate.year,c.startDate.month=a.startDate.month,c.startDate.day=a.startDate.day,c.startDate.afterChrist=a.startDate.afterChrist,c.endDate.year=a.endDate.year,c.endDate.month=a.endDate.month,c.endDate.day=a.endDate.day,c.endDate.afterChrist=a.endDate.afterChrist;var d={};return d.name=a.title,d.history=c,d.showRelationsToAll=a.showRelationsToAll,s=b.createScenario(d),s},ea=function(){return s=b.deleteScenario(r.id),s},fa=function(){return r},ga=function(){return B},ha=function(){return t},ia=function(){return v},ja=function(){return u},ka=function(b,c){return r=b,h=1==c?a.open(L):a.open(M),h.result},la=function(){h.close()},ma=function(b,c){return w=b,x=c,i=a.open(N),i.result},na=function(){i.close()},oa=function(b,c){return w=b,x=c,j=a.open(O),j.result},pa=function(){j.close()},qa=function(b){return c=b,k=a.open(P),k.result},ra=function(){k.close()},sa=function(b,c,d){return y=b,z=c,w=d,l=a.open(E),l.result},ta=function(){l.close()},ua=function(b){return r=b,m=a.open(Q),m.result},va=function(){m.close()},wa=function(a){return console.log("CREATE MISSION -----------------------"),s=b.createMission(a.scenId,a),s},xa=function(b){return A=b,n=a.open(R),n.result},ya=function(){n.close()},za=function(){return o=a.open(S),o.result},Aa=function(){o.close()},Ba=function(){return q=a.open(D),q.result},Ca=function(){q.close()};return{createScenario:da,deleteScenario:ea,showModalCreateScen:T,closeModalCreateScen:U,showModalDeleteScen:V,closeModalDeleteScen:$,showModalDeleteAttendee:X,closeModalDeleteAttendee:_,showModalDeleteCollaborator:Y,closeModalDeleteCollaborator:ba,showModalDeleteCharacter:Z,closeModalDeleteCharacter:ca,getScenToDelete:fa,getAttendeeToDelete:ha,getCollaboratorToDelete:ia,getCharacterToDelete:ja,showPopUpSetDate:ka,closeModalSetDate:la,showModalOpenMap:ma,closeModalOpenMap:na,showModalOpenMapForPost:oa,closeModalOpenMapForPost:pa,showModalOldCharacterChangeOnComment:qa,closeModalOldCharacterChangeOnComment:ra,showModalSetHistoryDate:sa,closeModalSetHistoryDate:ta,createMission:wa,showModalCreateMission:ua,closeModalCreateMission:va,showModalDeleteResource:xa,closeModalDeleteResource:ya,showModalDeletePost:za,closeModalDeletePost:Aa,showModalConfirmRegistration:W,getRegistrationToConfirm:ga,closeModalConfirmRegistration:aa,showConcurrentModPost:Ba,closeModalConcurrentModPost:Ca}}]),angular.module("smiled.application").factory("notifyService",["$q","$cookies","$rootScope","apiService",function(a,b,c,d){var e=b.get("myMescholaId"),f=[],g="",h={},i={},j=[],k=[],l=function(a){g=a},m=function(){g="",j=[],k=[]},n=function(a){"OPEN_SCENARIO"==a.verb||"CLOSE_SCENARIO"==a.verb?c.$broadcast("dashboard.reloadDashboard"):"NEW_MOD"==a.verb||"DEL_MOD"==a.verb?c.$broadcast("dashboardTeacher.reloadDashboard"):"NEW_ASSOCIATION"==a.verb&&a.objectId==e||"DEL_ASSOCIATION"==a.verb||"NEW_ATTENDEE"==a.verb||"DEL_ATTENDEE"==a.verb?c.$broadcast("dashboardStudent.reloadDashboard"):"NEW_PERSONAL_MISSION"!=a.verb&&"NEW_GLOBAL_MISSION"!=a.verb||c.$broadcast("dashboardStudent.reloadMission"),a.sender!=e&&("NEW_POST"==a.verb?a.scenarioId==g&&(f.unshift(a.objectId),c.$broadcast("notification.newPostEvent")):"UPD_POST"==a.verb?a.scenarioId!=g||z(a.objectId)?(k.push(a.objectId),c.$broadcast("notification.generateAlertUpd",{id:a.objectId})):c.$broadcast("notification.updPostEvent",{id:a.objectId}):"UPD_NEW_COMMENT"==a.verb?a.scenarioId==g&&c.$broadcast("notification.updNewComment",{notification:a}):"UPD_NEW_META"==a.verb?a.scenarioId==g&&c.$broadcast("notification.updNewMetaComment",{notification:a}):c.$broadcast("notification.newNotificationEvent",{notification:a}))},o=function(){var a=angular.copy(f);return f=[],a},p=function(a,b){return d.getLastUserNotifications(a,b)},q=function(a){h=a},r=function(){h=null},s=function(a){i=a},t=function(){i=null},u=function(){h&&h(f)},v=function(){u(),f=[]},w=function(){i&&i()},x=function(a){j.indexOf(a)<0&&j.push(a)},y=function(a){var b=j.indexOf(a);if(b>=0){j.splice(b,1);var d=k.indexOf(a);d>=0&&(c.$broadcast("notification.updPostEvent",{id:a}),k.splice(d,1))}},z=function(a){return!(j.indexOf(a)<0)},A=c.$on("meschola.login",function(a,b){console.log(b.id),e=b.id}),B=c.$on("meschola.logout",function(){e=""});return c.$on("$destroy",function(){A(),B()}),{newNotifyOrPost:n,getAllNewPosts:o,registerObserverReloadList:q,resetObserverReloadList:r,notifyReloadListObservers:u,reloadList:v,reloadAssociation:w,registerObserverAssociation:s,resetObserverAssociation:t,setActualScenarioId:l,resetActualScenarioId:m,readOldNotifications:p,addToInEditPost:x,removeToInEditPost:y,isInEditPost:z}}]),angular.module("smiled.application").factory("socialGraphSketch",["userService",function(a){return function(b){var c,d,e={},f=[],g={},h=[],i=null,j=null,k=null,l=0,m=!1,n=0,o=.1,p=.1,q=.5,r=4e5,s=80,t=.5;b.preload=function(){var e=a.getScenarioId(),f="/api/v1/scenarios/"+e+"/socialGraph";h=b.loadJSON(f);var g=angular.element(document.querySelector("#container-graph"));c=g.width(),d=parseInt(3*c/4)};var u=function(){var a={};a.links={};for(var c in e)a.links[c]=0;return a.posts=0,a.getRadius=function(){return.75*(b.log(a.posts+1)/b.log(1.2)+10)},a},v=function(a,c){var d={id:a,name:c,x:[b.random(0,b.width),0,0,0,0],y:[b.random(0,b.height),0,0,0,0],targets:[],vx:0,vy:0,ax:0,ay:0,phase:b.random(0,b.TWO_PI)};return d.setX=function(a){var c=b.shorten(d.x);d.x=b.splice(c,a,0)},d.setY=function(a){var c=b.shorten(d.y);d.y=b.splice(c,a,0)},d.getX=function(){return d.x[0]},d.getY=function(){return d.y[0]},d.getLastX=function(){return d.x[4]},d.getLastY=function(){return d.y[4]},d.getName=function(){return d.name},d.getId=function(){return d.id},d.getTargets=function(){return d.targets},d.addTarget=function(a){d.targets.push(a)},d.draw=function(c){for(var e=g[a],f=2*e.getRadius(),h=c?d.x.length-1:0,i=h;i>=0;i--){255-128/b.pow(b.sq(d.vx)+b.sq(d.vy)+1,.3);b.push(),b.colorMode(b.RGB);var j=b.map(i,d.x.length,0,0,1);j=255*b.pow(j,3),b.stroke(64,75,65,j),b.fill(137,177,81,j);var k=b.map(i,0,d.x.length,f,0);b.ellipse(d.x[i],d.y[i],k,k),b.pop()}},d.flash=function(){b.push();var a=g[d.id],c=2*a.getRadius();b.fill(250,215,123,128),b.noStroke(),b.ellipse(d.getX(),d.getY(),l*c,l*c),b.pop()},d};b.setup=function(){b.createCanvas(c,d);for(var a in h){var i=h[a],j=i.author;j.x=b.random(0,b.width),j.y=b.random(0,b.height);var k=j.id;switch(e[k]!=={}&&(e[k]=v(k,j.name),g[k]=u()),i.action){case"POST":f.push({from:k,to:k});break;case"TAG":case"LIKE":case"COMMENT":var l=i.object,m=l.id;e[m]!=={}&&(e[m]=v(m,l.name),g[m]=u()),f.push({from:k,to:m})}}},b.draw=function(){b.touchIsDown&&(b.mouseX=b.touchX,b.mouseY=b.touchY),l*=.95,m?(n=b.map(b.mouseX,20,b.width-20,0,f.length),n=b.floor(b.constrain(n,0,f.length)),l=3):null!==i&&(i.setX(b.mouseX),i.setY(b.mouseY)),b.background(245,242,234),b.stroke(64,75,65);var a=0,c=0,d=0,h=0,v=null,w=0;for(var x in e){var y=e[x];y.getTargets();d=y.getX()-b.width/2,h=y.getY()-b.height/2;var z=b.sqrt(b.sq(d)+b.sq(h));1>z&&(z=1);var A=1;v=g[y.getId()],v&&(A+=v.posts/3),y.ax=-s*A*d/z,y.ay=-s*A*h/z;for(var B in e)if(x!=B){var C=e[B];a=y.getX()-C.getX(),c=y.getY()-C.getY();var D=b.pow(b.sq(a)+b.sq(c),1.5);10>D&&(D=10),w=r*(A+1),y.ax+=w*a/D,y.ay+=w*c/D}}g={};for(x in e)g[x]=u();for(x=0;n>x;x++){var E=f[x],F=e[E.from],G=e[E.to];v=g[E.from],E.from!==E.to?(v.links[E.to]++,k=null):(k=F,v.posts++),g[E.from]=v;var H=g[E.to];E.from!==E.to&&H.links[E.from]++,g[E.to]=H,a=F.getX()-G.getX(),c=F.getY()-G.getY(),b.push(),b.noFill(),b.strokeWeight((b.log(v.links[E.to])+1)/b.log(2));var I=.5*(F.getLastX()+G.getLastX()),J=.5*(F.getLastY()+G.getLastY());b.bezier(F.getX(),F.getY(),I,J,I,J,G.getX(),G.getY()),b.pop(),F.ax+=-q*a,F.ay+=-q*c,G.ax+=q*a,G.ay+=q*c}w=b.frameCount*b.sqrt(o)/b.TWO_PI;for(var K in e){var L=e[K];k===L&&L.flash(),L.draw(L!==i),L.vx+=L.ax*p,L.vy+=L.ay*p,L.vx*=t,L.vy*=t,L.vx+=o*b.sin(w+L.phase),L.vy+=o*b.cos(w+L.phase),L.setX(L.getX()+L.vx*p),L.setY(L.getY()+L.vy*p),L.getX()<5?(L.setX(5),L.vx*=-1):L.getX()>b.width-5&&(L.setX(b.width-5),L.vx*=-1),L.getY()<5?(L.setY(5),L.vy*=-1):L.getY()>b.height-5&&(L.setY(b.height-5),L.vy*=-1)}j&&(b.push(),b.fill(224),b.stroke(128),b.rect(j.getX()+10,j.getY()+10,10+b.textWidth(j.getName()),25),b.fill(0),b.text(j.getName(),j.getX()+15,j.getY()+28),b.pop()),b.push(),b.stroke(255),b.strokeWeight(3),b.line(20,b.height-20,b.width-20,b.height-20),b.stroke(0),b.strokeWeight(1),b.line(20,b.height-20,b.width-20,b.height-20);var M=b.map(n,0,f.length,20,b.width-20),N=b.height-20;for(b.stroke(0),b.colorMode(b.HSB,255),b.fill(36,120,196),b.ellipse(M,N,20,20),b.noStroke(),x=10;x>0;x--)b.fill(36,120,226-3*x),b.ellipse(M-2,N-2,x,x);b.colorMode(b.RGB),b.pop()},b.mousePressed=function(){var a=b.map(n,0,f.length,20,b.width-20),c=b.height-20,d=b.mouseX-a,h=b.mouseY-c,j=b.sq(d)+b.sq(h);400>j&&(m=!0);for(var k in e){var l=e[k];d=b.mouseX-l.getX(),h=b.mouseY-l.getY(),j=b.sq(d)+b.sq(h);var o=l.getId(),p=25,q=g[o];if(q&&(p=q.getRadius()),p*p>j)return void(i=l)}},b.touchStarted=function(){var a=b.map(n,0,f.length,20,b.width-20),c=b.height-20,d=b.touchX-a,h=b.touchY-c,j=b.sq(d)+b.sq(h);1e3>j&&(m=!0);for(var k in e){var l=e[k];d=b.touchX-l.getX(),h=b.touchY-l.getY(),j=b.sq(d)+b.sq(h);var o=l.getId(),p=25,q=g[o];if(q&&(p=q.getRadius()),p*p>.25*j)return i=l,!0}return!0},b.mouseMoved=function(){j=null;for(var a in e){var c=e[a],d=g[a];d||(d=u());var f=d.getRadius(),h=b.mouseX-c.getX(),i=b.mouseY-c.getY(),k=b.sq(h)+b.sq(i);if(f*f>k){j=c;break}}},b.touchMoved=function(){j=null;for(var a in e){var c=e[a],d=g[a];d||(d=u());var f=d.getRadius(),h=b.touchX-c.getX(),i=b.touchY-c.getY(),k=b.sq(h)+b.sq(i);if(f*f>.25*k){j=c;break}}return!0},b.mouseReleased=function(){i=null,m=!1},b.touchEnded=function(){return i=null,m=!1,!0};var w=function(){for(var a in e){var c=e[a];c.setX(b.random(0,b.width)),c.setY(b.random(0,b.height))}};b.keyTyped=function(){switch(b.key){case" ":case"+":n=b.constrain(n+1,0,f.length),l=3;break;case"-":n=b.constrain(n-1,0,f.length),l=3;break;case"c":case"C":n=0,l=0;break;case"s":case"S":w();break;case"h":case"H":o=b.min(10,1.25*o);break;case"l":case"L":o=b.max(0,o/1.25)}return!1}}}]),angular.module("smiled.application").service("unauthorizedInterceptor",["$rootScope","$q",function(a,b,c){return{response:function(a){return a},responseError:function(c){return 401===c.status&&(console.log("UNAUTHORIZED"),a.$broadcast("unauthorized")),b.reject(c)}}}]),angular.module("smiled.application").factory("userService",["$http","$q","$cookies","$rootScope",function(a,b,c,d){var e="",f={},g=function(a){e=a},h=function(){return e},i=function(){return f},j=function(){var e=b.defer();return a.get("/api/v1/me").then(function(a){e.resolve(a.data),c.put("myMescholaId",a.data.id),f=a.data,d.$broadcast("meschola.login",{id:a.data.id})},function(a){e.reject(a),f={}}),e.promise},k=function(c){var d=b.defer();return a.get("/api/v1/userByEmail?email="+c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},l=function(c,d){var e=b.defer();return a.put("/api/v1/confirmRegisterTeacher?token="+c+"&email="+d).then(function(a){e.resolve(a.data)},function(a){console.log(a),e.reject(a)}),e.promise},m=function(c,d){var e=b.defer();return a["delete"]("/api/v1/deleteRegisterTeacher?token="+c+"&email="+d).then(function(a){e.resolve(a.data)},function(a){console.log(a),e.reject(a)}),e.promise},n=function(c){var d=b.defer();return a.get("/api/v1/users/"+c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},o=function(c){var d=b.defer();return a.put("/api/v1/me/",c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},p=function(){var e=b.defer();return a({url:"/apiLogout",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).then(function(a){f={},c.remove("myMescholaId"),e.resolve(a),d.$broadcast("meschola.logout")},function(a){console.log("Logout failed: "+a),e.reject(a)}),e.promise},q=function(c,d){var e=b.defer(),f=encodeURIComponent(c),g=encodeURIComponent(d);return a({url:"/apiLogin",method:"POST",data:"j_username="+f+"&j_password="+g+"&submit=",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).then(function(a){e.resolve(a)},function(a){console.log("Authentication failed: "),console.log(a),e.reject(a)}),e.promise},r=[],s=function(a){r.push(a)},t=function(){angular.forEach(r,function(a){a()})},u=function(c){var d=b.defer();return a.put("/api/v1/password",c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},v=function(c){var d=b.defer();return a.put("/api/v1/firstPassword",c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},w=function(c){var d=b.defer();return a.post("/api/v1/forgotPasswordRequest",c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},x=function(){if(f.hasOwnProperty("id")){var a=b.defer();return a.resolve(f),a.promise}return j()};return{login:q,logout:p,getMe:j,getLastMe:i,getUser:n,registerObserverPersonalCover:s,notifyPersonalCoverObservers:t,setScenarioId:g,getScenarioId:h,changePassword:u,changeFirstPassword:v,updateMe:o,confirmRegisterTeacher:l,forgotPasswordRequest:w,deleteRegisterTeacher:m,getUserByEmail:k,getMeForPermission:x}}]),angular.module("smiled.application").factory("webSocketService",["$timeout","messageService","notifyService","$rootScope",function(a,b,c,d){var e={},f={},g=0,h=!0;e.RECONNECT_TIMEOUT=1e3,e.START_AFTER_TIME_TO_SETUP=700,e.SOCKET_URL="/websocket/messages";var i=function(){var a;return a=0!=g?g*e.RECONNECT_TIMEOUT:e.RECONNECT_TIMEOUT,a+1e3*Math.random()},j=function(){console.log("ON OPEN!!!!!!!!"),g=0},k=function(a){f.send(JSON.stringify(a))},l=function(){h&&a(function(){m()},i())},m=function(){0==g?g=1:256>g&&(g=2*g),n()},n=function(){f=new SockJS(e.SOCKET_URL),console.log(f),console.log("open ws connection on webSocketService"),f.onopen=function(){j()},f.onmessage=function(a){var b=JSON.parse(a.data);"NOTIFICATION"==b.type?c.newNotifyOrPost(b):console.log("message is a message")},f.onclose=function(){console.log("close ws connection on webSocketService"),l()}};n();var o=d.$on("meschola.login",function(a,b){h=!0,n()}),p=d.$on("meschola.logout",function(){h=!1});return d.$on("$destroy",function(){o(),p()}),{send:k}}]),angular.module("smiled.application").directive("alertgeneric",["alertingGeneric",function(a){return{restrict:"AE",templateUrl:"assets/public/partials/alerts.html",scope:!0,controller:function(b){b.removeAlert=function(b){a.removeAlert(b)}},link:function(b){b.currentAlerts=a.currentAlerts}}}]),angular.module("smiled.application").directive("alertlogin",["alertingLogin",function(a){return{restrict:"AE",templateUrl:"assets/public/partials/alerts.html",scope:!0,controller:function(b){b.removeAlert=function(b){a.removeAlert(b)}},link:function(b){b.currentAlerts=a.currentAlerts}}}]),angular.module("smiled.application").directive("alertregistration",["alertingRegistration",function(a){return{restrict:"AE",templateUrl:"assets/public/partials/alerts.html",scope:!0,controller:function(b){b.removeAlert=function(b){a.removeAlert(b)}},link:function(b){b.currentAlerts=a.currentAlerts}}}]),angular.module("smiled.application").directive("alertscenario",["alertingScenario",function(a){return{restrict:"AE",templateUrl:"assets/public/partials/alerts.html",scope:!0,controller:function(b){b.removeAlert=function(b){a.removeAlert(b)}},link:function(b){b.currentAlerts=a.currentAlerts}}}]),angular.module("smiled.application").directive("blurElement",[function(){return{scope:{open:"="},restrict:"A",link:function(a,b,c,d){a.$watch("open",function(a,c){a!==!0||c?a===!1&&c===!0&&b[0].blur():b[0].focus()})}}}]),angular.module("smiled.application").directive("bsSwitch",function(){return{restrict:"A",require:"ngModel",scope:{onCustomText:"@",offCustomText:"@"},controller:function(a){a.state},controllerAs:"bsSwitch",link:function(a,b,c,d){$(b).bootstrapSwitch({onSwitchChange:function(b,c){a.state=c,a.$apply(function(){d.$setViewValue(c)})}}),$(b).bootstrapSwitch("onText",a.onCustomText),$(b).bootstrapSwitch("offText",a.offCustomText),$(b).bootstrapSwitch("labelText","<span class='glyphicon glyphicon-resize-horizontal'></span>")}}}),angular.module("smiled.application").directive("commentTo",["apiService","CONSTANTS","modalService","notifyService",function(a,b,c,d){return{templateUrl:"assets/private/partials/comment-to-template.html",scope:{post:"=",writer:"=",currentCharacter:"=",scenarioId:"@",loggedUser:"="},controller:["$scope",function(d){var e=b.visibleComment,f=this,g=f.currentCharacter.id,h=f.currentCharacter.name;f.showViewOthers=!1,f.showInsert=!0,f.atLeastOneCommentWasSended=!1,f.currentCharacter&&f.currentCharacter.id||(f.showInsert=!1),f.visibleComments=new Array;for(var i=0;i<f.post.comments.length&&e>i;)f.visibleComments.unshift(f.post.comments[i]),i++;f.post.comments.length>e&&(f.showViewOthers=!0),f.openViewOthers=function(){f.visibleComments=angular.copy(f.post.comments),f.visibleComments.reverse(),f.showViewOthers=!1},f.addCommentToPost=function(){if(f.post.newComment){var b={};b.text=f.post.newComment,b.characterId=g,a.sendCommentToPost(f.scenarioId,f.post.id,b).then(function(a){b.creationDate=new Date,b.character={},b.character.id=f.currentCharacter.id,b.character.firstname=f.currentCharacter.name,b.user={},b.user.id=f.loggedUser.id,b.user.firstname=f.loggedUser.firstName,b.user.lastname=f.loggedUser.lastName,f.post.comments.splice(0,0,b),f.post.newComment=""},function(a){console.log("fail to send comment: "+a),"403"==a.status&&c.showModalOldCharacterChangeOnComment(h)})}}}],controllerAs:"commentTo",bindToController:!0,link:function(a,b,c,e){a.$watch("commentTo.post.comments.length",function(a,b){a!=b&&a>0&&(e.showViewOthers?e.visibleComments.push(e.post.comments[0]):e.openViewOthers())}),a.$watch("commentTo.post.newComment.length",function(a,b){a>0&&(0==b||void 0==b)?d.addToInEditPost(e.post.id):(0==a||void 0==a)&&b>0&&d.removeToInEditPost(e.post.id)}),a.$on("$destroy",function(){e.post.newComment="",d.removeToInEditPost(e.post.id)})}}}]),angular.module("smiled.application").directive("customDatePicker",["CONSTANTS",function(a){return{restrict:"AE",templateUrl:"assets/private/partials/customDatePicker.html",scope:{startDateNumber:"=?",endDateNumber:"=?",dateNumber:"=?",date:"=?",startDate:"=?",endDate:"=?",dateString:"=?",timeNumber:"=?"},controller:function(){var b=this,c={};b.startDate&&(b.startDate.day=parseInt(b.startDate.day),b.startDate.month=parseInt(b.startDate.month),b.startDate.year=parseInt(b.startDate.year)),b.endDate&&(b.endDate.day=parseInt(b.endDate.day),b.endDate.month=parseInt(b.endDate.month),b.endDate.year=parseInt(b.endDate.year)),b.startDate||b.startDateNumber||(b.startDateNumber=0,b.startDate={}),b.endDateNumber||b.endDate||(b.endDateNumber=38245427,b.endDate={}),b.currentMonthDate={},b.days;var d=new Array,e=4;b.showDays=!0,b.yearMatrix=new Array;for(var f=0;e>f;f++)b.yearMatrix[f]=new Array;var g=function(){for(var a=0;e>a;a++)for(var c=0;e>c;c++)b.yearMatrix[a][c]=""},h=function(a,b){var c=a+68569,d=parseInt(4*c/146097);c-=parseInt((146097*d+3)/4);var e=parseInt(4e3*(c+1)/1461001);c=c-parseInt(1461*e/4)+31;var f=parseInt(80*c/2447);b.day=c-parseInt(2447*f/80),c=parseInt(f/11),b.month=f+2-12*c,b.year=100*(d-49)+e+c,b.dow=a%7},i=function(a){var b=parseInt(1461*(a.year+4800+parseInt((a.month-14)/12))/4)+parseInt(367*(a.month-2-12*parseInt((a.month-14)/12))/12)-parseInt(3*parseInt((a.year+4900+parseInt((a.month-14)/12))/100)/4)+a.day-32075;return b},j=function(b){return a.monthString(b)};b.dateNumber&&(b.currentDate={},h(b.dateNumber,b.currentDate)),b.startDateNumber?h(parseInt(b.startDateNumber),b.startDate):b.startDateNumber=i(b.startDate),b.endDateNumber?h(parseInt(b.endDateNumber),b.endDate):b.endDateNumber=i(b.endDate),b.dateNumber?h(b.dateNumber-(b.currentDate.day-1),b.currentMonthDate):h(b.startDateNumber-(b.startDate.day-1),b.currentMonthDate);var k=function(a,b){b.hours=parseInt(a/3600),a%=3600,b.minutes=parseInt(a/60),a%=60,b.seconds=a},l=function(){var a=b.currentMonthDate.year>0?"":" a.C.",c=j(b.currentMonthDate.month)+" "+Math.abs(b.currentMonthDate.year)+a;b.currentMonthDate.title=c};l();for(var m=angular.copy(b.startDate),n=angular.copy(b.endDate),o=0;m.year<=n.year;)d[o]=m.year,m.year++,o++;var p=function(a,b){return 1==a||3==a||5==a||7==a||8==a||10==a||12==a?31:4==a||6==a||9==a||11==a?30:b%4==0&&b%100!=0||b%400==0?29:28},q=function(a){c={};var d=p(a.month,a.year),e=1,f=1;b.days=new Array;for(var g=0;5>g;g++){b.days[g]=new Array;for(var h=0;7>h;h++)a.dow>=f?b.days[g][h]="":d>=e&&(b.days[g][h]={},b.days[g][h].val=e,b.days[g][h].selected=!1,(a.year==b.startDate.year&&a.month<b.startDate.month||a.year==b.startDate.year&&a.month==b.startDate.month&&e<b.startDate.day||a.year==b.endDate.year&&a.month>b.endDate.month||a.year==b.endDate.year&&a.month==b.endDate.month&&e>b.endDate.day)&&(b.days[g][h].inactive=!0),b.currentDate&&b.currentDate.year==a.year&&b.currentDate.month==a.month&&b.currentDate.day==e&&(b.days[g][h].selected=!0,c=b.days[g][h]),e++),f++}if(d>=e){b.days[5]=new Array;for(var i=0;d>=e;i++)b.days[5][i]={},b.days[5][i].val=e,b.days[5][i].selected=!1,(a.year==b.startDate.year&&a.month<b.startDate.month||a.year==b.startDate.year&&a.month==b.startDate.month&&e<b.startDate.day||a.year==b.endDate.year&&a.month>b.endDate.month||a.year==b.endDate.year&&a.month==b.endDate.month&&e>b.endDate.day)&&(b.days[5][i].inactive=!0),b.currentDate&&b.currentDate.year==a.year&&b.currentDate.month==a.month&&b.currentDate.day==e&&(b.days[5][i].selected=!0,c=b.days[5][i]),e++}l()};q(b.currentMonthDate),b.getDayOfWeekString=function(b){return a.dayOfWeekString(b)},b.nextMonth=function(){if(b.showDays){var a=i(b.currentMonthDate);a+=p(b.currentMonthDate.month,b.currentMonthDate.year),a<=b.endDateNumber&&(h(a,b.currentMonthDate),q(b.currentMonthDate))}else{var c=b.yearMatrix[e-1][e-1]+1-b.startDate.year;if(c<d.length&&c>0){g(),d[c]>=0?b.yearsInterval=""+d[c]+" d.C.":b.yearsInterval=""+Math.abs(d[c])+" a.C.";for(var f=0;e>f;f++)for(var j=0;e>j&&c<d.length&&c>0;j++)b.yearMatrix[f][j]=d[c],c++;d[c-1]>=0?b.yearsInterval+=" - "+d[c-1]+" d.C.":b.yearsInterval+=" - "+Math.abs(d[c-1])+" a.C."}}},b.prevMonth=function(){if(b.showDays){var a=i(b.currentMonthDate);a-=p(b.currentMonthDate.month-1,b.currentMonthDate.year),a>=b.startDateNumber?(h(a,b.currentMonthDate),q(b.currentMonthDate)):(a+=b.startDate.day,a>=b.startDateNumber&&(h(a,b.currentMonthDate),q(b.currentMonthDate)))}else{var c=b.yearMatrix[0][0]-e*e-b.startDate.year;if(0>c&&(c=0),c<d.length){g(),d[c]>=0?b.yearsInterval=""+d[c]+" d.C.":b.yearsInterval=""+Math.abs(d[c])+" a.C.";for(var f=0;e>f;f++)for(var j=0;e>j&&c<d.length&&c>=0;j++)b.yearMatrix[f][j]=d[c],c++;d[c-1]>=0?b.yearsInterval+=" - "+d[c-1]+" d.C.":b.yearsInterval+=" - "+Math.abs(d[c-1])+" a.C."}}},b.selectDate=function(a,d){if(!b.days[a][d].inactive){c&&(c.selected=!1);var e={};e.day=b.days[a][d].val,e.month=b.currentMonthDate.month,e.year=b.currentMonthDate.year,b.dateNumber=i(e),b.days[a][d].selected=!0,c=b.days[a][d],b.dateString=b.days[a][d].val+" "+b.currentMonthDate.title;var f={};k(b.timeNumber,f),b.dateString+=" "+f.hours+":",f.minutes<10?b.dateString+="0"+f.minutes:b.dateString+=f.minutes}},b.switchToShowYears=function(){b.showDays=!1,g();var a=b.currentMonthDate.year-b.startDate.year;d[a]>=0?b.yearsInterval=""+d[a]+" d.C.":b.yearsInterval=""+Math.abs(d[a])+" a.C.";for(var c=0;e>c;c++)for(var f=0;e>f&&a<d.length;f++)b.yearMatrix[c][f]=d[a],a++;d[a-1]>=0?b.yearsInterval+=" - "+d[a-1]+" d.C.":b.yearsInterval+=" - "+Math.abs(d[a-1])+" a.C."},b.switchToShowDays=function(){b.showDays=!0},b.selectYear=function(a,c){b.currentMonthDate.year=b.yearMatrix[a][c],b.currentMonthDate.year==b.startDate.year?b.currentMonthDate.month==b.startDate.month:b.currentMonthDate.month=1,b.currentMonthDate.day=1,b.switchToShowDays(),q(b.currentMonthDate)};var r=function(a){var c=a.getHours(),d=a.getMinutes(),e=a.getSeconds();b.timeNumber=e+60*d+3600*c};if(b.timeNumber){var s=new Date,t={};k(b.timeNumber,t),b.myTime=new Date(s.getFullYear(),s.getMonth(),s.getDay(),t.hours,t.minutes,t.seconds)}else b.myTime=new Date,r(b.myTime);b.changed=function(){r(b.myTime)}},controllerAs:"vm",bindToController:!0}}]),angular.module("smiled.application").directive("editDraftPost",["apiService","CONSTANTS","modalService","Upload","$state","$q",function(a,b,c,d,e,f){return{templateUrl:"assets/private/partials/edit-draft-post-directive.html",scope:{posts:"=",postId:"@",user:"="},controller:["$scope",function(g){var h=this;if(h.scenario={},h.date={},h.colorMapMarker={},h.colorImageMarker={},h.colorFileMarker={},h.realDateFormat=b.realDateFormatWithHour,h.sendPostEnable=!0,h.post={},h.postId&&h.posts)for(var i=0;i<h.posts.length;i++)if(h.posts[i].id==h.postId){h.post=h.posts[i],h.post.character&&(h.post.character.cover=b.urlCharacterCover(h.post.scenarioId,h.post.character.id));break}h.newPost=angular.copy(h.post),h.newPost.image=new Array,h.newPost.file=new Array,h.newPost.tags=new Array,h.newPost.toDeleteImage=new Array,h.newPost.toDeleteFile=new Array;var j=function(a){var b=a.name.split("."),c=b[b.length-1];a.fileType=null,"jpg"==c||"jpeg"==c||"png"==c||"gif"==c?a.fileType="img":"pdf"==c?a.fileType="pdf":"doc"==c||"docx"==c||"odt"==c||"txt"==c?a.fileType="doc":"ppt"==c||"pptx"==c||"odp"==c?a.fileType="ppt":"xls"!=c&&"xlsx"!=c&&"ods"!=c||(a.fileType="excel")},k=function(){if(h.post.imagesMetadata)for(var a=0;a<h.post.imagesMetadata.length;a++){var b={};b.id=h.post.imagesMetadata[a].id,b.name=h.post.imagesMetadata[a].originalName,h.newPost.image.push(angular.copy(b))}if(h.post.filesMetadata)for(var a=0;a<h.post.filesMetadata.length;a++){var b={};b.id=h.post.filesMetadata[a].id,b.name=h.post.filesMetadata[a].originalName,j(b),h.newPost.file.push(angular.copy(b))}if(h.post.tags)for(var a=0;a<h.post.tags.length;a++){var b={};b.id=h.post.tags[a].id,b.name=h.post.tags[a].firstname,h.post.tags[a].lastname&&(b.name+=" "+h.post.tags[a].lastname),h.newPost.tags.push(angular.copy(b))}};k(),a.getScenario(h.post.scenarioId).then(function(a){h.scenario=a,h.startDate=angular.copy(h.scenario.history.startDate),h.startDate.afterChrist||(h.startDate.year*=-1),h.endDate=angular.copy(h.scenario.history.endDate),h.endDate.afterChrist||(h.endDate.year*=-1)},function(a){console.log("Impossibile recuperare lo scenario"),console.log(a)}),h.showDatePicker=!1,h.setDateNewPost=function(){c.showModalSetHistoryDate(h.startDate,h.endDate,h.newPost)},h.colorTagsMarker={},h.stringTags="",h.tagIsSet=!1,h.showTagBox=!1,h.switchShowTagBox=function(){h.showTagBox=!h.showTagBox},h.hideTagBox=function(){h.showTagBox=!1};var l=function(a){return b.monthString(a)},m=function(a,b){var c=a+68569,d=parseInt(4*c/146097);c-=parseInt((146097*d+3)/4);var e=parseInt(4e3*(c+1)/1461001);c=c-parseInt(1461*e/4)+31;var f=parseInt(80*c/2447);b.day=c-parseInt(2447*f/80),c=parseInt(f/11),b.month=f+2-12*c,b.year=100*(d-49)+e+c,b.dow=a%7},n=function(a,b){b.hours=parseInt(a/3600),a%=3600,b.minutes=parseInt(a/60),a%=60,b.seconds=a};h.formatDate=function(a,b){m(a,h.date);var c=h.date.year>0?"":" a.C.",d=l(h.date.month)+" "+Math.abs(h.date.year)+c,e=h.date.day+" "+d;if(b){var f={};n(b,f),e+=" "+f.hours+":",e+=f.minutes<10?"0"+f.minutes:f.minutes}return e},h.newPost.julianDayNumber?h.newPost.formattedDate=h.formatDate(h.newPost.julianDayNumber,h.newPost.timeNumber):h.newPost.formattedDate=b.insertHistoricalDate,h.updatePositionPost=function(){var a=null;h.scenario.history.mapId&&(a={url:b.urlMedia(h.scenario.history.mapId)}),c.showModalOpenMap(h.newPost,a)},h.addImageToNewPost=function(a){o(a,!0)},h.removeImage=function(b){var d=angular.copy(b.id);c.showModalDeleteResource(b).then(function(b){a.deleteMedia(d,h.post.id).then(function(a){for(var b=0;b<h.newPost.image.length;b++)h.newPost.image[b].id==d&&h.newPost.image.splice(b,1)},function(a){console.log("Impossibile eliminare immagine")})},function(a){console.log("Eliminazione annullata")})},h.getMedia=function(a){return b.urlMediaThumb(a)},h.addFileToNewPost=function(a){o(a,!1)},h.removeFile=function(b){var d=angular.copy(b.id);c.showModalDeleteResource(b).then(function(b){a.deleteMedia(d,h.post.id).then(function(a){for(var b=0;b<h.newPost.file.length;b++)h.newPost.file[b].id==d&&h.newPost.file.splice(b,1)},function(a){console.log("Impossibile eliminare file");
})},function(a){console.log("Eliminazione annullata")})};var o=function(a,c){a&&a.length&&d.upload({url:b.urlMediaScenarioPost(h.scenario.id),headers:{"Content-Type":a.type},file:a}).then(function(a){if(c){var b={};b.id=a.data.id,b.name=a.config.file[0].name,h.newPost.image.push(b)}else{var b={};b.id=a.data.id,b.name=a.config.file[0].name,j(b),h.newPost.file.push(b)}},function(a){console.log("Impossibile effettuare l'upload")})};h.search=function(a,c){var d;h.suggestions=new Array,c?d=h.scenario.characters:(h.scenario.attendees&&(d=h.scenario.attendees),h.scenario.collaborators&&d.push.apply(h.scenario.collaborators),d.push(h.scenario.teacherCreator));var e=new RegExp("(^|\\s|-|'|,|.)"+a,"gi");if(d)if(c){if(!c)throw new Error("Unsupported type");if(!h.scenario.id)throw new Error("Unsupported type");for(var g=0;g<d.length;g++)if(e.test(d[g].name)){var i={};i.name=d[g].name,i.id=d[g].id,i.cover=b.urlCharacterCover(h.scenario.id,d[g].id),h.suggestions.push(i)}}else for(var g=0;g<d.length;g++)if(e.test(d[g].firstname)||e.test(d[g].lastname)){var i={};i.name=d[g].lastname+" "+d[g].firstname,i.id=d[g].id,i.cover=b.urlUserCover(d[g].id),h.suggestions.push(i)}var j=f.defer();return j.resolve(h.suggestions),j.promise};var p=function(){return!(!h.newPost.julianDayNumber||!h.newPost.timeNumber)};h.draftNewPost=function(c){var d=!0,f={};if(c?p()?f.status="PUBLISHED":(h.setDateNewPost(),d=!1):f.status="DRAFT",d&&h.sendPostEnable&&h.newPost.text){h.sendPostEnable=!1,f.text=h.newPost.text,f.julianDayNumber=h.newPost.julianDayNumber,f.timeNumber=h.newPost.timeNumber,f.place=h.newPost.place,f.imageMetaId=new Array,f.fileMetaId=new Array,f.tags=new Array;for(var g=0;g<h.newPost.image.length;g++)f.imageMetaId.push(h.newPost.image[g].id);for(var g=0;g<h.newPost.file.length;g++)f.fileMetaId.push(h.newPost.file[g].id);for(var g=0;g<h.newPost.tags.length;g++)f.tags.push(h.newPost.tags[g].id);h.post.character?a.updateStatus(h.scenario.id,h.post.id,f).then(function(a){h.sendPostEnable=!0,h.post=a;for(var d=0;d<h.posts.length;d++)if(h.posts[d].id==h.post.id){h.posts[d]=h.post,h.posts[d].character.cover=b.urlCharacterCover(h.posts[d].scenarioId,h.posts[d].character.id);break}c&&e.go("logged.scenario.posts",{id:h.scenario.id})},function(a){h.sendPostEnable=!0,console.log("error in send status: "+a)}):a.updateEvent(h.scenario.id,h.post.id,f).then(function(a){h.sendPostEnable=!0,h.post=a;for(var b=0;b<h.posts.length;b++)if(h.posts[b].id==h.post.id){h.posts[b]=h.post;break}c&&e.go("logged.scenario.posts",{id:h.scenario.id})},function(a){h.sendPostEnable=!0,console.log("error in send status: "+a)})}else angular.element(document.querySelector("#textContentStatus")).focus()},h.deletePost=function(){c.showModalDeletePost().then(function(b){a.deletePost(h.scenario.id,h.post.id).then(function(a){for(var b=0;b<h.posts.length;b++)if(h.posts[b].id==h.post.id){h.posts.splice(b,1);break}e.go("logged.dashboard.draft")})},function(a){console.log("DELETE CANCELED")})}}],controllerAs:"editDraftPost",bindToController:!0,link:function(a,b,c,d){a.$watch("editDraftPost.newPost.image.length",function(a){a>0?d.colorImageMarker={color:"#89b151"}:d.colorImageMarker={color:"dark grey"}}),a.$watch("editDraftPost.newPost.file.length",function(a){a>0?d.colorFileMarker={color:"#89b151"}:d.colorFileMarker={color:"dark grey"}}),a.$watch("editDraftPost.newPost.place",function(a,b){a&&a.x&&a.y?d.colorMapMarker={color:"#89b151"}:d.colorMapMarker={color:"dark grey"}}),a.$watch("editDraftPost.newPost.tags.length",function(a){if(a>0){d.tagIsSet=!0,d.colorTagsMarker={color:"#89b151"},d.stringTags="";for(var b=0;a>b;b++){if(b>=2){d.stringTags+=" e altri personaggi";break}a-1>b?d.stringTags+=""+d.newPost.tags[b].name+", ":d.stringTags+=""+d.newPost.tags[b].name}}else d.colorTagsMarker={color:"dark grey"},d.stringTags="",d.tagIsSet=!1})}}}]),angular.module("smiled.application").directive("errSrc",[function(){return{link:function(a,b,c){b.bind("error",function(){c.src!=c.errSrc&&c.$set("src",c.errSrc)})}}}]),angular.module("smiled.application").directive("forminput",["$compile",function(a){var b=function(a){var b=a.querySelector("input, textArea, select"),c=b.getAttribute("type"),d=b.getAttribute("name");return"checkbox"!==c&&"radio"!==c&&b.classList.add("form-control"),d},c=function(a,b){return function(){return b&&a[b]&&a[b].$invalid&&a[b].$dirty?a[b].$invalid:void 0}},d=function(a){return function(b){b?a.removeClass("has-success").addClass("has-error"):a.removeClass("has-error").addClass("has-success")}},e=function(a,b,e,f,g){var h="<div class='help-block' ng-messages='"+a.$name+"."+e+".$error' ng-messages-include='assets/public/partials/messages.html'></div>";b.append(f(h)(g)),g.$watch(c(a,e),d(b))},f=function(a){return function(c,d,f,g){var h=b(d[0]);e(g,d,h,a,c)}};return{restrict:"A",require:"^form",link:f(a)}}]),angular.module("smiled.application").directive("hideOnHoverParent",function(){return{link:function(a,b,c){b.parent().bind("mouseenter",function(){b.hide()}),b.parent().bind("mouseleave",function(){b.show()})}}}),angular.module("smiled.application").directive("historicaldate",[function(){return{restrict:"AE",templateUrl:"assets/private/partials/historicalDate.html",scope:!0,controller:function(a){a.removeAlert=function(a){alertingGeneric.removeAlert(a)}},link:function(a){a.currentAlerts=alertingGeneric.currentAlerts}}}]),angular.module("smiled.application").directive("historicalDatePicker",["CONSTANTS",function(a){return{restrict:"AE",templateUrl:"assets/public/partials/historicalDatePicker.html",scope:{date:"="},controller:function(){var b=this;b.months=a.getMonths("it"),b.getDays=function(){b.days=a.getDays(b.date.month)},b.date&&b.date.month?b.days=a.getDays(b.date.month):b.days=a.getDays(1)},controllerAs:"vm",bindToController:!0,link:function(b,c,d){b.$watch("vm.date",function(b,c){if(b&&b.year&&b.month&&b.day){var d;d=b.afterChrist?"D.C.":"A.C.",b.formatted=b.day+" "+a.monthString(b.month)+" "+b.year+" "+d}},!0)}}}]),angular.module("smiled.application").directive("insertEvent",["CONSTANTS","apiService","Upload","$q","modalService","alertingScenario",function(a,b,c,d,e,f){return{templateUrl:"assets/private/partials/insert-event-template.html",scope:{posts:"=",scenario:"="},bindToController:!0,controller:["$scope",function(){var g=this;g.startDate=angular.copy(g.scenario.history.startDate),g.startDate.afterChrist||(g.startDate.year*=-1),g.endDate=angular.copy(g.scenario.history.endDate),g.endDate.afterChrist||(g.endDate.year*=-1),g.newPost={},g.newPost.julianDayNumber="",g.newPost.timeNumber="",g.newPost.formattedDate=a.insertHistoricalDate,g.newPost.image=new Array,g.newPost.file=new Array,g.newPost.tags=new Array,g.showViewToSelectType=!1,g.newPost.type=null,g.sendPostEnable=!0,g.showDatePicker=!1,g.setDateNewPost=function(){e.showModalSetHistoryDate(g.startDate,g.endDate,g.newPost)};var h=function(){return!(!g.newPost.julianDayNumber||!g.newPost.timeNumber)};g.savePost=function(){if(h())if(g.sendPostEnable&&g.newPost.content){g.sendPostEnable=!1;var c={};c.text=g.newPost.content,c.julianDayNumber=g.newPost.julianDayNumber,c.timeNumber=g.newPost.timeNumber,c.status="PUBLISHED",c.type=g.newPost.type,c.imageMetaId=new Array,c.fileMetaId=new Array,c.tags=new Array,c.place=g.newPost.place;for(var d=0;d<g.newPost.image.length;d++)c.imageMetaId.push(g.newPost.image[d].id);for(var d=0;d<g.newPost.file.length;d++)c.fileMetaId.push(g.newPost.file[d].id);for(var d=0;d<g.newPost.tags.length;d++)c.tags.push(g.newPost.tags[d].id);b.sendEvent(g.scenario.id,c).then(function(c){g.newPost.content="",g.newPost.image=[],g.newPost.file=[],g.newPost.place=null,g.newPost.tags=[],g.newPost.date="",g.newPost.julianDayNumber="",g.newPost.timeNumber="",g.newPost.formattedDate=a.insertHistoricalDate,g.sendPostEnable=!0,b.getSingleStatus(g.scenario.id,c.id).then(function(b){if(g.posts.unshift(b),g.posts[0].imageMetaId){g.posts[0].imagesUrl=new Array;for(var c=0;c<g.posts[0].imageMetaId.length;c++)g.posts[0].imagesUrl[c].push(a.urlMedia(g.posts[0].imageMetaId[c]))}},function(a){console.log("error in insert new event in array")})},function(a){g.sendPostEnable=!0,console.log("error in send event: "+a)})}else angular.element(document.querySelector("#textContentStatus")).focus();else g.setDateNewPost()},g.draftNewPost=function(){if(g.sendPostEnable&&g.newPost.content){g.sendPostEnable=!1;var c={};c.text=g.newPost.content,c.julianDayNumber=g.newPost.julianDayNumber,c.timeNumber=g.newPost.timeNumber,c.status="DRAFT",c.place=g.newPost.place,c.imageMetaId=new Array,c.fileMetaId=new Array,c.tags=new Array;for(var d=0;d<g.newPost.image.length;d++)c.imageMetaId.push(g.newPost.image[d].id);for(var d=0;d<g.newPost.file.length;d++)c.fileMetaId.push(g.newPost.file[d].id);for(var d=0;d<g.newPost.tags.length;d++)c.tags.push(g.newPost.tags[d].id);b.sendEvent(g.scenario.id,c).then(function(b){g.newPost.content="",g.newPost.image=[],g.newPost.file=[],g.newPost.julianDayNumber="",g.newPost.timeNumber="",g.newPost.formattedDate=a.insertHistoricalDate,g.sendPostEnable=!0,g.newPost.place=null,g.newPost.tags=[],f.addSuccess("Bozza salvata con successo.")},function(a){g.sendPostEnable=!0,console.log("error in send status: "+a),f.addWarning("Impossibile salvare la bozza. Riprova per favore.")})}else angular.element(document.querySelector("#textContentEvent")).focus()},g.addImageToNewPost=function(a){i(a,!0)},g.removeImage=function(a){var c=angular.copy(a.id);b.deleteMedia(c).then(function(a){for(var b=0;b<g.newPost.image.length;b++)g.newPost.image[b].id==c&&g.newPost.image.splice(b,1)},function(a){console.log("Impossibile eliminare immagine")})},g.addFileToNewPost=function(a){i(a,!1)},g.removeFile=function(a){var c=angular.copy(a.id);b.deleteMedia(c).then(function(a){for(var b=0;b<g.newPost.file.length;b++)g.newPost.file[b].id==c&&g.newPost.file.splice(b,1)},function(a){console.log("Impossibile eliminare file")})};var i=function(b,d){b&&b.length&&(d&&"image/png"!=b[0].type&&"image/gif"!=b[0].type&&"image/jpg"!=b[0].type&&"image/jpeg"!=b[0].type?f.addWarning("Formato non valido per le immagini."):c.upload({url:a.urlMediaScenarioPost(g.scenario.id),headers:{"Content-Type":b.type},file:b}).then(function(a){if(d){var b={};b.id=a.data.id,b.name=a.config.file[0].name,g.newPost.image.push(b)}else{var b={};b.id=a.data.id,b.name=a.config.file[0].name;var c=b.name.split("."),e=c[c.length-1];b.fileType=null,"jpg"==e||"jpeg"==e||"png"==e||"gif"==e?b.fileType="img":"pdf"==e?b.fileType="pdf":"doc"==e||"docx"==e||"odt"==e||"txt"==e?b.fileType="doc":"ppt"==e||"pptx"==e||"odp"==e?b.fileType="ppt":"xls"!=e&&"xlsx"!=e&&"ods"!=e||(b.fileType="excel"),g.newPost.file.push(b)}},function(a){"400"==a.status||"406"==a.status?f.addWarning("Formato non supportato."):f.addWarning("C'è stato un errore, non è stato possibile caricare il file. Riprova per favore.")}))};g.search=function(b,c){var e;g.suggestions=new Array,c?e=g.scenario.characters:(g.scenario.attendees&&(e=g.scenario.attendees),g.scenario.collaborators&&e.push.apply(g.scenario.collaborators),e.push(g.scenario.teacherCreator));var f=new RegExp("(^|\\s|-|'|,|.)"+b,"gi");if(e)if(c){if(!c)throw new Error("Unsupported type");if(!g.scenario.id)throw new Error("Unsupported type");for(var h=0;h<e.length;h++)if(f.test(e[h].name)){var i={};i.name=e[h].name,i.id=e[h].id,i.cover=a.urlCharacterCover(g.scenario.id,e[h].id),g.suggestions.push(i)}}else for(var h=0;h<e.length;h++)if(f.test(e[h].firstname)||f.test(e[h].lastname)){var i={};i.name=e[h].lastname+" "+e[h].firstname,i.id=e[h].id,i.cover=a.urlUserCover(e[h].id),g.suggestions.push(i)}var j=d.defer();return j.resolve(g.suggestions),j.promise},g.getMedia=function(b){return a.urlMedia(b)},g.colorTagsMarker={},g.stringTags="",g.tagIsSet=!1,g.showTagBox=!1,g.switchShowTagBox=function(){g.showTagBox=!g.showTagBox},g.hideTagBox=function(){g.showTagBox=!1},g.colorMapMarker={},g.setPositionNewPost=function(){var b;b=g.scenario.history.mapId?{url:a.urlMedia(g.scenario.history.mapId)+".jpg"}:null,e.showModalOpenMap(g.newPost,b)},g.showSelectType=function(){g.showViewToSelectType=!g.showViewToSelectType},g.hideType=function(){g.showViewToSelectType=!1}}],controllerAs:"insertEvent",link:function(a,b,c,d){a.$watch("insertEvent.newPost.image.length",function(a){a>0?d.colorImageMarker={color:"#89b151"}:d.colorImageMarker={color:"dark grey"}}),a.$watch("insertEvent.newPost.file.length",function(a){a>0?d.colorFileMarker={color:"#89b151"}:d.colorFileMarker={color:"dark grey"}}),a.$watch("insertEvent.newPost.place",function(a){a&&a.x&&a.y?d.colorMapMarker={color:"#89b151"}:d.colorMapMarker={color:"dark grey"}}),a.$watch("insertEvent.newPost.date",function(a){a&&a.x&&a.y?d.colorMapMarker={color:"#89b151"}:d.colorMapMarker={color:"dark grey"}}),a.$watch("insertEvent.newPost.tags.length",function(a){if(a>0){d.colorTagsMarker={color:"#89b151"},d.tagIsSet=!0,d.stringTags="";for(var b=0;a>b;b++){if(b>=2){d.stringTags+=" e altri personaggi";break}a-1>b?d.stringTags+=""+d.newPost.tags[b].name+", ":d.stringTags+=""+d.newPost.tags[b].name}}else d.colorTagsMarker={color:"dark grey"},d.tagIsSet=!1,d.stringTags=""}),a.$watch("insertEvent.newPost.type.length",function(a){a>0?d.colorTypeMarker={color:"#89b151"}:d.colorTypeMarker={color:"dark grey"}})}}}]),angular.module("smiled.application").directive("insertMission",["CONSTANTS","apiService","Upload","$q","modalService","$timeout",function(a,b,c,d,e,f){return{templateUrl:"assets/private/partials/insert-mission-template.html",scope:{idScenarioVeloce:"@?",scenario:"=",character:"=?",isModerator:"=",isCreator:"="},bindToController:!0,controller:["$scope",function(){var c=this;c.dirty=!1,c.realDateFormat=a.realDateFormatWithHour,c.isModerator||c.isCreator?c.formMission=!1:c.formMission=!0,c.openFormMission=function(){c.formMission=!0},c.closeFormMission=function(){c.formMission=!1},c.character?(c.character.mission?(c.mission=c.character.mission,c.newMission=angular.copy(c.mission)):(c.mission=null,c.newMission=null),c.urlCover="url('"+a.urlCharacterCover(c.scenario.id,c.character.id)+"'),url('assets/public/img/icon/pg.png')"):(c.urlCover="url('"+a.urlScenarioCover(c.idScenarioVeloce)+"'),url('assets/public/img/icon/ic_scen.png')",c.scenario.mission?(c.mission=c.scenario.mission,c.newMission=angular.copy(c.mission)):(c.mission=null,c.newMission=null)),c.saveMission=function(){c.character?b.addMissionToCharacter(c.scenario.id,c.character.id,c.newMission).then(function(a){c.character=a,c.mission=c.character.mission,c.newMission=angular.copy(c.mission),c.dirty=!1},function(a){console.log("error in add mission to character"),c.newMission=angular.copy(c.mission),c.dirty=!1}):b.addMissionToScenario(c.scenario.id,c.newMission).then(function(a){c.scenario=a,c.mission=c.scenario.mission,c.newMission=angular.copy(c.mission),c.dirty=!1},function(a){console.log("error in add mission to scenario"),c.newMission=angular.copy(c.mission),c.dirty=!1})},c.deleteModifyMission=function(){c.newMission=angular.copy(c.mission),f(function(){c.dirty=!1},200)},c.deleteMission=function(){c.character?b.deleteMissionToCharacter(c.scenario.id,c.character.id).then(function(a){c.mission=null,c.newMission=null,c.dirty=!1},function(a){console.log("error in delete mission to character"),c.newMission=null,c.dirty=!1}):b.deleteMissionToScenario(c.scenario.id).then(function(a){c.mission=null,c.newMission=null,c.dirty=!1},function(a){console.log("error in delete mission to scenario"),c.mission=null,c.newMission=null,c.dirty=!1})}}],controllerAs:"insertMission",link:function(a,b,c,d){a.$watch("insertMission.newMission.title",function(a,b){a&&a!=b&&(d.dirty=!0)}),a.$watch("insertMission.newMission.description",function(a,b){a&&a!=b&&(d.dirty=!0)}),a.$watch("insertMission.scenario.mission.title",function(a,b){a&&a!=b&&!d.character&&(d.mission.title=a,d.newMission.title=a)}),a.$watch("insertMission.scenario.mission.description",function(a,b){a&&a!=b&&!d.character&&(d.mission.description=a,d.newMission.description=a)})}}}]),angular.module("smiled.application").directive("insertPost",[function(){return{templateUrl:"assets/private/partials/insert-post-template.html",scope:{character:"=",posts:"=",scenario:"=",hasCharacter:"=",isModerator:"="},bindToController:!0,controller:["$scope",function(){var a=this;a.showBoxEvent=!0}],controllerAs:"insertPost"}}]),angular.module("smiled.application").directive("insertStatus",["CONSTANTS","apiService","Upload","$q","modalService","alertingScenario",function(a,b,c,d,e,f){return{templateUrl:"assets/private/partials/insert-status-template.html",scope:{character:"=",posts:"=",scenario:"="},bindToController:!0,controller:["$scope",function(){var g=this;g.startDate=angular.copy(g.scenario.history.startDate),g.startDate.afterChrist||(g.startDate.year*=-1),g.endDate=angular.copy(g.scenario.history.endDate),g.endDate.afterChrist||(g.endDate.year*=-1),g.newPost={},g.newPost.formattedDate=a.insertHistoricalDate,g.newPost.julianDayNumber="",g.newPost.timeNumber="",g.newPost.image=new Array,g.newPost.file=new Array,g.newPost.tags=new Array,g.sendPostEnable=!0,g.character&&g.character.id?g.showInsertStatus=!0:g.showInsertStatus=!1,g.showDatePicker=!1,g.setDateNewPost=function(){e.showModalSetHistoryDate(g.startDate,g.endDate,g.newPost)};var h=function(){return!(!g.newPost.julianDayNumber||!g.newPost.timeNumber)};g.savePost=function(){if(h())if(g.sendPostEnable&&g.newPost.content){g.sendPostEnable=!1;var c={};c.text=g.newPost.content,c.julianDayNumber=g.newPost.julianDayNumber,c.timeNumber=g.newPost.timeNumber,c.status="PUBLISHED",c.place=g.newPost.place,c.imageMetaId=new Array,c.fileMetaId=new Array,c.tags=new Array;for(var d=0;d<g.newPost.image.length;d++)c.imageMetaId.push(g.newPost.image[d].id);for(var d=0;d<g.newPost.file.length;d++)c.fileMetaId.push(g.newPost.file[d].id);for(var d=0;d<g.newPost.tags.length;d++)c.tags.push(g.newPost.tags[d].id);b.sendStatus(g.scenario.id,g.character.id,c).then(function(c){g.newPost.content="",g.newPost.image=[],g.newPost.file=[],g.newPost.julianDayNumber="",g.newPost.timeNumber="",g.newPost.formattedDate=a.insertHistoricalDate,g.sendPostEnable=!0,g.newPost.place=null,g.newPost.tags=[],b.getSingleStatus(g.scenario.id,c.id).then(function(b){if(g.posts.unshift(b),g.posts[0].imageMetaId){g.posts[0].imagesUrl=new Array;for(var c=0;c<g.posts[0].imageMetaId.length;c++)g.posts[0].imagesUrl[c].push(a.urlMedia(g.posts[0].imageMetaId[c]))}g.posts[0].character.cover=a.urlCharacterCover(g.scenario.id,g.posts[0].character.id)},function(a){console.log("error in insert new post in array"+a)})},function(a){g.sendPostEnable=!0,console.log("error in send status: "+a)})}else angular.element(document.querySelector("#textContentStatus")).focus();else g.setDateNewPost()},g.draftNewPost=function(){if(g.sendPostEnable&&g.newPost.content){g.sendPostEnable=!1;var c={};c.text=g.newPost.content,c.julianDayNumber=g.newPost.julianDayNumber,c.timeNumber=g.newPost.timeNumber,c.status="DRAFT",c.place=g.newPost.place,c.imageMetaId=new Array,c.fileMetaId=new Array,c.tags=new Array;for(var d=0;d<g.newPost.image.length;d++)c.imageMetaId.push(g.newPost.image[d].id);for(var d=0;d<g.newPost.file.length;d++)c.fileMetaId.push(g.newPost.file[d].id);for(var d=0;d<g.newPost.tags.length;d++)c.tags.push(g.newPost.tags[d].id);b.sendStatus(g.scenario.id,g.character.id,c).then(function(b){g.newPost.content="",g.newPost.image=[],g.newPost.file=[],g.newPost.julianDayNumber="",g.newPost.timeNumber="",g.newPost.formattedDate=a.insertHistoricalDate,g.sendPostEnable=!0,g.newPost.place=null,g.newPost.tags=[],f.addSuccess("Bozza salvata con successo.")},function(a){g.sendPostEnable=!0,console.log("error in send status: "+a),f.addWarning("Impossibile salvare la bozza. Riprova per favore.")})}else angular.element(document.querySelector("#textContentStatus")).focus()},g.addImageToNewPost=function(a){i(a,!0)},g.removeImage=function(a){var c=angular.copy(a.id);b.deleteMedia(c).then(function(a){for(var b=0;b<g.newPost.image.length;b++)g.newPost.image[b].id==c&&g.newPost.image.splice(b,1)},function(a){console.log("Impossibile eliminare immagine")})},g.getMedia=function(b){return a.urlMedia(b)},g.addFileToNewPost=function(a){i(a,!1)},g.removeFile=function(a){var c=angular.copy(a.id);b.deleteMedia(c).then(function(a){for(var b=0;b<g.newPost.file.length;b++)g.newPost.file[b].id==c&&g.newPost.file.splice(b,1)},function(a){console.log("Impossibile eliminare file")})};var i=function(b,d){b&&b.length&&(d&&"image/png"!=b[0].type&&"image/gif"!=b[0].type&&"image/jpg"!=b[0].type&&"image/jpeg"!=b[0].type?f.addWarning("Formato non valido per le immagini."):c.upload({url:a.urlMediaScenarioPost(g.scenario.id),headers:{"Content-Type":b.type},file:b}).then(function(a){if(d){var b={};b.id=a.data.id,b.name=a.config.file[0].name,g.newPost.image.push(b)}else{var b={};b.id=a.data.id,b.name=a.config.file[0].name;var c=b.name.split("."),e=c[c.length-1];b.fileType=null,"jpg"==e||"jpeg"==e||"png"==e||"gif"==e?b.fileType="img":"pdf"==e?b.fileType="pdf":"doc"==e||"docx"==e||"odt"==e||"txt"==e?b.fileType="doc":"ppt"==e||"pptx"==e||"odp"==e?b.fileType="ppt":"xls"!=e&&"xlsx"!=e&&"ods"!=e||(b.fileType="excel"),g.newPost.file.push(b)}},function(a){"400"==a.status||"406"==a.status?f.addWarning("Formato non supportato."):f.addWarning("C'è stato un errore, non è stato possibile caricare il file. Riprova per favore.")}))};g.search=function(b,c){var e;g.suggestions=new Array,c?e=g.scenario.characters:(g.scenario.attendees&&(e=g.scenario.attendees),g.scenario.collaborators&&e.push.apply(g.scenario.collaborators),e.push(g.scenario.teacherCreator));var f=new RegExp("(^|\\s|-|'|,|.)"+b,"gi");if(e)if(c){if(!c)throw new Error("Unsupported type");if(!g.scenario.id)throw new Error("Unsupported type");for(var h=0;h<e.length;h++)if(f.test(e[h].name)){var i={};i.name=e[h].name,i.id=e[h].id,i.cover=a.urlCharacterCover(g.scenario.id,e[h].id),g.suggestions.push(i)}}else for(var h=0;h<e.length;h++)if(f.test(e[h].firstname)||f.test(e[h].lastname)){var i={};i.name=e[h].lastname+" "+e[h].firstname,i.id=e[h].id,i.cover=a.urlUserCover(e[h].id),g.suggestions.push(i)}var j=d.defer();return j.resolve(g.suggestions),j.promise},g.colorTagsMarker={},g.stringTags="",g.tagIsSet=!1,g.showTagBox=!1,g.switchShowTagBox=function(){g.showTagBox=!g.showTagBox},g.hideTagBox=function(){g.showTagBox=!1},g.colorMapMarker={},g.setPositionNewPost=function(){var b;b=g.scenario.history.mapId?{url:a.urlMedia(g.scenario.history.mapId)}:null,e.showModalOpenMap(g.newPost,b)}}],controllerAs:"insertStatus",link:function(a,b,c,d){a.$watch("insertStatus.newPost.image.length",function(a){a>0?d.colorImageMarker={color:"#89b151"}:d.colorImageMarker={color:"dark grey"}}),a.$watch("insertStatus.newPost.file.length",function(a){a>0?d.colorFileMarker={color:"#89b151"}:d.colorFileMarker={color:"dark grey"}}),a.$watch("insertStatus.newPost.place",function(a,b){a&&a.x&&a.y?d.colorMapMarker={color:"#89b151"}:d.colorMapMarker={color:"dark grey"}}),a.$watch("insertStatus.newPost.tags.length",function(a){if(a>0){d.tagIsSet=!0,d.colorTagsMarker={color:"#89b151"},d.stringTags="";for(var b=0;a>b;b++){if(b>=2){d.stringTags+=" e altri personaggi";break}a-1>b?d.stringTags+=""+d.newPost.tags[b].name+", ":d.stringTags+=""+d.newPost.tags[b].name}}else d.colorTagsMarker={color:"dark grey"},d.stringTags="",d.tagIsSet=!1})}}}]),angular.module("smiled.application").directive("likeTo",["apiService",function(a){return{templateUrl:"assets/private/partials/like-to-template.html",scope:{liker:"=",post:"=",scenarioId:"@"},controller:function(){var b=this;b.numLike=b.post.likes.length,b.likePost=function(c){b.liker.id&&a.addLikeToPost(b.scenarioId,b.post.id).then(function(a){if(c.youLike){for(var d=0;d<c.likes.length;d++)if(c.likes[d].id==b.liker.id){c.likes.splice(d,1),b.numLike--;break}}else c.likes.push(b.liker),b.numLike++;c.youLike=!c.youLike},function(a){console.log("Error in like")})}},controllerAs:"likeTo",bindToController:!0}}]),angular.module("smiled.application").directive("mapPostView",["CONSTANTS",function(a){return{restrict:"A",scope:{post:"=",map:"@"},link:function(b,c,d){var e=c[0].getContext("2d"),f=e.canvas,g=new Image;g.src=a.urlMarker,f.width=700;var h=new Image;h.src=b.map;var i,j=-1,k=-1,l=40;h.onload=function(){var a=(h.width/h.height,h.height*f.width/h.width);if(f.height=a,e.drawImage(h,0,0,h.width,h.height,0,0,f.width,a),i=e.getImageData(0,0,f.width,f.height),b.post.place){var c=b.post.place.x*f.width-l/2,d=b.post.place.y*f.height-l;e.drawImage(g,c,d,l,l),j=c,k=d}}}}}]),angular.module("smiled.application").directive("mapScenario",["CONSTANTS","$timeout","$document","dateUtil",function(a,b,c,d){return{restrict:"A",scope:{posts:"=",slideNumber:"=",map:"@",start:"=",end:"=",bars:"=",actual:"="},controller:function(){var a=this;a.toShowPost=new Array;var b,c=function(a,b){var c=parseInt(a.julianDayNumber),d=parseInt(b.julianDayNumber);if(a.timeNumber)var e=parseInt(a.timeNumber);else var e=0;if(b.timeNumber)var f=parseInt(b.timeNumber);else var f=0;return d>c?-1:c>d?1:f>e?-1:e>f?1:0},e=function(){if(b.length){b.sort(c),a.start=d.dateTimeToStringShort(b[0].julianDayNumber,b[0].timeNumber),a.end=d.dateTimeToStringShort(b[b.length-1].julianDayNumber,b[b.length-1].timeNumber);var e=0;b[0].timeNumber&&(e+=parseInt(b[0].timeNumber/60));var f=24*(b[b.length-1].julianDayNumber-b[0].julianDayNumber)*60;b[b.length-1].timeNumber&&(f+=parseInt(b[b.length-1].timeNumber/60));for(var g=(f-e)/100,h=g,i=0,j=0;100>j&&i<b.length;){var k=0;a.toShowPost[j]=new Array;var l=24*(b[i].julianDayNumber-b[0].julianDayNumber)*60;for(b[i].timeNumber&&(l+=parseInt(b[i].timeNumber/60));e+g>=l&&(a.toShowPost[j][k]=b[i],k++,i++,i<b.length);)l=24*(b[i].julianDayNumber-b[0].julianDayNumber)*60,b[i].timeNumber&&(l+=parseInt(b[i].timeNumber/60));j++,g+=h}}a.bars=new Array;for(var i=0;100>i;i++)a.toShowPost[i]?a.bars[i]=a.toShowPost[i].length:a.bars[i]=0};a.posts.then(function(a){b=angular.copy(a.content),e()},function(a){console.log("Error in retrieve post")})},controllerAs:"dirMapScenario",bindToController:!0,link:function(b,c,e,f){var g=c[0].getContext("2d"),h=g.canvas,i=new Image;i.src=a.urlMarker,h.style.width="100%",h.style.height="100%";var j=angular.element(document.querySelector("#container-canvas"));h.width=j.width(),h.height=j.height();var k=new Image;k.src=f.map;var l,m=40;k.onload=function(){var a=(k.width/k.height,k.height*h.width/k.width);h.height=a,g.drawImage(k,0,0,k.width,k.height,0,0,h.width,a),l=g.getImageData(0,0,h.width,h.height)};var n=function(a){if(f.toShowPost){for(var b=0;a>b;b++)if(f.toShowPost[b]){var c=Math.exp(.0135*(b-a+1));g.globalAlpha=c;for(var e=0;e<f.toShowPost[b].length;e++)if(f.toShowPost[b][e].place){var j=f.toShowPost[b][e].place.x*h.width-m/2,k=f.toShowPost[b][e].place.y*h.height-m;g.drawImage(i,j,k,m,m)}g.globalAlpha=1}f.toShowPost&&f.toShowPost[a-1]&&f.toShowPost[a-1][0]?(f.actual=d.dateTimeToStringShort(f.toShowPost[a-1][0].julianDayNumber,f.toShowPost[a-1][0].timeNumber),f.actual+=" ("+f.toShowPost[a-1].length+")"):f.actual=""}};b.$watch("dirMapScenario.slideNumber",function(a,b){b&&(g.putImageData(l,0,0),0!=a&&a>b?n(a):0!=a&&b>a&&n(a))})}}}]),angular.module("smiled.application").directive("metaCommentTo",["apiService","CONSTANTS","notifyService",function(a,b,c){return{templateUrl:"assets/private/partials/meta-comment-to-template.html",scope:{post:"=",writer:"=",scenarioId:"@",loggedUser:"="},controller:["$scope",function(c){var d=this,e=b.visibleComment,d=this;d.showViewOthers=!1,d.atLeastOneCommentWasSended=!1,d.visibleComments=new Array;for(var f=0;f<d.post.metaComments.length&&e>f;)d.visibleComments.unshift(d.post.metaComments[f]),f++;d.post.metaComments.length>e&&(d.showViewOthers=!0),d.openViewOthers=function(){d.visibleComments=angular.copy(d.post.metaComments),d.visibleComments.reverse(),d.showViewOthers=!1},d.addMetaCommentToPost=function(){if(d.post.newMetaComment){var b={};b.text=d.post.newMetaComment,a.sendMetaCommentToPost(d.scenarioId,d.post.id,b).then(function(a){b.creationDate=new Date,b.user={},b.user.id=d.loggedUser.id,b.user.firstname=d.loggedUser.firstName,b.user.lastname=d.loggedUser.lastName,d.post.metaComments.splice(0,0,b),d.post.newMetaComment=""},function(a){console.log("fail to send comment: "+a)})}}}],controllerAs:"metaCommentTo",bindToController:!0,link:function(a,b,d,e){a.$watch("metaCommentTo.post.metaComments.length",function(a,b){a!=b&&(e.showViewOthers?e.visibleComments.push(e.post.metaComments[0]):e.openViewOthers())}),a.$watch("metaCommentTo.post.newMetaComment.length",function(a,b){a>0&&(0==b||void 0==b)?c.addToInEditPost(e.post.id):(0==a||void 0==a)&&b>0&&c.removeToInEditPost(e.post.id)}),a.$on("$destroy",function(){e.post.newMetaComment="",c.removeToInEditPost(e.post.id)})}}}]),angular.module("smiled.application").directive("pinPointCanvas",["CONSTANTS","$q",function(a,b){return{restrict:"A",scope:{post:"=",map:"@"},link:function(c,d,e){var f=d[0].getContext("2d"),g=f.canvas;g.width=700;var h=new Image;h.src=c.map;var i=-1,j=-1,k=new Image;k.src=a.urlMarker;var l,m=40,n=b.defer();h.onload=function(){var a=(h.width/h.height,h.height*g.width/h.width);g.height=a,f.drawImage(h,0,0,h.width,h.height,0,0,g.width,a),l=f.getImageData(0,0,g.width,g.height),n.resolve()},k.onload=function(){c.post.place&&n.promise.then(function(a){var b=c.post.place.x*g.width-m/2,d=c.post.place.y*g.height-m;f.drawImage(k,b,d,m,m),i=b,j=d})},d.on("click",function(a){var b={};b.x=a.offsetX/g.width,b.y=a.offsetY/g.height,c.post.place=b;var d=a.offsetX-20,e=a.offsetY-40;-1!=i&&-1!=j&&(f.clearRect(0,0,g.width,g.height),f.putImageData(l,0,0)),f.drawImage(k,d,e,m,m),i=d,j=e})}}}]),angular.module("smiled.application").directive("showNewsPost",["CONSTANTS","apiService","Lightbox","modalService","$q","Upload","modalService","notifyService",function(a,b,c,d,e,f,d,g){return{templateUrl:"assets/private/partials/show-news-post-template.html",scope:{post:"=",scenario:"=",mapId:"@",currentCharacter:"=",loggedUser:"="},controller:function(){var h=this,i=5;h.showTagBox=!1,h.editPost=!1,h.deleted=!1,h.postDTO={},h.postDTO.text=h.post.text,h.date={},h.files=new Array,h.originalPost=angular.copy(h.post),h.editButton=!1;var j=function(){if(h.scenario.teacherCreator.id==h.loggedUser.id)return void(h.editButton=!0);if(h.scenario.collaborators)for(var a=0;a<h.scenario.collaborators.length;a++)if(h.scenario.collaborators[a].id==h.loggedUser.id)return void(h.editButton=!0);return h.post.character&&h.post.user.id==h.loggedUser.id&&h.currentCharacter.id==h.post.character.id?void(h.editButton=!0):void 0};j(),h.startDate=angular.copy(h.scenario.history.startDate),h.startDate.afterChrist||(h.startDate.year*=-1),h.endDate=angular.copy(h.scenario.history.endDate),h.endDate.afterChrist||(h.endDate.year*=-1),h.originalTagsList=angular.copy(h.post.tags),h.originalJulianDayNumber=angular.copy(h.post.julianDayNumber),h.newCharactersToTags=new Array,h.switchEditPost=function(){h.editPost=!h.editPost,h.editPost?g.addToInEditPost(h.post.id):g.removeToInEditPost(h.post.id)},h.closeEditPost=function(){h.postDTO={},h.postDTO.text=h.post.text,h.editPost=!h.editPost,h.newCharactersToTags=[],h.post=angular.copy(h.originalPost),h.recalculateMatrix(),g.removeToInEditPost(h.post.id)},h.post.imagesMetadata.length>0&&(h.colorImageMarker={color:"#89b151"}),null!=h.post.place&&(h.colorMapMarker={color:"#89b151"}),h.currentCharacter&&h.currentCharacter.id||(h.classCommentButton="disabled-div"),h.getMediaUrl=function(b){var c=a.urlMedia(b);return c},h.realDateFormat=a.realDateFormatWithHour;var k=function(b){return a.monthString(b)},l=function(a,b){var c=a+68569,d=parseInt(4*c/146097);c-=parseInt((146097*d+3)/4);var e=parseInt(4e3*(c+1)/1461001);c=c-parseInt(1461*e/4)+31;var f=parseInt(80*c/2447);b.day=c-parseInt(2447*f/80),c=parseInt(f/11),b.month=f+2-12*c,b.year=100*(d-49)+e+c,b.dow=a%7},m=function(a,b){b.hours=parseInt(a/3600),a%=3600,b.minutes=parseInt(a/60),a%=60,b.seconds=a};if(h.formatDate=function(a,b){l(a,h.date);var c=h.date.year>0?"":" a.C.",d=k(h.date.month)+" "+Math.abs(h.date.year)+c,e=h.date.day+" "+d;
if(b){var f={};m(b,f),e+=" "+f.hours+":",e+=f.minutes<10?"0"+f.minutes:f.minutes}return e},h.showComment=!1,h.showMetaComment=!1,h.switchShowMetaComment=function(){h.showMetaComment=!h.showMetaComment,h.showMetaComment&&(h.showComment=!1)},h.switchShowComment=function(){h.showComment=!h.showComment,h.showComment&&(h.showMetaComment=!1)},h.post.imagesMetadata){h.post.media=new Array,h.post.media[0]=new Array;for(var n=-1,o=0,p=0;p<h.post.imagesMetadata.length;p++)0!=p&&p%i==0?(n=0,o++,h.post.media[o]=new Array):n++,h.post.media[o][n]=a.urlMediaThumb(h.post.imagesMetadata[p].id),h.post.imagesMetadata[p].url=a.urlMedia(h.post.imagesMetadata[p].id)}h.openPostGallery=function(a,b){var d=a*i+b;h.post.media&&c.openModal(h.post.imagesMetadata,d)},h.post.comments.reverse(),h.post.metaComments.reverse(),h.viewMap=function(){var b={url:a.urlMedia(h.mapId)+".jpg"};d.showModalOpenMapForPost(h.post,b)},h.hideTagBox=function(){h.showTagBox=!1},h.switchShowTagBox=function(){h.showTagBox=!h.showTagBox},h.addImageToPost=function(a){r(a,!0)},h.recalculateMatrix=function(){if(h.post.imagesMetadata.length>0&&(h.colorImageMarker={color:"#89b151"}),null!=h.post.place&&(h.colorMapMarker={color:"#89b151"}),h.currentCharacter&&h.currentCharacter.id||(h.classCommentButton="disabled-div"),h.post.imagesMetadata){h.post.media=new Array,h.post.media[0]=new Array;for(var b=-1,c=0,d=0;d<h.post.imagesMetadata.length;d++)0!=d&&d%i==0?(b=0,c++,h.post.media[c]=new Array):b++,h.post.media[c][b]=a.urlMediaThumb(h.post.imagesMetadata[d].id),h.post.imagesMetadata[d].url=a.urlMedia(h.post.imagesMetadata[d].id)}},h.removeImage=function(a,c){var e=a*i+c;d.showModalDeleteResource(h.post.imagesMetadata[e]).then(function(a){var c=angular.copy(h.post.imagesMetadata[e].id);b.deleteMedia(c,h.post.id).then(function(a){h.post.imagesMetadata.splice(e,1),h.recalculateMatrix();for(var b=0;b<h.originalPost.imagesMetadata.length;b++)h.originalPost.imagesMetadata[b].id==c&&h.originalPost.imagesMetadata.splice(b,1)},function(a){console.log("Impossibile eliminare immagine")})})};var q=function(){h.files.splice(0,h.files.length);for(var a=0;a<h.post.filesMetadata.length;a++){var b={};b.id=h.post.filesMetadata[a].id,b.originalName=h.post.filesMetadata[a].originalName;var c=b.originalName.split("."),d=c[c.length-1];"jpg"==d||"jpeg"==d||"png"==d||"gif"==d?b.fileType="img":"pdf"==d?b.fileType="pdf":"doc"==d||"docx"==d||"odt"==d||"txt"==d?b.fileType="doc":"ppt"==d||"pptx"==d||"odp"==d?b.fileType="ppt":"xls"!=d&&"xlsx"!=d&&"ods"!=d||(b.fileType="excel"),h.files.push(b)}};q(),h.addFileToPost=function(a){r(a,!1)},h.removeFile=function(a){d.showModalDeleteResource(a).then(function(c){b.deleteMedia(a.id,h.post.id).then(function(b){for(var c=0;c<h.post.filesMetadata.length;c++)h.post.filesMetadata[c].id==a.id&&h.post.filesMetadata.splice(c,1);for(var c=0;c<h.files.length;c++)h.files[c].id==a.id&&h.files.splice(c,1);for(var c=0;c<h.originalPost.filesMetadata.length;c++)h.originalPost.filesMetadata[c].id==a.id&&h.originalPost.filesMetadata.splice(c,1)})})},h.updatePositionPost=function(){var b=null;h.mapId&&(b={url:a.urlMedia(h.mapId)}),d.showModalOpenMap(h.post,b)},h.getMedia=function(b){return a.urlMedia(b)},h.deletePost=function(){b.deletePost(h.scenario.id,h.post.id).then(function(a){h.deleted=!0,h.post={}},function(a){console.log("DELETE POST FAILED")})},h.updateStatus=function(){h.postDTO.id=h.post.id,h.postDTO.julianDayNumber=h.post.julianDayNumber,h.postDTO.timeNumber=h.post.timeNumber,h.postDTO.place=h.post.place;for(var c=new Array,e=0;e<h.newCharactersToTags.length;e++)c.push(h.newCharactersToTags[e].id);var f=new Array;if(h.post.tags)for(var e=0;e<h.post.tags.length;e++)f.push(h.post.tags[e].id);h.postDTO.tags=c,h.postDTO.tags=h.postDTO.tags.concat(f),b.updateStatus(h.scenario.id,h.post.id,h.postDTO).then(function(b){h.post=b,h.originalTagsList=angular.copy(h.post.tags),h.newCharactersToTags=[],h.switchEditPost(),h.recalculateMatrix(),h.post.character.cover=a.urlCharacterCover(h.scenario.id,h.post.character.id),h.originalPost=angular.copy(h.post),h.postDTO={},h.postDTO.text=h.post.text},function(a){console.log("UPDATE STATUS FAILED"),h.post.tags=angular.copy(h.originalTagsList),h.postDTO={},h.postDTO.text=h.post.text,h.newCharactersToTags=[],h.editPost=!h.editPost,d.showModalOldCharacterChangeOnComment(h.post.character.name)})},h.updateEvent=function(){h.postDTO.id=h.post.id,h.postDTO.julianDayNumber=h.post.julianDayNumber,h.postDTO.timeNumber=h.post.timeNumber,h.postDTO.place=h.post.place;for(var a=new Array,c=0;c<h.newCharactersToTags.length;c++)a.push(h.newCharactersToTags[c].id);var d=new Array;if(h.post.tags)for(var c=0;c<h.post.tags.length;c++)d.push(h.post.tags[c].id);h.postDTO.tags=a,h.postDTO.tags=h.postDTO.tags.concat(d),b.updateEvent(h.scenario.id,h.post.id,h.postDTO).then(function(a){h.post=a,h.originalTagsList=angular.copy(h.post.tags),h.newCharactersToTags=[],h.switchEditPost(),h.recalculateMatrix(),h.postDTO={},h.postDTO.text=h.post.text,h.originalPost=angular.copy(h.post)},function(a){console.log("UPDATE STATUS FAILED"),h.editPost=!h.editPost})},h.updateDate=function(){d.showModalSetHistoryDate(h.startDate,h.endDate,h.post)},h.removeTag=function(a){h.post.tags.splice(a,1)},h.search=function(b){var c=new Array;h.suggestions=new Array;for(var d=!1,f=0;f<h.scenario.characters.length;f++)if(d=!1,null!=h.post.tags){for(var g=0;g<h.post.tags.length;g++)if(h.scenario.characters[f].id==h.post.tags[g].id){d=!0;break}d||c.push(h.scenario.characters[f])}var i=new RegExp("(^|\\s|-|'|,|.)"+b,"gi");if(c){if(!h.scenario.id)throw new Error("Unsupported type");for(var f=0;f<c.length;f++)if(i.test(c[f].name)){var j={};j.name=c[f].name,j.id=c[f].id,j.cover=a.urlCharacterCover(h.scenario.id,c[f].id),h.suggestions.push(j)}}var k=e.defer();return k.resolve(h.suggestions),k.promise};var r=function(b,c){b&&b.length&&f.upload({url:a.urlMediaScenarioPost(h.scenario.id),headers:{"Content-Type":b.type},file:b}).then(function(a){if(c){var b={};b.id=a.data.id,b.name=a.config.file[0].name,h.post.imagesMetadata.push(b),h.recalculateMatrix(),h.postDTO.imageMetaId||(h.postDTO.imageMetaId=new Array),h.postDTO.imageMetaId.push(b.id)}else{var b={};b.id=a.data.id,b.originalName=a.config.file[0].name,h.post.filesMetadata.push(b),h.postDTO.fileMetaId||(h.postDTO.fileMetaId=new Array),h.postDTO.fileMetaId.push(b.id),q()}},function(a){console.log("Impossibile effettuare l'upload")})};h.setPositionPost=function(){var b=null;h.scenario.history.mapId&&(b={url:a.urlMedia(h.scenario.history.mapId)}),d.showModalOpenMap(h.post,b)}},controllerAs:"showNewsPost",bindToController:!0,link:function(a,b,c,e){a.$watch("showNewsPost.currentCharacter.id",function(a,b){a?a!=b&&(e.classCommentButton=""):e.classCommentButton="disabled-div"}),a.$watch("showNewsPost.post.imageMetadata.length",function(a){a>0&&(e.colorImageMarker={color:"#89b151"})}),a.$watch("showNewsPost.post.filesMetadata.length",function(a){a>0?e.colorFileMarker={color:"#89b151"}:e.colorFileMarker={color:"dark grey"}}),a.$watch("showNewsPost.post.place",function(a,b){a&&a.x&&a.y?e.colorMapMarker={color:"#89b151"}:e.colorMapMarker={color:"dark grey"}}),a.$watch("showNewsPost.post.tags.length",function(a){if(a>0){e.tagIsSet=!0,e.colorTagsMarker={color:"#89b151"},e.stringTags="";for(var b=0;a>b;b++){if(b>=2){e.stringTags+=" e altri personaggi";break}a-1>b?e.stringTags+=""+e.post.tags[b].name+", ":e.stringTags+=""+e.post.tags[b].name}}else e.colorTagsMarker={color:"dark grey"},e.stringTags="",e.tagIsSet=!1});var f=a.$on("notification.generateAlertUpd",function(a,b){e.editPost&&e.post.id==b.id&&d.showConcurrentModPost().then(function(a){},function(a){e.closeEditPost()})});a.$on("$destroy",function(){f()})}}}]),angular.module("smiled.application").directive("showOnHoverParent",function(){return{link:function(a,b,c){b.parent().bind("mouseenter",function(){b.show()}),b.parent().bind("mouseleave",function(){b.hide()})}}}),angular.module("smiled.application").directive("summarizeInfoPost",["CONSTANTS",function(a){return{templateUrl:"assets/private/partials/summarize-info-post-template.html",scope:{post:"=",currentCharacter:"=",showComment:"=",showMetaComment:"="},controller:function(){var b=this;b.likesLabel="",b.commentsLabel="",b.metaCommentsLabel="",b.switchShowComments=function(){b.showMetaComment=!1,b.showComment=!b.showComment},b.switchShowMetaComments=function(){b.showComment=!1,b.showMetaComment=!b.showMetaComment},b.tooltipLikes="";var c=0;for(b.l=a.lengthOfTooltipLikesList;c<b.l&&c<b.post.likes.length;)b.post.likes[c].id!=b.currentCharacter.id?b.tooltipLikes+=b.post.likes[c].name+"&#013":b.post.youLike=!0,c++;b.post.likes.length==b.l+1?b.tooltipLikes+="e ad un&#39altra persona":b.post.likes.length>b.l+1&&(b.tooltipLikes+="e ad altre"+(b.post.likes.length-c)+" persone")},controllerAs:"summarizeInfoPost",bindToController:!0,link:function(a,b,c,d){var e=function(){1!=d.post.likes.length||d.post.youLike?d.post.likes.length>1&&!d.post.youLike?d.likesLabel="Piace a <span class='tooltips clickable' title='"+d.tooltipLikes+"'>"+d.post.likes.length+" persone</span>":1==d.post.likes.length&&d.post.youLike?d.likesLabel="Ti piace":2==d.post.likes.length&&d.post.youLike?d.likesLabel="Piace a te e ad <span class='tooltips clickable' title='"+d.tooltipLikes+"'>un' altra persona</span>":d.post.likes.length>2&&d.post.youLike?d.likesLabel="Piace a te e ad <span class='tooltips clickable' title='"+d.tooltipLikes+"'>altre "+(d.post.likes.length-1)+" persone</span>":0==d.post.likes.length&&(d.likesLabel=""):d.likesLabel="Piace a <span class='tooltips clickable' title='"+d.tooltipLikes+"'>1 persona</span>"};a.$watch("summarizeInfoPost.post.likes.length",function(a){e()}),a.$watch("summarizeInfoPost.currentCharacter.id",function(a,b){var c=0;if(!a||a!=b){for(d.tooltipLikes="";c<d.l&&c<d.post.likes.length;)d.post.likes[c].id!=a?(d.post.youLike=!1,d.tooltipLikes+=d.post.likes[c].name+"&#013"):d.post.youLike=!0,c++;e()}}),a.$watch("summarizeInfoPost.post.comments.length",function(a){1==d.post.comments.length?d.commentsLabel="1 commento":d.post.comments.length>1&&(d.commentsLabel=d.post.comments.length+" commenti")}),a.$watch("summarizeInfoPost.post.metaComments.length",function(a){1==d.post.metaComments.length?d.metaCommentsLabel="1 suggerimento":d.post.metaComments.length>1&&(d.metaCommentsLabel=d.post.metaComments.length+" suggerimenti")})}}}]),angular.module("smiled.application").directive("myTagBox",["CONSTANTS","$document",function(a,b){return{restrict:"EA",templateUrl:"assets/private/partials/tag-box-template.html",scope:{selectedTags:"=tags",selectable:"=",type:"@",scenarioId:"@?scenario"},controller:function(){var b=this;b.selectedIndex=-1,b.suggestions=new Array,b.searchText="",b.showSuggestions=!0,b.search=function(){b.suggestions=[],b.selectedIndex=-1;var c=new RegExp("(^|\\s|-|'|,|.)"+b.searchText,"gi");if(b.selectable)if("user"==b.type){for(var d=0;d<b.selectable.length;d++)if(c.test(b.selectable[d].firstname)||c.test(b.selectable[d].lastname)){var e={};e.name=b.selectable[d].lastname+" "+b.selectable[d].firstname,e.id=b.selectable[d].id,e.cover=a.urlUserCover(b.selectable[d].id),b.suggestions.push(e)}}else{if("character"!=b.type)throw new Error("Unsupported type");if(!b.scenarioId)throw new Error("Unsupported type");for(var d=0;d<b.selectable.length;d++)if(c.test(b.selectable[d].name)){var e={};e.name=b.selectable[d].name,e.id=b.selectable[d].id,e.cover=a.urlCharacterCover(b.scenarioId,b.selectable[d].id),b.suggestions.push(e)}}},b.removeTag=function(a){b.selectedTags.splice(a,1)},b.addToSelectedTags=function(a){-1===b.selectedTags.indexOf(b.suggestions[a])&&(b.selectedTags.push(b.suggestions[a]),b.searchText="",b.suggestions=[])},b.checkKeyDown=function(a){40===a.keyCode?(a.preventDefault(),b.selectedIndex+1!==b.suggestions.length?b.selectedIndex++:b.selectedIndex=0):38===a.keyCode?(a.preventDefault(),b.selectedIndex-1!==-1?b.selectedIndex--:b.selectedIndex=b.suggestions.length-1):13===a.keyCode&&b.addToSelectedTags(b.selectedIndex)}},controllerAs:"tagBox",bindToController:!0,link:function(a,b,c,d){a.$watch("tagBox.selectedIndex",function(a){-1!==a&&(d.searchText=d.suggestions[d.selectedIndex].name)}),b.on("focusout",function(b){d.showSuggestions=!1,a.$apply()}),b.on("focusin",function(b){d.search(),d.showSuggestions=!0,a.$apply()})}}}]),angular.module("smiled.application").directive("updatePostOnScrool",["$window",function(a){return{scope:{stop:"&",start:"&"},controller:function(a){var b=this;b.control=function(){this.pageYOffset<=150?b.start():b.stop()}},controllerAs:"updatePostOnScrollCtrl",bindToController:!0,link:function(b,c,d,e){angular.element(a).on("scroll",e.control),b.$on("$destroy",function(){console.log("LOCATION CHANGE"),e.stop(),angular.element(a).off("scroll",e.control)})}}}]),angular.module("smiled.application").directive("userCard",["CONSTANTS","userService",function(a,b){return{templateUrl:"assets/private/partials/user-card.html",scope:{userid:"@"},controller:function(){var c=this;c.user=null,c.profilePicture=null,c.userCover=null,c.ruolo=null,c.numScen=0,b.getUser(c.userid).then(function(b){c.user=b,c.profilePicture=a.urlUserCover(c.userid),c.userCover=a.urlUserCoverLarge(c.userid);var d=c.user.role;"ROLE_TEACHER"==d.authority?c.ruolo="DOCENTE":c.ruolo="STUDENTE",null!=c.user.creatingScenarios&&(c.numScen+=c.user.creatingScenarios.length),null!=c.user.openScenarios&&(c.numScen+=c.user.openScenarios.length),null!=c.user.closedScenarios&&(c.numScen+=c.user.closedScenarios.length)},function(a){console.log(a)})},controllerAs:"userCard",bindToController:!0,link:function(a,b,c,d){}}}]),angular.module("smiled.application").directive("workSpinner",["requestCounter",function(a){return{restrict:"EA",transclude:!0,scope:{},template:"<ng-transclude ng-show='requestCount'></ng-transclude>",link:function(b){b.$watch(function(){return a.getRequestCount()},function(a){b.requestCount=a})}}}]),angular.module("smiled.application").config(["$provide",function(a){a.decorator("$exceptionHandler",["$delegate","$injector",function(a,b){return function(c,d){console.log("I'M ON EXCEPTION HANDLER"),console.log("EXCEPTION: "+c+", cause: "+d);var e=b.get("$rootScope");a(c,d),e.logAngularError(c,d)}}])}]).run(["$http","$rootScope",function(a,b){b.logAngularError=function(b,c){var d={};d.exceptionMessage=b.message,d.cause=c,a.post("/api/v1/clientException",d).success(function(a){console.log(JSON.stringify(a))})}}]),angular.module("smiled.application").factory("requestCounter",["$q",function(a){var b=0,c=function(c){return b+=1,a.when(c)},d=function(c){return b-=1,a.reject(c)},e=function(c){return b-=1,a.when(c)},f=function(c){return b-=1,a.reject(c)},g=function(){return b};return{request:c,response:e,requestError:d,responseError:f,getRequestCount:g}}]).config(["$httpProvider",function(a){a.interceptors.push("requestCounter")}]),angular.module("smiled.application").run(["$rootScope",function(a){a.$on("$stateChangeError",function(a,b,c,d,e,f){console.log("impossibile caricare lo stato "+b.name)})}]);